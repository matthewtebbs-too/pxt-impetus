var pxt,ts,__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(S){S.simshim=function(e,t){for(var r,h=ts.SyntaxKind,g=e.getTypeChecker(),b=S.cpp.nsWriter("declare namespace"),v="",n=0,a=e.getSourceFiles();n<a.length;n++){var i=a[n];if(t){var s=t(i.fileName);if(S.debug("SimShim[1]: "+s.dir),!S.U.endsWith(s.dir,"/sim")&&!S.U.startsWith(i.fileName,"sim/"))continue}else if(!S.U.startsWith(i.fileName,"sim/"))continue;S.debug("SimShim[2]: "+i.fileName);for(var o=0,l=i.statements;o<l.length;o++){var u=l[o],c=u;u.kind==h.ModuleDeclaration&&"pxsim"==c.name.text&&m((r=c).body)}}var p={};return p[S.appTarget.corepkg]=b.finish(),p;function k(e){var t;return ts.isExpression(e)&&(t=g.getContextualType(e)),t||(t=g.getTypeAtLocation(e)),t}function y(e){var t=g.typeToString(e,r,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t=t.replace(/^pxsim\./,"")){case"RefAction":return"() => void";case"RefBuffer":return"Buffer";default:return t}}function d(r){var e=x(r);if(e){b.setNs(v),b.write(e);var t=v;v&&(v+="."),v+=r.name.text;var n=t?"":"declare",a="";if(r.heritageClauses)for(var i=0,s=r.heritageClauses;i<s.length;i++){var o=s[i];o.token==h.ExtendsKeyword&&(a=" extends "+y(k(o.types[0])))}b.write(n+" class "+r.name.text+a+" {"),b.incrIndent();for(var l=function(t){switch(t.kind){case h.MethodDeclaration:f(t);break;case h.PropertyDeclaration:!function(e){var t=x(e);if(t){var r=e.name.getText(),n="//% shim=."+r,a=g.getTypeAtLocation(e);b.write(t),b.write(n),b.write("public "+r+": "+y(a)+";"),b.write("")}}(t);break;case h.Constructor:!function(e){var t=x(e);if(t){g.getTypeAtLocation(e);var r=e.parameters.map(function(e){return e.name.getText()+": "+y(k(e))});b.write(t),b.write('//% shim="new '+v+'"'),b.write("constructor("+r.join(", ")+");"),b.write("")}}(t);break;case h.GetAccessor:var e=r.members.some(function(e){return e.kind==h.SetAccessor&&e.name.getText()==t.name.getText()});f(t,e)}},u=0,c=r.members;u<c.length;u++)l(c[u]);v=t,b.decrIndent(),b.write("}")}}function x(e){var t=pxtc.getComments(e);return/^\s*\/\/%/m.test(t)?t:null}function f(e,t){void 0===t&&(t=!1);var r=x(e);if(r){var n,a=e.name.getText(),i=e.kind==h.MethodDeclaration||e.kind==h.GetAccessor||e.kind==h.SetAccessor,s="//% shim="+(i?"."+a:v+"::"+a),o=g.getSignatureFromDeclaration(e),l=g.getReturnTypeOfSignature(o),u=/Async$/.test(a),c=(n=l,pxtc.isObjectType(n)&&n.objectFlags&ts.ObjectFlags.Reference&&"Promise"==n.symbol.name?n.typeArguments[0]:null);c?(s+=" promise",l=c,u||S.U.userError(v+"::"+a+" should be called "+a+"Async")):u&&S.U.userError(v+"::"+a+" doesn't return a promise"),S.debug("emitFun: "+a);var p=e.parameters.map(function(e){return e.name.getText()+(e.questionToken?"?":"")+": "+y(k(e))}),d=a.replace(/Async$/,""),f=i?"public":"function",m="("+p.join(", ")+")";e.kind==h.GetAccessor&&(f=t?"public":"readonly",m="",s+=" property"),i||b.setNs(v),b.write(r),b.write(s),b.write(f+" "+d+m+": "+y(l)+";"),b.write("")}}function m(e){switch(e.kind){case h.ModuleDeclaration:return(r=v)&&(v+="."),v+=(t=e).name.text,m(t.body),void(v=r);case h.ModuleBlock:return e.statements.forEach(m);case h.FunctionDeclaration:return f(e);case h.ClassDeclaration:return d(e)}var t,r}}}(pxt||(pxt={})),function(e){var a,t,r;a=e.pxtc||(e.pxtc={}),t=a.avr||(a.avr={}),r=function(e){function t(){var r=e.call(this)||this;return r.addEnc("$r0","R0-31",function(e){return r.inrange(31,e,e<<4)}),r.addEnc("$r1","R0-31",function(e){return r.inrange(31,e,15&e|(16&e)<<5)}),r.addEnc("$r2","R0-4",function(e){var t=r.inseq([24,26,28,30],e);return null==t?null:t<<4}),r.addEnc("$r3","R0-16-31",function(e){return r.inminmax(16,31,e,e-16<<4)}),r.addEnc("$r4","R0-7",function(e){return r.inrange(7,e,e<<4)}),r.addEnc("$r6","R0-31",function(e){return r.inrange(31,e,e<<4|15&e|(16&e)<<5)}),r.addEnc("$r7","R0-31",function(e){return r.inrange(31,e,e<<3)}),r.addEnc("$r8","Reven",function(e){return 1&e?null:e>>1<<4}),r.addEnc("$r9","Reven",function(e){return 1&e?null:e>>1}),r.addEnc("$r10","R0-16-23",function(e){return r.inminmax(16,23,e,e-16<<4)}),r.addEnc("$r11","R0-16-23",function(e){return r.inminmax(16,23,e,e-16)}),r.addEnc("$r12","R0-16-31",function(e){return r.inminmax(16,31,e,e-16)}),r.addEnc("$i0","#0-63",function(e){return r.inrange(63,e,15&e|(48&e)<<2)}),r.addEnc("$i1","#0-255",function(e){return r.inrange(255,e,15&e|(240&e)<<4)}),r.addEnc("$i2","#0-127",function(e){return r.inrange(127,e,e<<3)}),r.addEnc("$i3","#0-255",function(e){return r.inrange(255,e,15&~e|(240&~e)<<4)}),r.addEnc("$i4","#0-15",function(e){return r.inrange(15,e,e<<4)}),r.addEnc("$i5","#0-63",function(e){return r.inrange(63,e,15&e|(48&e)<<5)}),r.addEnc("$i6","#0-127",function(e){return r.inrange(127,e,15&e|(112&e)<<4)}),r.addEnc("$i7","#0-4095",function(e){return r.inrange(4095,e,e)}),r.addEnc("$i8","#0-63",function(e){return r.inrange(63,e,7&e|(24&e)<<7)|(32&e)<<7}),r.addEnc("$i9","#0-7",function(e){return r.inrange(7,e,e)}),r.addEnc("$la","LABEL",function(e){return r.inrange(65535,e,e)}),r.addEnc("$lb","LABEL",function(e){return r.inrangeSigned(127,e>>1,e>>1)<<3}),r.addEnc("$lc","LABEL",function(e){return r.inrange(65535,e>>1,e>>1)}),r.addEnc("$ld","LABEL",function(e){return r.inrangeSigned(2047,e>>1,e>>1)}),r.addInst("adc   $r0, $r1",7168,64512),r.addInst("add   $r0, $r1",3072,64512),r.addInst("adiw  $r2, $i0",38400,65280),r.addInst("and   $r0, $r1",8192,64512),r.addInst("andi  $r3, $i1",28672,61440),r.addInst("asr   $r0",37893,65039),r.addInst("bclr  $r4",38024,65423),r.addInst("bld   $r0, $i9",63488,65032),r.addInst("brbc  $i9, $lb",62464,64512),r.addInst("brbs  $i9, $lb",61440,64512),r.addInst("brcc  $lb",62464,64519),r.addInst("brcs  $lb",61440,64519),r.addInst("break",38296,65535),r.addInst("breq  $lb",61441,64519),r.addInst("brge  $lb",62468,64519),r.addInst("brhc  $lb",62469,64519),r.addInst("brhs  $lb",61445,64519),r.addInst("brid  $lb",62471,64519),r.addInst("brie  $lb",61447,64519),r.addInst("brlo  $lb",61440,64519),r.addInst("brlt  $lb",61444,64519),r.addInst("brmi  $lb",61442,64519),r.addInst("brne  $lb",62465,64519),r.addInst("brpl  $lb",62466,64519),r.addInst("brsh  $lb",62464,64519),r.addInst("brtc  $lb",62470,64519),r.addInst("brts  $lb",61446,64519),r.addInst("brvc  $lb",62467,64519),r.addInst("brvs  $lb",61443,64519),r.addInst("bset  $r4",37896,65423),r.addInst("bst   $r0, $i9",64e3,65032),r.addInst("call  $lc",37902,65535,!0),r.addInst("cbi   $r7, $i9",38912,65280),r.addInst("cbr   $r3, $i3",28672,61440),r.addInst("clc",38024,65535),r.addInst("clh",38104,65535),r.addInst("cli",38136,65535),r.addInst("cln",38056,65535),r.addInst("clr $r6",9216,64512),r.addInst("cls",38088,65535),r.addInst("clt",38120,65535),r.addInst("clv",38072,65535),r.addInst("clz",38040,65535),r.addInst("com   $r0",37888,65039),r.addInst("cp    $r0, $r1",5120,64512),r.addInst("cpc   $r0, $r1",1024,64512),r.addInst("cpi   $r3, $i1",12288,61440),r.addInst("cpse  $r0, $r1",4096,64512),r.addInst("dec   $r0",37898,65039),r.addInst("des   $i4",37899,65295),r.addInst("eicall",38169,65535),r.addInst("eijmp",37913,65535),r.addInst("elpm",38360,65535),r.addInst("elpm  $r0, Z0",36870,65039),r.addInst("elpm  $r0, Z+0",36871,65039),r.addInst("eor   $r0, $r1",9216,64512),r.addInst("fmul   $r10, $r11",776,65416),r.addInst("fmuls  $r10, $r11",896,65416),r.addInst("fmulsu $r10, $r11",904,65416),r.addInst("icall",38153,65535),r.addInst("ijmp",37897,65535),r.addInst("in    $r0, $i5",45056,63488),r.addInst("inc   $r0",37891,65039),r.addInst("jmp  $lc",37900,65535,!0),r.addInst("lac   Z, $r0",37382,65039),r.addInst("las   Z, $r0",37381,65039),r.addInst("lat   Z, $r0",37383,65039),r.addInst("ld    $r0, X",36876,65039),r.addInst("ld    $r0, X+",36877,65039),r.addInst("ld    $r0, -X",36878,65039),r.addInst("ld    $r0, Y",32776,65039),r.addInst("ld    $r0, Y+",36873,65039),r.addInst("ld    $r0, -Y",36874,65039),r.addInst("ldd   $r0, Y, $i8",32776,53768),r.addInst("ld    $r0, Z",32768,65039),r.addInst("ld    $r0, Z+",36865,65039),r.addInst("ld    $r0, -Z",36866,65039),r.addInst("ldd   $r0, Z, $i8",32768,53768),r.addInst("ldi   $r3, $i1",57344,61440),r.addInst("lds   $r0, $la",36864,65039,!0),r.addInst("lds   $r3, $i6",40960,63488),r.addInst("lpm",38312,65535),r.addInst("lpm   $r0, Z",36868,65039),r.addInst("lpm   $r0, Z+",36869,65039),r.addInst("lsl   $r6",3072,64512),r.addInst("lsr   $r0",37894,65039),r.addInst("mov   $r0, $r1",11264,64512),r.addInst("movw  $r8, $r9",256,65280),r.addInst("mul   $r0, $r1",39936,64512),r.addInst("muls  $r3, $r12",512,65280),r.addInst("mulsu $r10, $r11",768,65416),r.addInst("neg $r0",37889,65039),r.addInst("nop",0,65535),r.addInst("or    $r0, $r1",10240,64512),r.addInst("ori   $r3, $i1",24576,61440),r.addInst("out   $i5, $r0",47104,63488),r.addInst("pop $r0",36879,65039),r.addInst("push $r0",37391,65039),r.addInst("rcall $ld",53248,61440),r.addInst("ret",38152,65535),r.addInst("reti",38168,65535),r.addInst("rjmp $ld",49152,61440),r.addInst("rol $r6",7168,64512),r.addInst("ror $r0",37895,65039),r.addInst("sbc   $r0, $r1",2048,64512),r.addInst("sbci  $r3, $i1",16384,61440),r.addInst("sbi   $r7, $i9",39424,65280),r.addInst("sbic  $r7, $i9",39168,65280),r.addInst("sbis  $r7, $i9",39680,65280),r.addInst("sbiw  $r2, $i0",38656,65280),r.addInst("sbr   $r3, $i1",24576,61440),r.addInst("sbrc  $r0, $i9",64512,65032),r.addInst("sbrs  $r0, $i9",65024,65032),r.addInst("sec",37896,65535),r.addInst("seh",37976,65535),r.addInst("sei",38008,65535),r.addInst("sen",37928,65535),r.addInst("sec",37896,65535),r.addInst("ser $r3",61199,65295),r.addInst("ses",37960,65535),r.addInst("set",37992,65535),r.addInst("sev",37944,65535),r.addInst("sez",37912,65535),r.addInst("sleep",38280,65535),r.addInst("spm",38376,65535),r.addInst("st    X, $r0",37388,65039),r.addInst("st    X+, $r0",37389,65039),r.addInst("st    -X, $r0",37390,65039),r.addInst("st    Y, $r0",33288,65039),r.addInst("st    Y+, $r0",37385,65039),r.addInst("st    -Y, $r0",37386,65039),r.addInst("std   Y, $i8, $r0",33288,53768),r.addInst("st    Z, $r0",33280,65039),r.addInst("st    Z+, $r0",37377,65039),r.addInst("st    -Z, $r0",37378,65039),r.addInst("std   Z, $i8, $r0",33280,53768),r.addInst("sts   $la, $r0",37376,65039,!0),r.addInst("sts   $i6, $r3",43008,63488),r.addInst("sub   $r0, $r1",6144,64512),r.addInst("subi  $r3, $i1",20480,61440),r.addInst("swap  $r0",37890,65039),r.addInst("tst   $r6",8192,64512),r.addInst("wdr",38312,65535),r.addInst("xch   Z, $r0",37380,65039),r}return __extends(t,e),t.prototype.wordSize=function(){return 2},t.prototype.computeStackOffset=function(e,t){return"args"==e?t+2:t+1},t.prototype.is32bit=function(e){return e.is32bit},t.prototype.emit32=function(e,t,r){var n=t>>1;return a.assert(null!=n,"off null"),(0|n)==n&&-65536<=n&&n<=65536?{opcode:e,opcode2:65535&n,stack:0,numArgs:[t],labelName:r}:a.assembler.emitErr("jump out of range",r)},t.prototype.registerNo=function(e){if(!e)return null;e=e.toLowerCase();var t=/^r(\d+)$/.exec(e);if(t){var r=parseInt(t[1],10);if(0<=r&&r<32)return r}return null},t.prototype.postProcessRelAddress=function(e,t){return t+e.baseOffset},t.prototype.postProcessAbsAddress=function(e,t){return t<<1},t.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var a=e.lookupLabel(r);return null==a?null:t.is32bit?a:a-(e.pc()+2)},t.prototype.peephole=function(e,t,r){},t.prototype.toFnPtr=function(e,t){return e>>1},t.prototype.testAssembler=function(){a.assembler.expect(this,"2411       eor\tr1, r1 \nbe1f       out\t0x3f, r1 \nefcf       ldi\tr28, 0xFF \ne0da       ldi\tr29, 0x0A \nbfde       out\t0x3e, r29 \nbfcd      \tout\t0x3d, r28 \n"),a.assembler.expect(this,"0c00      lsl     r0\n920f      push    r0\ne604      ldi     r16, #100        ; 0x64\n903f      pop     r3\n"),a.assembler.expect(this,"1412      cp      r1, r2\nf409      brne    l6\nc001      rjmp    l8\n0e01  l6: add     r0, r17\n0000  l8: nop     \n")},t}(a.assembler.AbstractProcessor),t.AVRProcessor=r}(ts||(ts={})),function(b){!function(x){function r(e){for(var t='"',r=0;r<e.length;++r){var n=255&e.charCodeAt(r),a=String.fromCharCode(n);t+="\\"==a||'"'==a?"\\"+a:"\n"==a?"\\n":n<=15?"\\x0"+n.toString(16):n<32||127<n?"\\x"+n.toString(16):a}return t+'"'}x.asmStringLiteral=r;var e=function(){function e(){}return e.prototype.hasCommonalize=function(){return!1},e.prototype.nop=function(){return"TBD(nop)"},e.prototype.reg_gets_imm=function(e,t){return"TBD(reg_gets_imm)"},e.prototype.proc_setup=function(e,t){return"TBD(proc_setup)"},e.prototype.push_fixed=function(e){return"TBD(push_fixed)"},e.prototype.push_local=function(e){return"TBD(push_local)"},e.prototype.push_locals=function(e){return"TBD(push_locals)"},e.prototype.pop_fixed=function(e){return"TBD(pop_fixed)"},e.prototype.pop_locals=function(e){return"TBD(pop_locals)"},e.prototype.proc_return=function(){return"TBD(proc_return)"},e.prototype.debugger_stmt=function(e){return""},e.prototype.debugger_bkpt=function(e){return""},e.prototype.debugger_proc=function(e){return""},e.prototype.unconditional_branch=function(e){return"TBD(unconditional_branch)"},e.prototype.beq=function(e){return"TBD(beq)"},e.prototype.bne=function(e){return"TBD(bne)"},e.prototype.cmp=function(e,t){return"TBD(cmp)"},e.prototype.cmp_zero=function(e){return"TBD(cmp_zero)"},e.prototype.arithmetic=function(){return""},e.prototype.load_reg_src_off=function(e,t,r,n,a,i){return"TBD(load_reg_src_off)"},e.prototype.rt_call=function(e,t,r){return"TBD(rt_call)"},e.prototype.call_lbl=function(e){return"TBD(call_lbl)"},e.prototype.call_reg=function(e){return"TBD(call_reg)"},e.prototype.vcall=function(e,t,r){return"TBD(vcall)"},e.prototype.prologue_vtable=function(e,t){return"TBD(prologue_vtable"},e.prototype.helper_prologue=function(){return"TBD(lambda_prologue)"},e.prototype.helper_epilogue=function(){return"TBD(lambda_epilogue)"},e.prototype.load_ptr=function(e,t){return"TBD(load_ptr)"},e.prototype.load_ptr_full=function(e,t){return"TBD(load_ptr_full)"},e.prototype.emit_int=function(e,t){return"TBD(emit_int)"},e.prototype.string_literal=function(e,t){return"\n.balign 4\n"+e+"meta: .short 0xffff, "+(x.target.taggedInts?pxt.REF_TAG_STRING+",":"")+" "+t.length+"\n"+e+": .string "+r(t)+"\n"},e.prototype.hex_literal=function(e,t){return"\n.balign 4\n"+e+": .short 0xffff, "+(x.target.taggedInts?pxt.REF_TAG_BUFFER+",":"")+" "+(t.length>>1)+(x.target.taggedInts?", 0x0000":"")+"\n        .hex "+t+(t.length%4==0?"":"00")+"\n"},e.prototype.method_call=function(e,t){return""},e}();x.AssemblerSnippets=e,x.numBytes=function(e){for(var t=0,r=e;0<r;r>>>=8)t++;return t||1};var t=function(){function e(e,t,r){var n=this;this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.write=function(e){n.resText+=x.asmline(e)},this.t=e,this.bin=t,this.proc=r,this.work()}return e.prototype.stackSize=function(){return this.baseStackSize+this.exprStack.length},e.prototype.stackAlignmentNeeded=function(e){if(void 0===e&&(e=0),!x.target.stackAlign)return 0;var t=x.target.stackAlign-(this.stackSize()+e&x.target.stackAlign-1);return t==x.target.stackAlign?0:t},e.prototype.alignStack=function(e){void 0===e&&(e=0);var t=this.stackAlignmentNeeded(e);return t?(this.write(this.t.push_locals(t)),this.t.pop_locals(t)):""},e.prototype.getAssembly=function(){return this.resText},e.prototype.work=function(){var l=this,e=this.proc.getName();if(x.assembler.debug&&this.proc.action){var t=b.pxtc.nodeLocationInfo(this.proc.action);e+=" "+t.fileName+":"+(t.line+1)}this.write("\n;\n; Function "+e+"\n;\n"),this.proc.args.length<=3&&this.emitLambdaWrapper(this.proc.isRoot);var r=this.proc.label(),u=r+"_bkpt",c=r+"_locals",p=r+"_end";this.write(".section code"),this.write("\n"+r+":\n    @stackmark func\n    @stackmark args\n"),this.proc.fillDebugInfo=function(e){var t=e.getLabels();l.proc.debugInfo={locals:(1==l.proc.seqNo?l.bin.globals:l.proc.locals).map(function(e){return e.getDebugInfo()}),args:l.proc.args.map(function(e){return e.getDebugInfo()}),name:l.proc.getName(),codeStartLoc:x.U.lookup(t,c),codeEndLoc:x.U.lookup(t,p),bkptLoc:x.U.lookup(t,u),localsMark:x.U.lookup(e.stackAtLabel,c),idx:l.proc.seqNo,calls:l.calls};for(var r=0,n=l.calls;r<n.length;r++){var a=n[r];a.addr=x.U.lookup(t,a.callLabel),a.stack=x.U.lookup(e.stackAtLabel,a.callLabel),a.callLabel=void 0}for(var i=0;i<l.proc.body.length;++i){var s=l.proc.body[i].breakpointInfo;if(s){var o=x.U.lookup(e.stackAtLabel,"__brkp_"+s.id);o!==l.proc.debugInfo.localsMark&&(console.log(s),console.log(e.stackAtLabel),x.U.oops("offset doesn't match: "+o+" != "+l.proc.debugInfo.localsMark))}}},this.bin.options.breakpoints&&this.write(this.t.debugger_proc(u)),this.baseStackSize=1;var n=this.proc.locals.length;this.write(this.t.proc_setup(n)),this.baseStackSize+=n,this.write("@stackmark locals"),this.write(c+":"),this.proc.resolve();for(var a=0;a<this.proc.body.length;++a){var i=this.proc.body[a];switch(i.stmtKind){case x.ir.SK.Expr:this.emitExpr(i.expr);break;case x.ir.SK.StackEmpty:if(0<this.exprStack.length){for(var s=0,o=this.proc.body.slice(a-4,a+1);s<o.length;s++){var d=o[s];console.log("PREVSTMT "+d.toString().trim())}for(var f=0,m=this.exprStack;f<m.length;f++){var h=m[f];console.log("EXPRSTACK "+h.currUses+"/"+h.totalUses+" E: "+h.toString())}x.oops("stack should be empty")}this.write("@stackempty locals");break;case x.ir.SK.Jmp:this.emitJmp(i);break;case x.ir.SK.Label:this.write(i.lblName+":");break;case x.ir.SK.Breakpoint:if(this.bin.options.breakpoints){var g="__brkp_"+i.breakpointInfo.id;i.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(g)):this.write(this.t.debugger_bkpt(g))}break;default:x.oops()}}x.assert(0<=n&&n<127),0<n&&this.write(this.t.pop_locals(n)),this.write(p+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args")},e.prototype.mkLbl=function(e){var t=e+this.bin.lblNo++;return"_"!=t[0]&&(t="."+t),t},e.prototype.terminate=function(e){x.assert(e.exprKind==x.ir.EK.SharedRef);var t=e.args[0];if(t.currUses!=t.totalUses){for(var r=0;r<this.exprStack.length;){var n=this.exprStack[r];if(n!=t&&n.currUses!=n.totalUses)break;r++}x.assert(0<r),this.write("@dummystack "+r),this.write(this.t.pop_locals(r))}},e.prototype.emitJmp=function(e){if(e.jmpMode==x.ir.JmpMode.Always)e.expr&&this.emitExpr(e.expr),e.terminateExpr&&this.terminate(e.terminateExpr),this.write(this.t.unconditional_branch(e.lblName)+" ; with expression");else{var t=this.mkLbl("jmpz");e.jmpMode==x.ir.JmpMode.IfJmpValEq?(this.emitExprInto(e.expr,"r1"),this.write(this.t.cmp("r0","r1"))):(this.emitExpr(e.expr),(e.expr.exprKind!=x.ir.EK.RuntimeCall||"thumb::subs"!==e.expr.data&&!x.U.startsWith(e.expr.data,"_cmp_"))&&this.write(this.t.cmp_zero("r0"))),e.jmpMode==x.ir.JmpMode.IfNotZero?this.write(this.t.beq(t)):this.write(this.t.bne(t)),e.terminateExpr&&this.terminate(e.terminateExpr),this.write(this.t.unconditional_branch(e.lblName)),this.write(t+":")}},e.prototype.clearStack=function(){for(var e=0;0<this.exprStack.length&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)e++,this.exprStack.shift();e&&this.write(this.t.pop_locals(e))},e.prototype.withRef=function(e,t){return e+(t?"Ref":"")},e.prototype.emitExprInto=function(e,t){switch(e.exprKind){case x.ir.EK.NumberLiteral:!0===e.data?this.write(this.t.emit_int(1,t)):!1===e.data?this.write(this.t.emit_int(0,t)):null===e.data?this.write(this.t.emit_int(0,t)):"number"==typeof e.data?this.write(this.t.emit_int(e.data,t)):x.oops();break;case x.ir.EK.PointerLiteral:e.args?this.write(this.t.load_ptr_full(e.data,t)):this.write(this.t.load_ptr(e.data,t));break;case x.ir.EK.SharedRef:var r=e.args[0];x.U.assert(!!r.currUses),x.U.assert(r.currUses<r.totalUses),r.currUses++;var n=this.exprStack.indexOf(r);if(x.U.assert(0<=n),0==n&&r.totalUses==r.currUses)this.write(this.t.pop_fixed([t])+" ; tmpref @"+this.exprStack.length),this.exprStack.shift(),this.clearStack();else{var a=n.toString()+":"+this.exprStack.length;this.write(this.t.load_reg_src_off(t,"sp",a,!0)+" ; tmpref @"+(this.exprStack.length-n))}break;case x.ir.EK.CellRef:var i=e.data;if(i.isGlobal()){var s=this.bitSizeInfo(i.bitSize),o="#"+i.index;(s.needsSignExt||i.index>=s.immLimit)&&(this.write(this.t.emit_int(i.index,t)),o=t),this.write(this.t.load_reg_src_off(t,"r6",o,!1,!1,s))}else{var l=this.cellref(i),u=l[0],c=l[1],p=l[2];this.write(this.t.load_reg_src_off(t,u,c,p))}break;default:x.oops()}},e.prototype.bitSizeInfo=function(e){var t={size:x.sizeOfBitSize(e),immLimit:128};return 1==t.size?t.immLimit=32:2==t.size&&(t.immLimit=64),1!=e&&3!=e||(t.needsSignExt=!0),t},e.prototype.emitExpr=function(e){var t=this;switch(e.exprKind){case x.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case x.ir.EK.Nop:this.write(this.t.nop());break;case x.ir.EK.Incr:this.emitExpr(e.args[0]),this.emitCallRaw("pxt::incr");break;case x.ir.EK.Decr:this.emitExpr(e.args[0]),this.emitCallRaw("pxt::decr");break;case x.ir.EK.FieldAccess:var r=e.data;return this.emitExpr(x.ir.rtcall(this.withRef("pxtrt::ldfld",r.isRef),[e.args[0],x.ir.numlit(r.idx)]));case x.ir.EK.Store:return this.emitStore(e.args[0],e.args[1]);case x.ir.EK.RuntimeCall:return this.emitRtCall(e);case x.ir.EK.ProcCall:return this.emitProcCall(e);case x.ir.EK.SharedDef:return this.emitSharedDef(e);case x.ir.EK.Sequence:return e.args.forEach(function(e){return t.emitExpr(e)}),this.clearStack();default:return this.emitExprInto(e,"r0")}},e.prototype.emitSharedDef=function(e){var t=e.args[0];if(x.U.assert(1<=t.totalUses),x.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return this.emitExpr(t);this.emitExpr(t),this.exprStack.unshift(t),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)},e.prototype.emitSharedTerminate=function(e){this.emitExpr(e);e.data},e.prototype.emitRtCall=function(e){var r=this,t=x.ir.flattenArgs(e);t.precomp.forEach(function(e){return r.emitExpr(e)}),t.flattened.forEach(function(e,t){x.U.assert(t<=3),r.emitExprInto(e,"r"+t)}),this.clearStack();var n=e.data;"langsupp::ignore"!=n&&(x.U.startsWith(n,"thumb::")?this.write(this.t.rt_call(n.slice(7),"r0","r1")):this.alignedCall(n))},e.prototype.alignedCall=function(e,t){void 0===t&&(t="");var r=this.alignStack();this.write(this.t.call_lbl(e)+t),this.write(r)},e.prototype.emitHelper=function(e){if(!this.bin.codeHelpers[e]){var t=Object.keys(this.bin.codeHelpers).length;this.bin.codeHelpers[e]="_hlp_"+t}this.write(this.t.call_lbl(this.bin.codeHelpers[e]))},e.prototype.emitProcCall=function(e){var r=this,n=0,a=!1,t=e.args.map(function(e,t){return r.emitExpr(e),r.write(r.t.push_local("r0")+" ; proc-arg"),e.totalUses=1,e.currUses=0,r.exprStack.unshift(e),0==t&&(n=r.exprStack.length),r.exprStack.length-n!=t&&(a=!0),e});if(this.stackAlignmentNeeded()&&(a=!0),a){var i=this.stackAlignmentNeeded(t.length);if(i){this.write(this.t.push_locals(i));for(var s=0;s<i;++s){var o=x.ir.numlit(0);o.totalUses=1,o.currUses=1,this.exprStack.unshift(o)}}for(var l=0,u=t;l<u.length;l++){var c=u[l],p=this.exprStack.indexOf(c);x.assert(0<=p),this.write(this.t.load_reg_src_off("r0","sp",p.toString(),!0)+" ; repush"),this.write(this.t.push_local("r0")+" ; repush"),this.exprStack.unshift(c)}}var d=this.mkLbl("_proccall"),f=e.data,m=-1;if(null!=f.virtualIndex||null!=f.ifaceIndex){var h=this.t.method_call(f,e);if(h)this.write(h),this.write(d+":");else if(f.mapMethod){var g=/Set/.test(f.mapMethod);x.assert(g==(2==e.args.length)),x.assert(!g==(1==e.args.length)),this.write(this.t.emit_int(f.mapIdx,"r1")),g&&this.write(this.t.emit_int(f.ifaceIndex,"r2")),this.emitHelper(this.t.vcall(f.mapMethod,g,this.bin.options.target.vtableShift)),this.write(d+":")}else{this.write(this.t.prologue_vtable(e.args.length-1,this.bin.options.target.vtableShift));var b=f.virtualIndex+4;null!=f.ifaceIndex&&(this.write(this.t.load_reg_src_off("r0","r0","#4")+" ; iface table"),b=f.ifaceIndex),b<=31?this.write(this.t.load_reg_src_off("r0","r0",b.toString(),!0)+" ; ld-method"):(this.write(this.t.emit_int(4*b,"r1")),this.write(this.t.load_reg_src_off("r0","r0","r1")+" ; ld-method")),this.write(this.t.call_reg("r0")),this.write(d+":")}}else{var v=f.proc;m=v.seqNo,this.write(this.t.call_lbl(v.label())),this.write(d+":")}this.calls.push({procIndex:m,stack:0,addr:0,callLabel:d});for(var k=0,y=t;k<y.length;k++){(c=y[k]).currUses=1}this.clearStack()},e.prototype.emitStore=function(e,t){switch(e.exprKind){case x.ir.EK.CellRef:var r=e.data;if(this.emitExpr(t),r.isGlobal()){var n=this.bitSizeInfo(r.bitSize),a="#"+r.index;r.index>=n.immLimit&&(this.write(this.t.emit_int(r.index,"r1")),a="r1"),this.write(this.t.load_reg_src_off("r0","r6",a,!1,!0,n))}else{var i=this.cellref(r),s=i[0],o=i[1];a=i[2];this.write(this.t.load_reg_src_off("r0",s,o,a,!0))}break;case x.ir.EK.FieldAccess:var l=e.data;this.emitExpr(x.ir.rtcall(this.withRef("pxtrt::stfld",l.isRef),[e.args[0],x.ir.numlit(l.idx),t]));break;default:x.oops()}},e.prototype.cellref=function(e){if(e.isGlobal())throw x.oops();return e.iscap?(x.assert(0<=e.index&&e.index<32),["r5",e.index.toString(),!0]):e.isarg?["sp","args@"+(this.proc.args.length-e.index-1).toString()+":"+this.baseStackSize,!1]:["sp","locals@"+e.index,!1]},e.prototype.emitLambdaWrapper=function(e){var s=this;this.proc.action;this.write(""),this.write(".section code"),x.isAVR()?this.write(this.proc.label()+"_Lit:"):(e&&this.write(this.t.unconditional_branch(".themain")),this.write(".balign 4"),this.write(this.proc.label()+"_Lit:"),this.write(".short 0xffff, "+pxt.REF_TAG_ACTION+"   ; action literal"),e&&this.write(".themain:")),this.write("@stackmark litfunc");var t=this.proc.args.map(function(e){return e.def});this.write(this.t.proc_setup(0,!0));var r=this.t.hasCommonalize()||!!x.target.stackAlign;r?this.write(this.t.push_fixed(["r5","r6","r7"])):this.write(this.t.push_fixed(["r5","r6"])),this.baseStackSize=4;var n=t.length,a=this.stackAlignmentNeeded(t.length);a&&(this.write(this.t.push_locals(a)),n+=a),t.forEach(function(e,t){3<=t&&x.U.userError(x.U.lf("only up to three parameters supported in lambdas")),s.write(s.t.push_local("r"+(t+1)))});var o=this.t.helper_prologue();this.proc.args.forEach(function(e,t){if(e.isRef()){var r=s.cellref(e),n=r[0],a=r[1],i=r[2];o+=s.t.load_reg_src_off("r0",n,a,i)+"\n",o+=s.t.call_lbl("pxt::incr")+"\n"}}),o+=this.t.helper_epilogue(),this.emitHelper(o),this.write(this.t.call_lbl(this.proc.label())),n&&this.write(this.t.pop_locals(n)),r?this.write(this.t.pop_fixed(["r6","r5","r7"])):this.write(this.t.pop_fixed(["r6","r5"])),this.write(this.t.proc_return()),this.write("@stackempty litfunc")},e.prototype.emitCallRaw=function(e){var t=x.hex.lookupFunc(e);x.assert(!!t,"unimplemented raw function: "+e),this.alignedCall(e)},e}();x.ProctoAssembler=t}(b.pxtc||(b.pxtc={}))}(ts||(ts={})),function(e){var m,t;m=e.pxtc||(e.pxtc={}),t=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.rmap_lo={r0:"r24",r1:"r22",r2:"r20",r3:"r18",r5:"r4",r6:"r2"},e.rmap_hi={r0:"r25",r1:"r23",r2:"r21",r3:"r19",r5:"r5",r6:"r3"},e.inst_lo={adds:"add",subs:"sub",ands:"and",orrs:"or",eors:"eor",muls:"Number_::",lsls:"Number_::",asrs:"Number_::",lsrs:"Number_::"},e.inst_hi={adds:"adc",subs:"sbc",ands:"and",orrs:"or",eors:"eor"},e}return __extends(e,t),e.prototype.nop=function(){return"nop"},e.prototype.reg_gets_imm=function(e,t){var r=255&t,n=(65280&t)>>8;return"\n    ldi "+this.rmap_lo[e]+", #"+r+"\n    ldi "+this.rmap_hi[e]+", #"+n},e.prototype.push_fixed=function(e){var t=this,r="";return e.forEach(function(e){r=r+"\npush "+t.rmap_hi[e]+"\npush "+t.rmap_lo[e]}),r+="\n    @dummystack "+e.length},e.prototype.pop_fixed=function(e){var t=this,r="";return e.forEach(function(e){r=r+"\npop "+t.rmap_lo[e]+"\npop "+t.rmap_hi[e]}),r+="\n    @dummystack -"+e.length},e.prototype.proc_setup=function(e,t){var r=t?"clr r1":"";r+="\n    push r29\n    push r28";for(var n=0;n<e;++n)r+="\n    push r1\n    push r1";return r+="\n    @dummystack "+(e+1)+"\n    in r28, 0x3d\n    in r29, 0x3e\n    subi r28, #5\n    sbci r29, #0"},e.prototype.proc_return=function(){return"\n    pop r28\n    pop r29\n    @dummystack -1\n    ret"},e.prototype.debugger_hook=function(e){return"eor r1, r1"},e.prototype.debugger_bkpt=function(e){return"eor r1, r1"},e.prototype.breakpoint=function(){return"eor r1, r1"},e.prototype.push_local=function(e){return"\n    push "+this.rmap_hi[e]+"\n    push "+this.rmap_lo[e]+"\n    @dummystack 1"},e.prototype.push_locals=function(e){return"no stack alignment on AVR"},e.prototype.pop_locals=function(e){if(2*e<=5)return m.Util.range(2*e).map(function(e){return"pop r0"}).join("\n    ")+"\n    @dummystack -"+e;for(var t=e,r="\n    in\tr30, 0x3d\n    in\tr31, 0x3e\n";0<e;){var n=Math.min(e,31);r+="    adiw\tr30, #2*"+n+"\n",e-=n}return r+="\n    out\t0x3d, r30\n    out\t0x3e, r31\n    @dummystack -"+t},e.prototype.unconditional_branch=function(e){return"jmp "+e},e.prototype.beq=function(e){return"breq "+e},e.prototype.bne=function(e){return"brne "+e},e.prototype.cmp=function(e,t){var r=this.rmap_lo[e],n=this.rmap_hi[e];return"\n    cp "+r+", "+this.rmap_lo[t]+"\n    cpc "+n+", "+this.rmap_hi[t]},e.prototype.cmp_zero=function(e){return"\n    cp "+this.rmap_lo[e]+", r1\n    cpc "+this.rmap_hi[e]+", r1"},e.prototype.load_reg_src_off=function(e,t,r,n,a,i){var s="",o="";function l(e){if(m.assert(!isNaN(e)),0<=e&&e<=62)r=e.toString();else{for("Y"==s&&(o+="\n    movw r30, r28\n"),o+="\n    ; += "+e;0<e;){var t=Math.min(e,63);o+="\n    adiw r30, #"+t,e-=t}r="0",s="Z"}}var u=/^(\d+):(\d+)/.exec(r);if(u){var c=parseInt(u[1]),p=parseInt(u[2])-c;p<=3&&(r="locals@-"+p,n=!1)}if("sp"!=t?(o="\n    movw r30, "+this.rmap_lo[t],s="Z"):s="Y",n||"#"==r[0]){var d=0;d=n?2*parseInt(r):parseInt(r.slice(1)),m.assert(!isNaN(d),"off="+r+"/"+n),"sp"==t&&(d+=1,o+="\n    in  r30, 0x3d\n    in  r31, 0x3e",s="Z"),l(d)}else if("r"==r[0])"Y"==s&&(o+="\n    movw r30, r28"),o+="\n    add r30, "+this.rmap_lo[r]+"\n    adc r31, "+this.rmap_hi[r],r="0";else{m.assert("Y"==s);d=-1e5;var f=/^args@(\d+):(\d+)$/.exec(r);if(f)d=2*(parseInt(f[1])+(parseInt(f[2])+1));if(f=/^locals@([\-\d]+)$/.exec(r))d=2*parseInt(f[1]);o+="\n; "+r,d+=6,m.assert(0<=d),l(d)}return i&&1==i.size?a?"\n    "+o+"\n    std "+s+", "+r+", "+this.rmap_lo[e]:i.needsSignExt?"\n    "+o+"\n    ldd "+this.rmap_lo[e]+", "+s+", "+r+"\n    clr "+this.rmap_hi[e]+"\n    sbrc "+this.rmap_lo[e]+", 7\n    com "+this.rmap_hi[e]:"\n    "+o+"\n    ldd "+this.rmap_lo[e]+", "+s+", "+r+"\n    clr "+this.rmap_hi[e]+"\n    ":a?"\n    "+o+"\n    std "+s+", "+r+", "+this.rmap_lo[e]+"\n    std "+s+", "+r+"+1, "+this.rmap_hi[e]:"\n    "+o+"\n    ldd "+this.rmap_lo[e]+", "+s+", "+r+"\n    ldd "+this.rmap_hi[e]+", "+s+", "+r+"+1"},e.prototype.rt_call=function(e,t,r){return m.assert("r0"==t&&"r1"==r),"Number_::"==this.inst_lo[e]?this.call_lbl("Number_::"+e):"\n    "+this.inst_lo[e]+" r24, r22\n    "+this.inst_hi[e]+" r25, r23"},e.prototype.call_lbl=function(e){return"call "+e},e.prototype.call_reg=function(e){return"\n    movw r30, "+this.rmap_lo[e]+"\n    icall"},e.prototype.vcall=function(e,t,r){return m.assert(!1),""},e.prototype.prologue_vtable=function(e,t){return m.assert(!1),""},e.prototype.method_call=function(e,t){var r=this.load_reg_src_off("r0","sp","#"+2*(t.args.length-1))+"\n",n=!1,a=0;e.mapMethod?(n=!0,a=/Set/.test(e.mapMethod)?e.ifaceIndex:e.mapIdx):(a=e.virtualIndex+2,null!=e.ifaceIndex&&(n=!0,a=e.ifaceIndex));return r+=this.emit_int(a,"r1")+"\n",r+=this.call_lbl("pxtrt::fetchMethod"+(n?"Iface":""))+"\n",r+=this.call_reg("r0")+"\n"},e.prototype.helper_prologue=function(){return"\n    @stackmark args\n    movw r4, r24"},e.prototype.helper_epilogue=function(){return"\n    call pxtrt::getGlobalsPtr\n    movw r2, r24\n    ret\n    @stackempty args"},e.prototype.load_ptr=function(e,t){return m.assert(!!e),"\n    ldi "+this.rmap_lo[t]+", "+e+"@lo\n    ldi "+this.rmap_hi[t]+", "+e+"@hi"},e.prototype.emit_int=function(e,t){return this.reg_gets_imm(t,e)},e.prototype.string_literal=function(e,t){return"\n.balign 2\n"+e+"meta: .short "+t.length+"\n"+e+": .string "+m.asmStringLiteral(t)+"\n"},e.prototype.hex_literal=function(e,t){return"\n.balign 2\n"+e+": .short "+(t.length>>1)+"\n        .hex "+t+(t.length%4==0?"":"00")+"\n"},e}(m.AssemblerSnippets),m.AVRSnippets=t}(ts||(ts={})),function(e){!function(C){var P={"numops::toBoolDecr":"numops::toBool","pxtrt::ldfldRef":"pxtrt::ldfld","pxtrt::stfldRef":"pxtrt::stfld","pxtrt::ldlocRef":"pxtrt::ldloc","pxtrt::stlocRef":"pxtrt::stloc","pxtrt::mklocRef":"pxtrt::mkloc","pxtrt::mapSetRef":"pxtrt::mapSet","pxtrt::mapGetRef":"pxtrt::mapGet"};function F(e){return"PXT."+(e=e.replace(/::/g,"."))}function n(e){for(var t,r="static readonly VTable "+e.id+"_VT = new VTable("+(t=C.getName(e.decl),JSON.stringify(t))+",   "+e.refmask.length+", new FnPtr[] {\n",n=0,a=e.vtable;n<a.length;n++){r+="    "+(l=a[n]).label()+",\n"}r+="  },\n",r+="  new FnPtr[] {\n";for(var i=0,s=0,o=e.itable;s<o.length;s++){var l;r+="    "+((l=o[s])?l.label():"null")+",  // "+(e.itableInfo[i]||".")+"\n",i++}return r+="});\n"}C.csEmit=function(t,e){var r=e.hexinfo.hex[0];r+="\n// User code starts\n\n#pragma warning disable CS0164, CS1998, CS0219, CS0414, CS0162\n\nnamespace PXT {\npublic static class UserCode {\n",t.globals.forEach(function(e){r+="static object g_"+e.uniqueName()+";\n"}),t.procs.forEach(function(e){r+="\n"+function(a,d){var t="",f=function(e){t+=e+"\n"},m=function(e){t+="    "+e+"\n"},h=C.ir.EK,n=0,e=d.label()+"_CTX";d.resolve(),a.procs[0]==d&&f("\n\npublic static void Main() { "+d.label()+"(new CTX(0), null).GetAwaiter().GetResult(); }\n");var r=d.args.map(function(e,t){return"    "+K(e)+" = "+t+" >= args.Length ? TValue.Undefined : args["+t+"];\n"}).join("");f("\nstatic Action<Task, object> "+d.label()+"_delegate;\nstatic Task "+d.label()+"(CTX parent, object[] args) {\n    var s = new "+e+"(parent);\n    if ("+d.label()+"_delegate == null) {\n        "+d.label()+"_delegate = "+d.label()+"_task;\n    }\n"+r+"\n    "+d.label()+"_task(null, s);\n    return s.completion.Task;\n}\n\nstatic void "+d.label()+"_task(Task prevTask, object s_) {\n    var s = ("+e+")s_;\n    var r0 = TValue.Undefined;\n    var step = s.pc;\n    s.pc = -1;\n\n    while (true) {\n    switch (step) {\n    case 0:\n");for(var i=[],o=0,l=-1,g=0,b=[],s=0,u=d.body;s<u.length;s++){var c=u[s];c.stmtKind==C.ir.SK.Label&&(c.lblId=++g)}for(var p=0,v=d.body;p<v.length;p++){var c=v[p];switch(c.stmtKind){case C.ir.SK.Expr:A(c.expr);break;case C.ir.SK.StackEmpty:for(var k=0,y=i;k<y.length;k++){var x=y[k];x.totalUses!==x.currUses&&C.oops()}i=[];break;case C.ir.SK.Jmp:N(c);break;case C.ir.SK.Label:m("goto case "+c.lblId+";"),f("case "+c.lblId+":");break;case C.ir.SK.Breakpoint:_(c);break;default:C.oops()}}m("s.Leave(r0);"),m("return;"),f('  default: PXT.Util.check(false, "invalid pc: " + step); return;\n} } }');var S=C.nodeLocationInfo(d.action);S.functionName=d.getName(),f("// "+d.label()+".info = "+JSON.stringify(S)),f("\nclass "+e+" : CTX {\n    public "+e+"(CTX parent) : base(parent) {}");for(var T=0,I=d.locals.concat(d.args);T<I.length;T++){var E=I[T];m("public object "+E.uniqueName()+";")}for(var w=0;w<n;++w)m("public object tmp_"+w+";");for(var w=0;w<l;++w)m("public object[] callArgs_"+w+";");return f("}\n"),t;function _(e){var t,r=e.breakpointInfo.id;if(m("s.lastBrkId = "+r+";"),a.options.trace)t=++g,m("s.Trace("+r+", "+t+", "+d.label()+"_info);");else{if(!a.options.breakpoints)return;var n="s.Breakpoint("+(t=++g)+", "+r+", r0);";e.breakpointInfo.isDebuggerStmt?m(n):m("if ((breakAlways && s.IsBreakFrame()) || breakpoints["+r+"]) "+n)}f("case "+t+": // BRK")}function K(e){return e.isGlobal()?"g_"+e.uniqueName():e.iscap?"s.mycaps["+e.index+"]":"s."+e.uniqueName()}function N(e){var t="goto case "+e.lbl.lblId+";";e.jmpMode==C.ir.JmpMode.Always?(e.expr&&A(e.expr),m(t)):e.jmpMode==C.ir.JmpMode.IfJmpValEq?m("if (r0.Eq("+U(e.expr)+")) "+t):(A(e.expr),e.jmpMode==C.ir.JmpMode.IfNotZero?m("if (numops.toBool(r0)) "+t):m("if (!numops.toBool(r0)) "+t))}function L(e,t){return e+(t?"Ref":"")}function U(e){switch(e.exprKind){case h.NumberLiteral:if(!0===e.data)return"TValue.True";if(!1===e.data)return"TValue.False";if(null===e.data)return"TValue.Null";if(void 0===e.data)return"TValue.Undefined";if("number"==typeof e.data)return"(double)("+e.data+")";throw C.oops("invalid data: "+typeof e.data);case h.PointerLiteral:return e.jsInfo;case h.SharedRef:var t=e.args[0];C.U.assert(!!t.currUses),C.U.assert(t.currUses<t.totalUses),t.currUses++;var r=i.indexOf(t);return C.U.assert(0<=r),"s.tmp_"+r;case h.CellRef:var n=e.data;return K(n);default:throw C.oops()}}function A(e){switch(e.exprKind){case h.JmpValue:m("// jmp value (already in r0)");break;case h.Nop:m("// nop");break;case h.Incr:case h.Decr:A(e.args[0]);break;case h.FieldAccess:var t=e.data;return t.shimName?(A(e.args[0]),void m("r0 = r0"+t.shimName+";")):A(C.ir.rtcall(L("pxtrt::ldfld",t.isRef),[e.args[0],C.ir.numlit(t.idx)]));case h.Store:return function(e,t){switch(e.exprKind){case h.CellRef:var r=e.data;A(t);var n=function(e){switch(e){case 0:return"";case 1:return"PXT.pxtrt.toInt8";case 3:return"PXT.pxtrt.toInt16";case 5:return"PXT.pxtrt.toInt32";case 2:return"PXT.pxtrt.toUInt8";case 4:return"PXT.pxtrt.toUInt16";case 6:return"PXT.pxtrt.toUInt32";default:throw C.oops()}}(r.bitSize);m(n?K(r)+" = "+n+"(PXT.numops.toDouble(r0));":K(r)+" = r0;");break;case h.FieldAccess:var a=e.data;A(C.ir.rtcall(L("pxtrt::stfld",a.isRef),[e.args[0],C.ir.numlit(a.idx),t]));break;default:C.oops()}}(e.args[0],e.args[1]);case h.RuntimeCall:return function(e){var a=C.ir.flattenArgs(e);a.precomp.forEach(A);var t=e.data;t=C.U.lookup(P,t)||t;var r=a.flattened.map(U);if("langsupp::ignore"!=t){var n=e.callingConvention!=C.ir.CallingConvention.Plain,i=C.hex.lookupFunc(t),s=i?i.argsFmt:"";i||pxt.log("warning, missing //%: "+t);var o="object",l=!1;if(s){var u=s.split(";").filter(function(e){return!!e});"async"==u[0]&&(n=!0,u.shift()),o=u.shift(),"CTX"==u[0]&&(l=!0,u.shift()),r=r.map(function(e,t){var r=u[t];if("#"==r[0]){r=r.slice(1);var n=a.flattened[t].data;if(a.flattened[t].exprKind==h.NumberLiteral&&"number"==typeof n){if("double"==r||"float"==r)return n.toString();if((0|n)==n&&("int"==r||"uint"==r&&0<=n))return n.toString()}e="numops.toDouble("+e+")"}return"object"!=r&&(e="(("+r+")("+e+"))"),e})}l&&r.unshift("s");var c="";if(c="."==t[0]?""+r[0]+t+"("+r.slice(1).join(", ")+")":C.U.startsWith(t,"new ")?"new "+F(t.slice(4))+"("+r.join(", ")+")":F(t)+"("+r.join(", ")+")",n){var p=++g;b.push(p),m("s.pc = "+p+";"),m(c+".ContinueWith("+d.label()+"_delegate, (object)s);"),m("return;"),f("  case "+p+":\n"),c="void"==o?"/* void */":"((Task<"+o+">)prevTask).Result"}"#"==o[0]&&(c="(double)("+c+")"),m("void"==o?c+";":"r0 = "+c+";")}}(e);case h.ProcCall:return function(e){var t=e.data,r=t.proc,n=++g,a="s.callArgs_"+o;m(a+" = new object["+e.args.length+"];"),++o>l&&(l=o),e.args.forEach(function(e,t){A(e),m(a+"["+t+"] = r0;")}),m("s.pc = "+n+";");var i="(s, "+a+").ContinueWith("+d.label()+"_delegate, s)";if(null!=t.ifaceIndex){if(t.mapMethod){m("if ("+a+"[0] is PXT.RefMap) {");var s=e.args.map(function(e,t){return a+"["+t+"]"});s[0]="(PXT.RefMap)"+s[0],s.splice(1,0,t.mapIdx.toString()),m("  s.retval = "+F(t.mapMethod).replace("Ref","")+"("+s.join(", ")+");"),m("  goto case "+n+";"),m("} else {")}m("PXT.pxtrt.getVT("+a+"[0]).iface["+t.ifaceIndex+"]"+i+";"),t.mapMethod&&m("}")}else null!=t.virtualIndex?(C.assert(0<=t.virtualIndex),m("PXT.pxtrt.getVT("+a+"[0]).methods["+t.virtualIndex+"]"+i+";")):m(""+r.label()+i+";");m("return;"),f("  case "+n+":"),m("r0 = s.retval;"),o--}(e);case h.SharedDef:return function(e){var t=e.args[0];if(C.U.assert(1<=t.totalUses),C.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return A(t);A(t);var r=i.length;i.push(t),n=Math.max(n,i.length),m("s.tmp_"+r+" = r0;")}(e);case h.Sequence:return e.args.forEach(A);default:m("r0 = "+U(e)+";")}}}(t,e)+"\n"}),t.usedClassInfos.forEach(function(e){r+=n(e)}),C.U.iterMap(t.hexlits,function(e,t){r+="static readonly Buffer "+t+' = PXT.BufferMethods.createBufferFromHex("'+e+'");\n'}),r+="\n} } // end UserCode\n",t.writeFile(C.BINARY_CS,r)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(K){var N={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::bnot":"~","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!=","langsupp::ptreq":"==","langsupp::ptreqq":"===","langsupp::ptrneqq":"!==","langsupp::ptrneq":"!="};function L(e){return"pxt."==(e=e.replace(/::/g,".")).slice(0,4)&&(e="pxtcore."+e.slice(4)),K.target.shortPointers&&(e=e.replace(/^thumb\./,"avr.")),"pxsim."+e}K.isBuiltinSimOp=function(e){return!!K.U.lookup(N,e.replace(/\./g,"::"))},K.shimToJs=L,K.jsEmit=function(t){var r="'use strict';\n";t.target.jsRefCounting||(r+="pxsim.noRefCounting();\n"),t.target.floatingPoint&&(r+="pxsim.enableFloatingPoint();\n"),r+="pxsim.setTitle("+JSON.stringify(t.options.name||"")+");\n";for(var e={},n={},a=0,i=t.res.configData||[];a<i.length;a++){var s=i[a];e[s.key+""]=s.value,n[s.name]=s.key}r+="pxsim.setConfigData("+JSON.stringify(e,null,1)+", "+JSON.stringify(n,null,1)+");\n",t.procs.forEach(function(e){r+="\n"+function(s,a){var t="",l=function(e){t+=e+"\n"},u=function(e){t+="    "+e+"\n"},i=K.ir.EK,n=!!s.target.jsRefCounting;l("\nvar "+a.label()+" "+(s.procs[0]==a?"= entryPoint":"")+" = function (s) {\nvar r0 = s.r0, step = s.pc;\ns.pc = -1;\nwhile (true) {\nif (yieldSteps-- < 0 && maybeYield(s, step, r0)) return null;\nswitch (step) {\n  case 0:\n"),a.resolve(),a.locals.forEach(function(e){u(S(e)+" = "+(K.target.floatingPoint?"undefined":"0")+";")}),a.args.length&&(u("if (s.lambdaArgs) {"),a.args.forEach(function(e,t){u("  "+S(e)+" = "+(n&&e.isRef()?"pxtrt.incr":"")+"(s.lambdaArgs["+t+"]);")}),u("  s.lambdaArgs = null;"),u("}"));for(var e,r=-1,c=[],p=0,o=[],d=0,f=a.body;d<f.length;d++){var m=f[d];e&&e.lbl==m&&e.stmtKind==K.ir.SK.Jmp&&m.stmtKind==K.ir.SK.Label&&e.jmpMode==K.ir.JmpMode.Always&&1==m.lblNumUses&&(m.lblNumUses=r),m.stmtKind==K.ir.SK.Label&&(m.lblId=++p),e=m}for(var h=0,g=a.body;h<g.length;h++){var m=g[h];switch(m.stmtKind){case K.ir.SK.Expr:_(m.expr);break;case K.ir.SK.StackEmpty:for(var b=0,v=c;b<v.length;b++){var k=v[b];k.totalUses!==k.currUses&&K.oops()}c=[];break;case K.ir.SK.Jmp:T(m);break;case K.ir.SK.Label:0<m.lblNumUses&&l("  case "+m.lblId+":");break;case K.ir.SK.Breakpoint:x(m);break;default:K.oops()}}u("return leave(s, r0)"),l("  default: oops()"),l("} } }");var y=K.nodeLocationInfo(a.action);return y.functionName=a.getName(),l(a.label()+".info = "+JSON.stringify(y)),a.isRoot&&l(a.label()+".continuations = [ "+o.join(",")+" ]"),t;function x(e){var t,r=e.breakpointInfo.id;if(u("s.lastBrkId = "+r+";"),s.options.trace)t=++p,u("return trace("+r+", s, "+t+", "+a.label()+".info);");else{if(!s.options.breakpoints)return;var n="return breakpoint(s, "+(t=++p)+", "+r+", r0);";e.breakpointInfo.isDebuggerStmt?u(n):u("if ((breakAlways && isBreakFrame(s)) || breakpoints["+r+"]) "+n)}l("  case "+t+":")}function S(e){return e.isGlobal()?"globals."+e.uniqueName():e.iscap?"s.caps["+e.index+"]":"s."+e.uniqueName()}function T(e){if(e.lbl.lblNumUses==r)return K.assert(e.jmpMode==K.ir.JmpMode.Always),void(e.expr&&_(e.expr));K.assert(0<e.lbl.lblNumUses);var t="{ step = "+e.lbl.lblId+"; continue; }";e.jmpMode==K.ir.JmpMode.Always?(e.expr&&_(e.expr),u(t)):e.jmpMode==K.ir.JmpMode.IfJmpValEq?u("if (r0 == ("+E(e.expr)+")) "+t):(_(e.expr),e.jmpMode==K.ir.JmpMode.IfNotZero?u("if (r0) "+t):u("if (!r0) "+t))}function I(e,t){return e+(t?"Ref":"")}function E(e){switch(e.exprKind){case i.NumberLiteral:if(!0===e.data)return"true";if(!1===e.data)return"false";if(null===e.data)return"null";if(void 0===e.data)return"undefined";if("number"==typeof e.data)return e.data+"";throw K.oops("invalid data: "+typeof e.data);case i.PointerLiteral:return e.jsInfo;case i.SharedRef:var t=e.args[0];K.U.assert(!!t.currUses),K.U.assert(t.currUses<t.totalUses),t.currUses++;var r=c.indexOf(t);return K.U.assert(0<=r),"s.tmp_"+r;case i.CellRef:var n=e.data;return S(n);default:throw K.oops()}}function w(e){return e.shimName?e.shimName:n?null:"."+e.name+"___"+e.idx}function _(e){switch(e.exprKind){case i.JmpValue:u("// jmp value (already in r0)");break;case i.Nop:u("// nop");break;case i.Incr:_(e.args[0]),n&&u("pxtrt.incr(r0);");break;case i.Decr:_(e.args[0]),n&&u("pxtrt.decr(r0);");break;case i.FieldAccess:var t=e.data,r=w(t);return r?(K.assert(!n),_(e.args[0]),void u("r0 = r0"+r+";")):_(K.ir.rtcall(I("pxtrt::ldfld",t.isRef),[e.args[0],K.ir.numlit(t.idx)]));case i.Store:return function(e,t){switch(e.exprKind){case i.CellRef:var r=e.data;_(t),u(S(r)+" = "+function(e){switch(e){case 0:return"";case 1:return"pxsim.pxtrt.toInt8";case 3:return"pxsim.pxtrt.toInt16";case 5:return"pxsim.pxtrt.toInt32";case 2:return"pxsim.pxtrt.toUInt8";case 4:return"pxsim.pxtrt.toUInt16";case 6:return"pxsim.pxtrt.toUInt32";default:throw K.oops()}}(r.bitSize)+"(r0);");break;case i.FieldAccess:var n=e.data,a=w(n);_(a?K.ir.rtcall("="+a,[e.args[0],t]):K.ir.rtcall(I("pxtrt::stfld",n.isRef),[e.args[0],K.ir.numlit(n.idx),t]));break;default:K.oops()}}(e.args[0],e.args[1]);case i.RuntimeCall:return function(e){var t=K.ir.flattenArgs(e);t.precomp.forEach(_);var r=e.data,n=t.flattened.map(E),a="";if(a="."==r[0]?""+n[0]+r+"("+n.slice(1).join(", ")+")":"="==r[0]?"("+n[0]+")"+r.slice(1)+" = ("+n[1]+")":K.U.startsWith(r,"new ")?"new "+L(r.slice(4))+"("+n.join(", ")+")":s.target.floatingPoint&&K.U.lookup(N,r)?2==n.length?"("+n[0]+" "+K.U.lookup(N,r)+" "+n[1]+")":"("+K.U.lookup(N,r)+" "+n[0]+")":L(r)+"("+n.join(", ")+")",e.callingConvention==K.ir.CallingConvention.Plain)u("r0 = "+a+";");else{var i=++p;o.push(i),e.callingConvention==K.ir.CallingConvention.Promise?u("(function(cb) { "+a+".done(cb) })(buildResume(s, "+i+"));"):(u("setupResume(s, "+i+");"),u(a+";")),u("checkResumeConsumed();"),u("return;"),l("  case "+i+":"),u("r0 = s.retval;")}}(e);case i.ProcCall:return function(e){var t=K.ir.rtcall("<frame>",[]);t.totalUses=1,t.currUses=0;var r=c.length;c.push(t);var n=e.data,a=n.proc,i="s.tmp_"+r,s=++p;if(u(i+" = { fn: "+(a?a.label():null)+", parent: s };"),e.args.forEach(function(e,t){_(e),u(i+".arg"+t+" = r0;")}),u("s.pc = "+s+";"),null!=n.ifaceIndex){if(n.mapMethod){u("if ("+i+".arg0.vtable === 42) {");var o=e.args.map(function(e,t){return i+".arg"+t});o.splice(1,0,n.mapIdx.toString()),u("  s.retval = "+L(n.mapMethod)+"("+o.join(", ")+");"),u("  "+i+".fn = doNothing;"),u("} else {")}u("pxsim.check(typeof "+i+'.arg0  != "number", "Can\'t access property of null/undefined.")'),u(i+".fn = "+i+".arg0.vtable.iface["+n.ifaceIndex+"];"),n.mapMethod&&u("}")}else null!=n.virtualIndex&&(K.assert(0<=n.virtualIndex),u("pxsim.check(typeof "+i+'.arg0  != "number", "Can\'t access property of null/undefined.")'),u(i+".fn = "+i+".arg0.vtable.methods["+n.virtualIndex+"];"));u("return actionCall("+i+")"),l("  case "+s+":"),u("r0 = s.retval;"),t.currUses=1}(e);case i.SharedDef:return function(e){var t=e.args[0];if(K.U.assert(1<=t.totalUses),K.U.assert(0===t.currUses),(t.currUses=1)==t.totalUses)return _(t);_(t);var r=c.length;c.push(t),u("s.tmp_"+r+" = r0;")}(e);case i.Sequence:return e.args.forEach(_);default:u("r0 = "+E(e)+";")}}}(t,e)+"\n"}),t.usedClassInfos.forEach(function(e){r+=function(e){for(var t="var "+e.id+"_VT = {\n  name: "+JSON.stringify(K.getName(e.decl))+",\n  refmask: "+JSON.stringify(e.refmask)+",\n  methods: [\n",r=0,n=e.vtable;r<n.length;r++)t+="    "+(o=n[r]).label()+",\n";t+="  ],\n",t+="  iface: [\n";for(var a=0,i=0,s=e.itable;i<s.length;i++){var o;t+="    "+((o=s[i])?o.label():"null")+",  // "+(e.itableInfo[a]||".")+"\n",a++}return t+="  ],\n",t+="};\n"}(e)}),t.res.breakpoints&&(r+="\nsetupDebugger("+t.res.breakpoints.length+")\n"),K.U.iterMap(t.hexlits,function(e,t){r+="var "+t+' = pxsim.BufferMethods.createBufferFromHex("'+e+'")\n'}),t.writeFile(K.BINARY_JS,r)}}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(e){!function(c){c.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};var r={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::eors":"_numops_eors","numops::ands":"_numops_ands","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt","pxt::incr":"_pxt_incr","pxt::decr":"_pxt_decr"},e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.hasCommonalize=function(){return!!c.target.commonalize},t.prototype.stackAligned=function(){return c.target.stackAlign&&1<c.target.stackAlign},t.prototype.pushLR=function(){return this.stackAligned()?"push {lr, r3}  ; r3 for align":"push {lr}"},t.prototype.popPC=function(){return this.stackAligned()?"pop {pc, r3}  ; r3 for align":"pop {pc}"},t.prototype.nop=function(){return"nop"},t.prototype.reg_gets_imm=function(e,t){return"movs "+e+", #"+t},t.prototype.push_fixed=function(e){return"push {"+e.join(", ")+"}"},t.prototype.pop_fixed=function(e){return"pop {"+e.join(", ")+"}"},t.prototype.proc_setup=function(e,t){var r="push {lr}\n";if(0<e){r+="    movs r0, #0\n";for(var n=0;n<e;++n)r+="    push {r0} ;loc\n"}return r},t.prototype.proc_return=function(){return"pop {pc}"},t.prototype.debugger_stmt=function(e){return"\n    @stackempty locals\n    ldr r0, [r6, #0] ; debugger\n    subs r0, r0, #4  ; debugger\n"+e+":\n    ldr r0, [r0, #0] ; debugger\n"},t.prototype.debugger_bkpt=function(e){return"\n    @stackempty locals\n    ldr r0, [r6, #0] ; brk\n"+e+":\n    ldr r0, [r0, #0] ; brk\n"},t.prototype.debugger_proc=function(e){return"\n    ldr r0, [r6, #0]  ; brk-entry\n    ldr r0, [r0, #4]  ; brk-entry\n"+e+":"},t.prototype.push_local=function(e){return"push {"+e+"}"},t.prototype.push_locals=function(e){return"sub sp, #4*"+e+" ; push locals "+e+" (align)"},t.prototype.pop_locals=function(e){return"add sp, #4*"+e+" ; pop locals "+e},t.prototype.unconditional_branch=function(e){return"bb "+e},t.prototype.beq=function(e){return"beq "+e},t.prototype.bne=function(e){return"bne "+e},t.prototype.cmp=function(e,t){return"cmp "+e+", "+t},t.prototype.cmp_zero=function(e){return"cmp "+e+", #0"},t.prototype.load_reg_src_off=function(e,t,r,n,a,i){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);var s="str",o="ldr";return i&&(32==i.immLimit?s="strb":64==i.immLimit&&(s="strh"),o=i.needsSignExt?s.replace("str","ldrs"):s.replace("str","ldr")),a?s+" "+e+", ["+t+", "+r+"]":o+" "+e+", ["+t+", "+r+"]"},t.prototype.rt_call=function(e,t,r){return e+" "+t+", "+r},t.prototype.call_lbl=function(e){if(c.target.taggedInts&&!c.target.boxDebug){var t=c.U.lookup(r,e);t&&(e=t)}return"bl "+e},t.prototype.call_reg=function(e){return"blx "+e},t.prototype.vcall=function(e,t,r){return"\n    ldr r0, [sp, #"+(t?4:0)+"] ; ld-this\n    ldrh r3, [r0, #2] ; ld-vtable\n    lsls r3, r3, #"+r+"\n    ldr r3, [r3, #4] ; iface table\n    cmp r3, #43\n    beq .objlit\n.nonlit:\n    lsls r1, "+(t?"r2":"r1")+", #2\n    ldr r0, [r3, r1] ; ld-method\n    bx r0\n.objlit:\n    "+(t?"ldr r2, [sp, #0]":"")+"\n    "+this.pushLR()+"\n    bl "+e+"\n    "+this.popPC()+"\n"},t.prototype.prologue_vtable=function(e,t){return"\n    ldr r0, [sp, #4*"+e+"]  ; ld-this\n    ldrh r0, [r0, #2] ; ld-vtable\n    lsls r0, r0, #"+t+"\n    "},t.prototype.helper_prologue=function(){return"\n    @stackmark args\n    "+this.pushLR()+"\n    mov r5, r0\n"},t.prototype.helper_epilogue=function(){return"\n    bl pxtrt::getGlobalsPtr\n    mov r6, r0\n    "+this.popPC()+"\n    @stackempty args\n"},t.prototype.load_ptr_full=function(e,t){return c.assert(!!e),"\n    ldlit "+t+", "+e+"\n"},t.prototype.load_ptr=function(e,t){return c.assert(!!e),"\n    movs "+t+", "+e+"@hi  ; ldptr\n    lsls "+t+", "+t+", #8\n    adds "+t+", "+e+"@lo\n"},t.prototype.arithmetic=function(){var e="";if(!c.target.taggedInts||c.target.boxDebug)return e;for(var t=0,r=["adds","subs","ands","orrs","eors"];t<r.length;t++){e+="\n_numops_"+(o=r[t])+":\n    @scope _numops_"+o+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n","adds"==o||"subs"==o?e+="\n    subs r2, r1, #1\n    "+o+" r2, r0, r2\n    bvs .boxed\n    movs r0, r2\n    blx lr\n":(e+="    "+o+" r0, r1\n","eors"==o&&(e+="    adds r0, r0, #1\n"),e+="    blx lr\n"),e+="\n.boxed:\n    push {r4, lr}\n    push {r0, r1}\n    bl numops::"+o+"\n    movs r4, r0\n    pop {r0}\n    "+(this.stackAligned()?"push {r0} ; align":"")+"\n    bl _pxt_decr\n    "+(this.stackAligned()?"pop {r0} ; unalign":"")+"\n    pop {r0}\n    bl _pxt_decr\n    movs r0, r4\n    pop {r4, pc}\n"}e+="\n@scope _numops_toInt\n_numops_toInt:\n    asrs r0, r0, #1\n    bcc .over\n    blx lr\n.over:\n    "+this.pushLR()+"\n    lsls r0, r0, #1\n    bl pxt::toInt\n    "+this.popPC()+"\n\n_numops_fromInt:\n    lsls r2, r0, #1\n    asrs r1, r2, #1\n    cmp r0, r1\n    bne .over2\n    adds r0, r2, #1\n    blx lr\n.over2:\n    "+this.pushLR()+"\n    bl pxt::fromInt\n    "+this.popPC()+"\n";for(var n=0,a=["incr","decr"];n<a.length;n++){e+="\n_pxt_"+(o=a[n])+":\n    @scope _pxt_"+o+"\n    lsls r3, r0, #30\n    beq .t0\n    bx lr\n.t0:\n    cmp r0, #0\n    beq .skip\n    "+this.pushLR()+"\n    bl pxt::"+o+"\n    "+this.popPC()+"\n.skip:\n    bx lr\n"}for(var i=0,s=Object.keys(c.thumbCmpMap);i<s.length;i++){var o;e+="\n_cmp_"+(o=(o=s[i]).replace(/.*::/,""))+":\n    @scope _cmp_"+o+"\n    lsls r2, r0, #31\n    beq .boxed\n    lsls r2, r1, #31\n    beq .boxed\n    subs r0, r1\n    b"+o.replace("qq","q").replace("neq","ne")+" .true\n.false:\n    movs r0, #0\n    bx lr\n.true:\n    movs r0, #1\n    bx lr\n.boxed:\n    push {r4, lr}\n    push {r0, r1}\n    bl numops::"+o+"\n    bl numops::toBoolDecr\n    movs r4, r0\n    pop {r0}\n    "+(this.stackAligned()?"push {r0} ; align":"")+"\n    bl _pxt_decr\n    "+(this.stackAligned()?"pop {r0} ; unalign":"")+"\n    pop {r0}\n    bl _pxt_decr\n    movs r0, r4\n    pop {r4, pc}\n"}return e},t.prototype.emit_int=function(e,r){var n=!1;function t(e){c.assert(0<=e&&e<=255);var t="";return n?e&&(t="adds "+r+", #"+e+"\n"):t="movs "+r+", #"+e+"\n",n=!0,t}function a(e){return void 0===e&&(e=8),"lsls "+r+", "+r+", #"+e+"\n"}c.assert(null!=e);var i=Math.floor(e),s=!1;i<0&&(s=!0,i=-i);var o=0;if(255<i){for(var l=i;0==(1&l);)l>>>=1,o++;c.numBytes(l)<c.numBytes(i)?i=l:o=0}var u="";switch(c.numBytes(i)){case 4:u+=t(i>>>24&255),u+=a();case 3:u+=t(i>>>16&255),u+=a();case 2:u+=t(i>>>8&255),u+=a();case 1:u+=t(255&i);break;default:c.oops()}return o&&(u+=a(o)),s&&(u+="negs "+r+", "+r+"\n"),4<u.split("\n").length?"ldlit "+r+", "+Math.floor(e)+"\n":u},t}(c.AssemblerSnippets);c.ThumbSnippets=e}(e.pxtc||(e.pxtc={}))}(ts||(ts={})),function(l){var x,S,T;x=l.pxtc||(l.pxtc={}),S={"Number_::eq":"eq","Number_::adds":"add","Number_::subs":"sub"},T={},x.vmEmit=function(t,n){var a="; VM start\n"+x.hex.hexPrelude()+"        \n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+x.hex.hexTemplateHash()+" ; hex template hash\n    .hex 0000000000000000 ; @SRCHASH@\n    .short "+t.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of words resulting from assembly\n    .word 0 ; reserved\n    .word 0 ; reserved\n    .word 0 ; reserved\n",r=new x.AVRSnippets;t.procs.forEach(function(e){a+="\n"+function(o,l){var t="",u=function(e){t+=e+"\n"},c=function(e){t+="    "+e+"\n"},p=x.ir.EK,d=2,a=[],f=[],i=!1,m=0,h=0;l.resolve(),s(),o.numStmts=m,t="";for(var e=0,r=a;e<r.length;e++){var n=r[e];n.currUses=0}return i=!0,s(),t;function s(){u(";\n; Proc: "+l.getName()+"\n;"),c(".section code"),o.procs[0]==l&&u("; main"),u(l.label()+":"),u(l.label()+"_Lit:"),h=l.locals.length+f.length,c(0==h?"locals0":"locals "+h*d+" ; incl. "+f.length+" tmps");for(var e=0,t=l.body;e<t.length;e++){var r=t[e];switch(r.stmtKind){case x.ir.SK.Expr:k(r.expr);break;case x.ir.SK.StackEmpty:y();for(var n=0,a=f;n<a.length;n++){var i=a[n];i&&x.oops("uses: "+i.currUses+"/"+i.totalUses+" "+i.toString())}break;case x.ir.SK.Jmp:g(r);break;case x.ir.SK.Label:u(r.lblName+":");break;case x.ir.SK.Breakpoint:m++;break;default:x.oops()}}var s=h*d|l.args.length<<8;c("ret 0x"+s.toString(16))}function g(e){var t=e.lbl.lblName;e.jmpMode==x.ir.JmpMode.Always?(e.expr&&k(e.expr),c("jmp "+t)):e.jmpMode==x.ir.JmpMode.IfLambda?(e.expr&&k(e.expr),c("retlmb "+h*d)):e.jmpMode==x.ir.JmpMode.IfJmpValEq?(c("push"),k(e.expr),c("eq"),c("jmpnz "+t)):(k(e.expr),e.jmpMode==x.ir.JmpMode.IfNotZero?c("jmpnz "+t):e.jmpMode==x.ir.JmpMode.IfZero?c("jmpz "+t):x.oops())}function b(e,t){return e+(t?"Ref":"")}function v(e){if(e.isGlobal())return"glb "+e.index;if(e.iscap)return"cap "+e.index*d;if(e.isarg){var t=l.args.length-e.index-1;return x.assert(0<=t,"arg#"+t),"tmp "+(h+2+t)*d}var t=e.index+f.length;return x.assert(!i||t<h,"cell#"+t),x.assert(0<=t,"cell#"+t),"tmp "+t*d}function k(e){switch(e.exprKind){case p.JmpValue:c("; jmp value (already in r0)");break;case p.Nop:c("; nop");break;case p.Incr:k(e.args[0]),c("incr");break;case p.Decr:k(e.args[0]),c("decr");break;case p.FieldAccess:var t=e.data;return k(x.ir.rtcall(b("pxtrt::ldfld",t.isRef),[e.args[0],x.ir.numlit(t.idx)]));case p.Store:return function(e,t){switch(e.exprKind){case p.CellRef:k(t);var r=e.data,n="st"+v(r);!r.isGlobal()||1!=r.bitSize&&2!=r.bitSize||(n=n.replace("stglb","stglb1")),c(n);break;case p.FieldAccess:var a=e.data;k(x.ir.rtcall(b("pxtrt::stfld",a.isRef),[e.args[0],x.ir.numlit(a.idx),t]));break;default:x.oops()}}(e.args[0],e.args[1]);case p.RuntimeCall:return function(e){var t=e.data,r=/^(.*)\^(\d+)$/.exec(t),n=0;r&&(t=r[1],n=parseInt(r[2])),t=x.U.lookup(T,t)||t,x.assert(n<=15);var a=x.ir.flattenArgs(e);if(x.assert(0==a.precomp.length),y(),"pxt::stringLiteral"!=t||1!=a.flattened.length||a.flattened[0].exprKind!=p.PointerLiteral){x.assert(a.flattened.length<=4);var i="0x"+(n+16*a.flattened.length).toString(16);t=t.replace(/^thumb::/,"Number_::");var s=x.U.lookup(S,t);n&&(s=null);for(var o=0;o<a.flattened.length;++o)k(a.flattened[o]),o<a.flattened.length-1&&c("push");c(s||"call "+i+", "+t)}else c("stringlit "+a.flattened[0].data)}(e);case p.ProcCall:return function(e){for(var t=e.data,r=t.proc,n=0,a=e.args;n<a.length;n++){var i=a[n];k(i),c("push")}var s=-1,o="";null!=t.ifaceIndex?(s=t.ifaceIndex,o="pxtrt::fetchMethodIface"):null!=t.virtualIndex&&(s=t.virtualIndex+2,o="pxtrt::fetchMethod"),o?(c("ldstack "+(e.args.length*d-1)),c("push"),c("ldconst "+s),c("call 0x20, "+o),c("callind")):c("callproc "+r.label())}(e);case p.SharedDef:return function(e){var t=e.args[0];if(x.U.assert(1<=t.totalUses),x.U.assert(0===t.currUses),t.currUses=1,a.push(t),1==t.totalUses)return k(t);k(t);for(var r=-1,n=0;n<f.length;++n)if(null==f[n]){r=n;break}r<0?(i&&(console.log(t,f),x.assert(!1,"missed tmp")),r=f.length,f.push(t)):f[r]=t,c("sttmp "+r*d)}(e);case p.Sequence:return e.args.forEach(k);default:return function(e){switch(e.exprKind){case p.NumberLiteral:return void(0===e.data?c("ldzero"):1===e.data?c("ldone"):c("ldconst "+(65535&e.data)));case p.PointerLiteral:return void c("ldconst "+e.data);case p.SharedRef:var t=e.args[0];x.U.assert(!!t.currUses),x.U.assert(t.currUses<t.totalUses),t.currUses++;var r=f.indexOf(t);return r<0&&(console.log(f,t),x.assert(!1)),c("ldtmp "+r*d),void y();case p.CellRef:c("ld"+v(e.data));var n=e.data;return void(n.isGlobal()&&(1==n.bitSize?c("sgnext"):2==n.bitSize&&c("clrhi")));default:throw x.oops()}}(e)}}function y(){for(var e=0;e<f.length;++e){var t=f[e];t&&t.currUses==t.totalUses&&(i||a.push(t),f[e]=null)}}}(t,e)+"\n"}),t.usedClassInfos.forEach(function(e){var t,r;a+=(t=e,r=n,x.vtableToAsm(t,r))}),x.U.iterMap(t.hexlits,function(e,t){a+=r.hex_literal(t,e)}),x.U.iterMap(t.strings,function(e,t){a+=r.string_literal(t,e)}),a+="\n; The end.\n",t.writeFile(x.BINARY_ASM,a);var e=x.assemble(n.target,t,a);if(e.src&&t.writeFile(x.BINARY_ASM,e.src),e.buf){for(var i=[],s=0;s<e.buf.length;s+=2)i.push(e.buf[s]|e.buf[s+1]<<8);var o=l.pxtc.encodeBase64(x.hex.patchHex(t,i,!1,!0)[0]);t.writeFile(pxt.outputName(x.target),o)}}}(ts||(ts={})),function(Ee){var we;(function(I){var Q,e;(e=Q=I.DecompileParamKeys||(I.DecompileParamKeys={})).DecompileLiterals="decompileLiterals",e.TaggedTemplate="taggedTemplate",e.DecompileIndirectFixedInstances="decompileIndirectFixedInstances",I.FILE_TOO_LARGE_CODE=9266;var ee=Ee.SyntaxKind,te=1e3,u=97,c=122,re=160,ne=120,ae=480,ie=360,s=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,se="math_number",oe="math_integer",le="math_whole_number",ue="text",ce="logic_boolean",pe={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"**":{type:"math_arithmetic",op:"POWER"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},de=/^\s*\/\/\s*(.*)$/,fe=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/,t=function(){function e(e){this.renames=e,this.renames.sort(function(e,t){return e.span.start-t.span.start})}return e.prototype.getRenamesInSpan=function(e,t){for(var r=[],n=0,a=this.renames;n<a.length;n++){var i=a[n];if(i.span.start>t)break;i.span.start>=e&&r.push(i)}return r},e.prototype.getRenameForPosition=function(e){for(var t=0,r=this.renames;t<r.length;t++){var n=r[t];if(n.span.start>e)return;if(n.span.start===e)return n}},e}();I.RenameMap=t;var me,r,n=function(){function e(e){this.p=e}return e.prototype.getCompilationSettings=function(){var e=this.p.getCompilerOptions();return e.noLib=!0,e},e.prototype.getNewLine=function(){return"\n"},e.prototype.getScriptFileNames=function(){return this.p.getSourceFiles().map(function(e){return e.fileName})},e.prototype.getScriptVersion=function(e){return"0"},e.prototype.getScriptSnapshot=function(e){var t=this.p.getSourceFile(e);return{getLength:function(){return t.getFullText().length},getText:function(){return t.getFullText()},getChangeRange:function(){}}},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return""},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}();function he(e,t,r,n){switch(void 0===r&&(r=!1),void 0===n&&(n=!1),e.kind){case ee.WhileStatement:case ee.IfStatement:case ee.Block:return;case ee.ExpressionStatement:return he(e.expression,t,r,n);case ee.VariableStatement:return function(e,t){for(var r=0,n=e.declarationList.declarations;r<n.length;r++){var a=n[r],i=s(a,t);if(i)return i}}(e,t);case ee.CallExpression:return function(e,S,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);var s=e.callInfo;if(!s)return we.Util.lf("Function call not supported in the blocks");var T=S.attrs(s);if(t){if("Math.pow"==s.qName)return;if(pxt.Util.startsWith(s.qName,"Math.")){var n=s.qName.substring(5);if(Ie(n))return}}else if(s.isExpression)return we.Util.lf("No output expressions as statements");if(T.blockId===we.PAUSE_UNTIL_TYPE){var a=e.arguments[0];if(1===e.arguments.length&&function(e){if(e.kind!==ee.FunctionExpression&&e.kind!==ee.ArrowFunction)return!1;var t=e;if(function(e){switch(e.kind){case ee.BinaryExpression:var t=e.operatorToken.kind;return t!=ee.PlusEqualsToken&&t!=ee.MinusEqualsToken&&t!=ee.EqualsToken;case ee.PrefixUnaryExpression:case ee.PostfixUnaryExpression:var r=e.operator;return r!=ee.PlusPlusToken&&r!=ee.MinusMinusToken;case ee.CallExpression:var n=e.callInfo;return we.assert(!!n),n.isExpression;case ee.ParenthesizedExpression:case ee.NumericLiteral:case ee.StringLiteral:case ee.NoSubstitutionTemplateLiteral:case ee.TrueKeyword:case ee.FalseKeyword:case ee.NullKeyword:case ee.TaggedTemplateExpression:return!0;default:return!1}}(t.body))return!0;var r=t.body;if(1===r.statements.length){var n=ye(r.statements[0]);if(n.kind===ee.ReturnStatement)return!0}return!1}(a))return;return we.Util.lf("Predicates must be inline expressions that return a value")}var i=xe(s,T);if(i&&!T.handlerStatement&&!r)return we.Util.lf("Events must be top level");if(!T.blockId||!T.block){var o=pxt.blocks.builtinFunctionInfo[s.qName];if(!o)return 0===e.arguments.length&&e.expression.kind===ee.Identifier?S.declaredFunctions[e.expression.text]?void 0:we.Util.lf("Call statements must have a valid declared function"):we.Util.lf("Function call not supported in the blocks");T.blockId=o.blockId}var l=Te(s,S.blocks),u=S.blocks.apis.byQName[s.qName],c=pxt.blocks.compileInfo(u),p=c.parameters.length+(c.thisParameter?1:0);if(T.imageLiteral){if(1<s.args.length-p)return we.Util.lf("Function call has more arguments than are supported by its block");var d=e.arguments[0];if(d.kind!=ee.StringLiteral&&d.kind!=ee.NoSubstitutionTemplateLiteral)return we.Util.lf("Only string literals supported for image literals");var f=(d.text||"").replace(/\s+/g,""),m=5*T.imageLiteral;return 5*m!=f.length?we.Util.lf("Invalid image pattern"):void 0}var h=s.args.length-p;if(0<h&&!function(){if(T.mutatePropertyEnum&&2===h&&2<=s.args.length){var e=s.args[s.args.length-2],t=s.args[s.args.length-1];if(e.kind===ee.ArrayLiteralExpression&&x(t)){var r=[],n=!e.elements.some(function(e){return e.kind!==ee.PropertyAccessExpression||e.expression.kind!==ee.Identifier||(r.push(e.name.text),e.expression.text!==T.mutatePropertyEnum)});if(n){var a=be(t);if(a){var i=a[0];return i.length===r.length&&!r.some(function(e){return-1===i.indexOf(e)})}}}}return!1}()){var g=h;if(i&&g--,T.defaultInstance&&g--,0<g)return we.Util.lf("Function call has more arguments than are supported by its block")}if(c.parameters.length||i){var b,v=T.defaultInstance||!!c.thisParameter;if(l.forEach(function(e,t){b||v&&0===t||(v&&t--,b=function(e){var t=ye(e.value),r=e.info,n=e.param;if(r.isEnum){if(x(t))return;if(t.kind===ee.CallExpression){var a=t.callInfo,i=S.attrs(a);if(a&&"TD_ID"===i.shim&&a.args&&1===a.args.length){var s=ye(a.args[0]);if(x(s))return}}return we.Util.lf("Enum arguments may only be literal property access expressions")}if(Se(t)&&(n.fieldEditor||n.shadowBlockId)){var o=!(!n.fieldOptions||!n.fieldOptions[Q.DecompileLiterals]);if(!o&&n.shadowBlockId){var l=S.blocks.blocksById[n.shadowBlockId];if(l&&l.parameters&&l.parameters.length){var u=l.parameters[0].name;o=!l.attributes.paramFieldEditorOptions||!l.attributes.paramFieldEditorOptions[u]||!!l.attributes.paramFieldEditorOptions[u][Q.DecompileLiterals]}else o=!0}if(!o)return we.Util.lf("Field editor does not support literal arguments")}else if(t.kind===ee.TaggedTemplateExpression&&n.fieldEditor){var c=n.fieldOptions&&n.fieldOptions[Q.TaggedTemplate];if(!c)return we.Util.lf("Tagged templates only supported in custom fields with param.fieldOptions.taggedTemplate set");var p=ye(t.tag);if(p.kind!==ee.Identifier)return we.Util.lf("Tagged template literals must use an identifier as the tag");var d=p.getText();if(d.trim()!=c.trim())return we.Util.lf("Function only supports template literals with tag '{0}'",c);var f=t.template;if(f.kind!==ee.NoSubstitutionTemplateLiteral)return we.Util.lf("Tagged template literals cannot have substitutions")}else if(t.kind===ee.ArrowFunction){var m=t;if(m.parameters.length)if("objectdestructuring"===T.mutate){var h=ye(m.parameters[0]);if(h.kind===ee.Parameter&&h.name.kind!==ee.ObjectBindingPattern)return we.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments")}else for(var g=0,b=m.parameters;g<b.length;g++){var v=b[g];if(v.name.kind!==ee.Identifier)return we.Util.lf("Only identifiers allowed as function arguments")}}else if(S.blocks.apis.byQName[r.type]){var k=S.blocks.apis.byQName[r.type];if(k.attributes.fixedInstances){if(E(n))return;if(n.shadowBlockId){var y=S.blocks.blocksById[n.shadowBlockId];if(y){var l=pxt.blocks.compileInfo(y);if(l.parameters&&E(l.parameters[0]))return}}var a=t.callInfo;if(a&&S.attrs(a).fixedInstance)return;return we.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}}return;function x(e){if(e.kind===ee.PropertyAccessExpression){var t=e.expression;if(t.kind===ee.Identifier&&t.text===r.type)return!0}return!1}}(e))}),b)return b}if(u){var k=S.blocks.apis.byQName[u.namespace];if(k&&k.attributes.fixedInstances&&!k.attributes.decompileIndirectFixedInstances&&s.args.length){var y=s.args[0].callInfo;if(!y||!S.attrs(y).fixedInstance)return we.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}}(e,t,r,n);case ee.VariableDeclaration:return s(e,t);case ee.PostfixUnaryExpression:case ee.PrefixUnaryExpression:return(a=e).operand.kind!=ee.Identifier?we.Util.lf("-- and ++ may only be used on an identifier"):a.operator!==ee.PlusPlusToken&&a.operator!==ee.MinusMinusToken?we.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0;case ee.FunctionExpression:case ee.ArrowFunction:return function(e,t){var r=!1;if(e.parameters.length){var n=ke(e)[0];if(n&&n.callInfo){var a=n.callInfo;r="objectdestructuring"===t.attrs(a).mutate?e.parameters[0].name.kind!==ee.ObjectBindingPattern:e.parameters.some(function(e){return e.name.kind!==ee.Identifier})}}if(r)return we.Util.lf("Unsupported parameters in error function")}(e,t);case ee.BinaryExpression:return function(e,t){if(e.left.kind===ee.ElementAccessExpression){if(e.operatorToken.kind!==ee.EqualsToken)return we.Util.lf("Element access expressions may only be assigned to using the equals operator")}else if(e.left.kind===ee.PropertyAccessExpression){if(e.operatorToken.kind!==ee.EqualsToken&&e.operatorToken.kind!==ee.PlusEqualsToken)return we.Util.lf("Property access expressions may only be assigned to using the = and += operators")}else{if(e.left.kind!==ee.Identifier)return we.Util.lf("This expression cannot be assigned to");switch(e.operatorToken.kind){case ee.EqualsToken:return ve(e.right,t);case ee.PlusEqualsToken:case ee.MinusEqualsToken:return;default:return we.Util.lf("Unsupported operator token in statement {0}",ee[e.operatorToken.kind])}}}(e,t);case ee.ForStatement:return function(r){if(!r.initializer||!r.incrementor||!r.condition)return we.Util.lf("for loops must have an initializer, incrementor, and condition");if(r.initializer.kind!==ee.VariableDeclarationList)return we.Util.lf("only variable declarations are permitted in for loop initializers");var e=r.initializer;if(!e.declarations)return we.Util.lf("for loop with out-of-scope variables not supported");if(1!=e.declarations.length)return we.Util.lf("for loop with multiple variables not supported");var t=e.declarations[0];if(t.initializer.kind!==ee.NumericLiteral||"0"!==t.initializer.text)return we.Util.lf("for loop initializers must be initialized to 0");var n=t.name.text;if(!function(e){if(r.incrementor.kind===ee.PostfixUnaryExpression||r.incrementor.kind===ee.PrefixUnaryExpression){var t=r.incrementor;if(t.operator===ee.PlusPlusToken&&t.operand.kind===ee.Identifier)return t.operand.text===e}return!1}(n))return we.Util.lf("for loop incrementors may only increment the variable declared in the initializer");if(r.condition.kind!==ee.BinaryExpression)return we.Util.lf("for loop conditionals must be binary comparison operations");var a=r.condition;return a.left.kind!==ee.Identifier||a.left.text!==n?we.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):a.operatorToken.kind!==ee.LessThanToken&&a.operatorToken.kind!==ee.LessThanEqualsToken?we.Util.lf("for loop conditional operator must be either < or <="):void 0}(e);case ee.ForOfStatement:return function(e){if(e.initializer.kind!==ee.VariableDeclarationList)return we.Util.lf("only variable declarations are permitted in for of loop initializers")}(e);case ee.FunctionDeclaration:return function(e,t){if(!t)return we.Util.lf("Function declarations must be top level");if(0<e.parameters.length)return we.Util.lf("Functions with parameters not supported in blocks");var r=!1;return Ee.forEachReturnStatement(e.body,function(e){e.expression&&(r=!0)}),r?we.Util.lf("Function with return value not supported in blocks"):void 0}(e,n);case ee.DebuggerStatement:return}var a;return we.Util.lf("Unsupported statement in block: {0}",ee[e.kind]);function s(e,t){var r;return e.name.kind!==ee.Identifier?r=we.Util.lf("Variable declarations may not use binding patterns"):e.initializer?ge(e)||(r=ve(e.initializer,t)):r=we.Util.lf("Variable declarations must have an initializer"),r}}function ge(e){if(e.initializer){if(e.initializer.kind===Ee.SyntaxKind.NullKeyword||e.initializer.kind===Ee.SyntaxKind.FalseKeyword||(a=e.initializer).kind===ee.ArrayLiteralExpression&&0===a.elements.length)return!0;if(Ee.isStringOrNumericLiteral(e.initializer)){var t=e.initializer.getText();return"0"===t||'""'===(n=t)||"''"===n||"``"===n}var r=e.initializer.callInfo;if(r&&r.isAutoCreate)return!0}var n,a;return!1}function be(e){if(1===e.parameters.length&&e.parameters[0].name.kind===ee.ObjectBindingPattern){var t=e.parameters[0].name.elements,n={};return[t.map(function(e){if(a(e.propertyName)&&a(e.name)){var t=e.name.text;if(e.propertyName){var r=e.propertyName.text;return n[r]=t,r}return t}return""}),n]}return;function a(e){return!e||e.kind===ee.Identifier}}function ve(e,t){switch(e.kind){case ee.NumericLiteral:case ee.TrueKeyword:case ee.FalseKeyword:case ee.ExpressionStatement:case ee.ArrayLiteralExpression:case ee.ElementAccessExpression:return;case ee.ParenthesizedExpression:return ve(e.expression,t);case ee.StringLiteral:case ee.FirstTemplateToken:case ee.NoSubstitutionTemplateLiteral:return i=e.text,s.test(i)?void 0:we.Util.lf("Only whitespace character allowed in string literals is space");case ee.Identifier:return(a=e)&&a.kind===ee.Identifier&&"undefined"===a.text?we.Util.lf("Undefined is not supported in blocks"):void 0;case ee.BinaryExpression:var r=e.operatorToken.getText();return pe[r]?void 0:we.Util.lf("Could not find operator {0}",r);case ee.PrefixUnaryExpression:var n=e.operator;return n===ee.MinusToken||n===ee.PlusToken||n===ee.ExclamationToken?void 0:we.Util.lf("Unsupported prefix unary operator{0}",n);case ee.PropertyAccessExpression:return function(e,t){var r=e.callInfo;if(r){var n=t.attrs(r);if(n.blockIdentity||"lists_length"===n.blockId||"text_length"===n.blockId)return;if(n.blockCombine)return ve(e.expression,t);if(r.decl.kind===ee.EnumMember){var a=ke(e),i=a[0],s=a[1],o=!0;if(i){var l=i.callInfo;if(l&&l.args){var u=t.blocks.apis.byQName[l.qName],c=u.kind==we.SymbolKind.Method||u.kind==we.SymbolKind.Property;u&&l.args.forEach(function(e,t){if(e===s){var r=u.parameters[c?t-1:t];r.isEnum&&(o=!1)}})}}return o?we.Util.lf("Enum value without a corresponding block"):void 0}if(n.fixedInstance&&e.parent)if(e.parent.parent&&e.parent.kind===ee.PropertyAccessExpression&&e.parent.parent.kind===ee.CallExpression){var p=e.parent.parent;if(p.expression===e.parent)return}else if(e.parent.kind===ee.CallExpression&&e.parent.expression!==e)return}return we.Util.lf("No call info found")}(e,t);case ee.CallExpression:return he(e,t,!0);case ee.TaggedTemplateExpression:return function(e,t){var r=e.callInfo;if(!r)return we.Util.lf("Invalid tagged template");var n=t.attrs(r);if(!n.blockIdentity)return we.Util.lf("Tagged template does not have blockIdentity set");var a=t.blocks.apis.byQName[n.blockIdentity];return a?1!==pxt.blocks.compileInfo(a).parameters.length?we.Util.lf("Tagged template functions must have 1 argument"):void 0:we.Util.lf("Could not find blockIdentity for tagged template")}(e,t)}var a,i;return we.Util.lf("Unsupported syntax kind for output expression block: {0}",ee[e.kind])}function ke(e){return e.parent?e.parent.kind===ee.ParenthesizedExpression?ke(e.parent):[e.parent,e]:[void 0,e]}function ye(e){for(;e.kind===ee.ParenthesizedExpression;)e=e.expression;return e}function xe(e,t){return t.blockId!==we.PAUSE_UNTIL_TYPE&&(e.decl.parameters,e.args.some(function(e,t){return e&&x(e)}))}function Se(e){if(!e)return!1;switch(e.kind){case ee.ParenthesizedExpression:return Se(e.expression);case ee.NumericLiteral:case ee.StringLiteral:case ee.NoSubstitutionTemplateLiteral:case ee.TrueKeyword:case ee.FalseKeyword:return!0;case ee.PrefixUnaryExpression:var t=e;return(t.operator===ee.PlusToken||t.operator===ee.MinusToken)&&Se(t.operand);default:return!1}}function x(e){return e.kind===ee.ArrowFunction||e.kind===ee.FunctionExpression}function Te(e,t){var r=[],n=t.apis.byQName[e.qName];if(n){var a=t.apis.byQName[e.qName].attributes,i=pxt.blocks.compileInfo(n),s=(pxt.blocks.builtinFunctionInfo[e.qName],a.imageLiteral?1:0);i.thisParameter?r.push({value:ye(e.args[0]),info:null,param:i.thisParameter}):a.defaultInstance&&r.push({value:ye(e.args[0]),info:n.parameters[0],param:{definitionName:"__instance__",actualName:"this"}});var o=!(!i.thisParameter&&!a.defaultInstance);o&&s++;for(var l=s;l<e.args.length;l++)r.push({value:ye(e.args[l]),info:n.parameters[o?l-1:l],param:i.parameters[l-s]})}return r}function E(e){return e&&e.fieldOptions&&e.fieldOptions[Q.DecompileIndirectFixedInstances]}function Ie(e){return-1!==pxt.blocks.MATH_FUNCTIONS.unary.indexOf(e)||-1!==pxt.blocks.MATH_FUNCTIONS.binary.indexOf(e)}I.buildRenameMap=function(e,i){var s,o=Ee.createLanguageService(new n(e)),l=[];return s={},function a(e){Ee.forEachChild(e,function(e){if(e.kind===ee.VariableDeclaration&&e.name.kind===ee.Identifier){var t=e.name.getText();if(s[t]){var r=function(e){if(1===e.length){var t=e.charCodeAt(0);if(u<=t&&t<=c)for(var r=t-u,n=1;n<26;n++){var a=String.fromCharCode(u+(r+n)%26);if(!s[a])return s[a]=!0,a}}for(var n=2;;n++){var i=e+n;if(!s[i])return s[i]=!0,i}}(t),n=o.findRenameLocations(i.fileName,e.name.pos+1,!1,!1);n&&n.forEach(function(e){l.push({name:r,diff:r.length-t.length,span:e.textSpan})})}else s[t]=!0}a(e)})}(i),l.length?new t(l):void 0},(r=me||(me={}))[r.None=0]="None",r[r.InBlocksOnly=1]="InBlocksOnly",r[r.InTextBlocks=2]="InTextBlocks",I.decompileToBlocks=function(U,E,c,r){var e,t,n=0,a=E.statements,i={blocksInfo:U,outfiles:{},diagnostics:[],success:!0,times:{}},A={blocks:U,declaredFunctions:{},attrs:P},w=E.getFullText(),s="",d={},_=[],K=[],N=(e=0,function(){return""+e++});Ee.forEachChild(E,function(e){e.kind!==ee.FunctionDeclaration||he(e,A,!1,!0)||(A.declaredFunctions[X(e.name)]=!0)});try{t=Y(a,void 0,!0,void 0,!c.snippetMode)}catch(e){if(!e.programTooLarge)throw e;i.success=!1,i.diagnostics=we.patchUpDiagnostics([{file:E,start:E.getFullStart(),length:E.getFullWidth(),messageText:e.message,category:Ee.DiagnosticCategory.Error,code:I.FILE_TOO_LARGE_CODE}])}return t&&m(t),_.forEach(function(e){!function(e){var t=0,r=e.text.split("\n");r.forEach(function(e){return t=Math.max(t,e.length)});var n=Math.max(Math.min(10*t,ae),re);o('<comment h="'+Math.max(Math.min(40*r.length,ie),ne)+'" w="'+n+'" data="'+we.U.htmlEscape(e.refId)+'">'),o(we.U.htmlEscape(e.text)),o("</comment>")}(e)}),i.outfiles[E.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]='<xml xmlns="http://www.w3.org/1999/xhtml">\n'+s+"</xml>",i;function o(e,t){void 0===t&&(t="\n"),s+=e+t}function C(e,t){var r=t||'Language feature "'+e.getFullText().trim()+'"" not supported in blocks',n=we.patchUpDiagnostics([{file:E,start:e.getFullStart(),length:e.getFullWidth(),messageText:r,category:Ee.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+r),we.U.pushRange(i.diagnostics,n),i.success=!1}function P(e){var t=U.apis.byQName[e.qName];if(t)return t.attributes}function F(){if(te<++n){var e=new Error(we.Util.lf("Could not decompile because the script is too large"));throw e.programTooLarge=!0,e}}function $(e){return F(),{kind:"statement",type:e}}function D(e){return F(),{kind:"expr",type:e}}function R(e,t,r){return r&&"expr"===t.kind&&t.type!==r&&F(),{kind:"value",name:e,value:t,shadowType:r}}function f(e){if(e.expression.kind==ee.CallExpression){var t=e.expression.callInfo;if(!t)return C(e),!1;var r=P(t);return r.blockId&&!r.handlerStatement&&!t.isExpression&&xe(t,r)}return!1}function m(e){var t;e&&(t=e.type,o('<block type="'+we.U.htmlEscape(t)+'">'),l(e),void 0!==e.data&&o("<data>"+we.U.htmlEscape(e.data)+"</data>"),e.handlers&&e.handlers.forEach(h),e.next&&(o("<next>"),m(e.next),o("</next>")),void 0!==e.comment&&o('<comment pinned="false">'+we.U.htmlEscape(e.comment)+"</comment>"),o("</block>"))}function l(e){if(e.mutation){for(var t in o("<mutation ",""),e.mutation)o(t+'="'+e.mutation[t]+'" ',"");o("/>")}e.fields&&e.fields.forEach(p),e.inputs&&e.inputs.forEach(u)}function u(e){o('<value name="'+e.name+'">');var t=!1;if("expr"===e.value.kind){var r=e.value;if(!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"math_integer":case"math_whole_number":case"logic_boolean":case"text":t=!e.shadowType}}if(t)g(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case se:case oe:case le:o('<shadow type="'+e.shadowType+'"><field name="NUM">0</field></shadow>');break;case ce:o('<shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow>');break;case ue:o('<shadow type="text"><field name="TEXT"></field></shadow>');break;default:o('<shadow type="'+e.shadowType+'"/>')}g(e.value)}o("</value>")}function p(e){o('<field name="'+we.U.htmlEscape(e.name)+'">'+we.U.htmlEscape(e.value.toString())+"</field>")}function h(e){o('<statement name="'+we.U.htmlEscape(e.name)+'">'),m(e.statement),o("</statement>")}function g(e,t){if(void 0===t&&(t=!1),"text"===e.kind)o((r=e).value);else{var r=e,n=t||r.isShadow?"shadow":"block";o("<"+n+' type="'+we.U.htmlEscape(r.type)+'">'),l(r),o("</"+n+">")}}function B(e){if(ve(e,A))return f=b((d=e).getFullText(),d.getFullStart(),d.getEnd()).trim(),T(d),q(we.TS_OUTPUT_TYPE,"EXPRESSION",f);switch(e.kind){case ee.ExpressionStatement:case ee.ParenthesizedExpression:return B(e.expression);case ee.Identifier:return S(p=X(e),me.InBlocksOnly),q("variables_get","VAR",p);case ee.StringLiteral:case ee.FirstTemplateToken:case ee.NoSubstitutionTemplateLiteral:return v(e.text);case ee.NumericLiteral:return M(e.text);case ee.TrueKeyword:return k(!0);case ee.FalseKeyword:return k(!1);case ee.BinaryExpression:return function(e){var t=e.operatorToken.getText(),r=pe[t];if(l(e)){var n=[];!function e(t,r){l(t)?(e(t.left,r),e(t.right,r)):r.push(t)}(e,n);var a=D("text_join");a.mutation={items:n.length.toString()},a.inputs=[];for(var i=0;i<n.length;i++)a.inputs.push(O("ADD"+i,n[i],ue));return a}var s=D(r.type);s.fields=[],s.inputs=[],r.op&&s.fields.push(z("OP",r.op));var o="&&"===t||"||"===t?ce:se;return s.inputs.push(O(r.leftName||"A",e.left,o)),s.inputs.push(O(r.rightName||"B",e.right,o)),s;function l(e){if(e.kind===ee.BinaryExpression){var t=e;if("+"===t.operatorToken.getText()){var r=e.exprInfo;return!!r}}return!1}}(e);case ee.PrefixUnaryExpression:return function(e){switch(e.operator){case ee.ExclamationToken:var t=D("logic_negate");return t.inputs=[O("BOOL",e.operand,ce)],t;case ee.PlusToken:return B(e.operand);case ee.MinusToken:return e.operand.kind==ee.NumericLiteral?M("-"+e.operand.text):L(e.operand);default:C(e)}}(e);case ee.PropertyAccessExpression:return V(e);case ee.ArrayLiteralExpression:return u=e,(c=D("lists_create_with")).inputs=u.elements.map(function(e,t){return O("ADD"+t,e)}),c.mutation={items:u.elements.length.toString()},c;case ee.ElementAccessExpression:return o=e,(l=D("lists_index_get")).inputs=[O("LIST",o.expression),O("INDEX",o.argumentExpression,se)],l;case ee.TaggedTemplateExpression:return r=(t=e).callInfo,n=A.blocks.apis.byQName[P(r).blockIdentity],a=pxt.blocks.compileInfo(n),i=D(n.attributes.blockId),s=t.template.text,i.fields=[z(a.parameters[0].actualName,s)],i;case ee.CallExpression:return J(e,void 0,void 0,!0);default:C(e,we.Util.lf("Unsupported syntax kind for output expression block: {0}",ee[e.kind]))}var t,r,n,a,i,s,o,l,u,c,p,d,f}function b(n,a,e){if(r){var t=r.getRenamesInSpan(a,e);if(t.length){var i=0;t.forEach(function(e){var t=e.span.start+i-a,r=t+e.span.length;i+=e.diff,n=n.slice(0,t)+e.name+n.slice(r)})}}return n}function O(e,t,r){var n;if("expr"==(n="number"==typeof t?M(t.toString()):"boolean"==typeof t?k(t):"string"==typeof t?v(t):B(t)).kind&&"math_number"==n.type){var a=n.fields[0].value;"math_integer"==r&&a%1==0&&(n.type="math_integer"),"math_whole_number"==r&&a%1==0&&0<a&&(n.type="math_whole_number")}return R(e,n,r)}function M(e){return q("math_number","NUM",e)}function v(e){return q("text","TEXT",e)}function k(e){return q("logic_boolean","BOOL",e?"TRUE":"FALSE")}function q(e,t,r,n){var a=D(e);return a.fields=[z(t,r)],a.isShadow=n,a}function j(e,t){return R(e,q("variables_get_reporter","VAR",t,!0),"variables_get_reporter")}function z(e,t){return{kind:"field",name:e,value:t}}function L(e){var t=D("math_arithmetic");return t.inputs=[O("A",0,se),O("B",e,se)],t.fields=[z("OP","MINUS")],t}function V(e,t,r){void 0===t&&(t=!1);var n=e.callInfo;if(n){var a=P(n);if(a.blockCombine)return y(e,null,"@get@");if("lists_length"===a.blockId||"text_length"===a.blockId){var i=D(we.U.htmlEscape(a.blockId));return i.inputs=[O("VALUE",e.expression)],i}var s=we.U.htmlEscape(a.blockId||n.qName),o=ke(e)[0],l=o&&o.callInfo;if(t||!r&&!a.blockIdentity||l&&l.qName===a.blockIdentity)return{kind:"text",value:s};a.enumval&&l&&a.useEnumVal&&(s=a.enumval);var u=r?U.blocksById[r]:U.apis.byQName[a.blockIdentity],c=/%([a-zA-Z0-9_]+)/.exec(u.attributes.block),p=D(we.U.htmlEscape(u.attributes.blockId));return p.fields=[{kind:"field",name:we.U.htmlEscape(c[1]),value:s}],p}C(e)}function J(e,t,r,n,a){void 0===n&&(n=!1),void 0===a&&(a=!1);var i,s,o,l,u,c,p,d,f,m,h,g,b,v,k,y=e,x=he(y,A,n,a);if(x)i=G(y,void 0,x);else switch(y.kind){case ee.Block:return Y(y.statements,t,a);case ee.ExpressionStatement:return J(y.expression,t,r||y,n,a);case ee.VariableStatement:return Y(y.declarationList.declarations,t,!1,r||y);case ee.FunctionExpression:case ee.ArrowFunction:return b=t,J(y.body,b);case ee.BinaryExpression:i=function(e){switch(e.left.text,e.operatorToken.kind){case ee.EqualsToken:return e.left.kind===ee.Identifier?H(e.left,e.right):e.left.kind==ee.PropertyAccessExpression?W(e.left,e.right,"@set@"):(r=e.left,n=e.right,(a=$("lists_index_set")).inputs=[O("LIST",r.expression),O("INDEX",r.argumentExpression,se),O("VALUE",n)],a);case ee.PlusEqualsToken:return e.left.kind==ee.PropertyAccessExpression?W(e.left,e.right,"@change@"):H(e.left,e.right,!0);case ee.MinusEqualsToken:var t=$("variables_change");return F(),t.inputs=[R("VALUE",L(e.right),se)],t.fields=[z("VAR",X(e.left))],t;default:return void C(e,we.Util.lf("Unsupported operator token in statement {0}",ee[e.operatorToken.kind]))}var r,n,a}(y);break;case ee.PostfixUnaryExpression:case ee.PrefixUnaryExpression:i=function(e){var t=e.operator===ee.PlusPlusToken;if(t||e.operator===ee.MinusMinusToken)return H(e.operand,t?1:-1,!0);C(e)}(y);break;case ee.VariableDeclaration:var S=y;if(ge(S))return g=S,K.push([X(g.name),g]),I(r||y),T();i=function(e){if((t=e).name.kind!==ee.Identifier?(C(t,we.Util.lf("Variable declarations may not use binding patterns")),0):t.initializer||(C(t,we.Util.lf("Variable declarations must have an initializer")),0))return H(e.name,e.initializer);var t}(y);break;case ee.WhileStatement:m=y,(h=$("device_while")).inputs=[O("COND",m.expression,ce)],h.handlers=[{name:"DO",statement:J(m.statement)}],i=h;break;case ee.IfStatement:v=function e(t){var r={ifStatements:[{expression:t.expression,thenStatement:t.thenStatement}],elseStatement:t.elseStatement};if(t.elseStatement&&t.elseStatement.kind==ee.IfStatement){var n=e(t.elseStatement);r.ifStatements=r.ifStatements.concat(n.ifStatements),r.elseStatement=n.elseStatement}return r}(y),(k=$("controls_if")).mutation={elseif:(v.ifStatements.length-1).toString(),else:v.elseStatement?"1":"0"},k.inputs=[],k.handlers=[],v.ifStatements.forEach(function(e,t){k.inputs.push(O("IF"+t,e.expression,ce)),k.handlers.push({name:"DO"+t,statement:J(e.thenStatement)})}),v.elseStatement&&k.handlers.push({name:"ELSE",statement:J(v.elseStatement)}),i=k;break;case ee.ForStatement:i=function(e){var t,r=e.initializer,n=(r.declarations[0].name.text,e.condition),a=X(r.declarations[0].name);if(n.operatorToken.kind!==ee.LessThanToken||function e(t){return t.kind===ee.Identifier&&X(t)===a||Ee.forEachChild(t,e)}(e.statement))if((t=$("pxt_controls_for")).fields=[],t.inputs=[],t.handlers=[],t.inputs=[j("VAR",a)],n.operatorToken.kind===ee.LessThanToken){var i=D("math_arithmetic");i.fields=[z("OP","MINUS")],i.inputs=[O("A",n.right,se),O("B",1,se)],F(),t.inputs.push(R("TO",i,le))}else n.operatorToken.kind===ee.LessThanEqualsToken&&t.inputs.push(O("TO",n.right,le));else(t=$("controls_repeat_ext")).fields=[],t.inputs=[O("TIMES",n.right,le)],t.handlers=[];return t.handlers.push({name:"DO",statement:J(e.statement)}),t}(y);break;case ee.ForOfStatement:(p=(c=y).initializer).declarations[0].name.text,d=X(p.declarations[0].name),(f=$("controls_for_of")).inputs=[O("LIST",c.expression)],f.fields=[z("VAR",d)],f.handlers=[{name:"DO",statement:J(c.statement)}],i=f;break;case ee.FunctionDeclaration:o=X((s=y).name),l=J(s.body),(u=$("procedures_defnoreturn")).fields=[z("NAME",o)],u.handlers=[{name:"STACK",statement:l}],i=u;break;case ee.CallExpression:i=function(e,t){var I=e.callInfo,E=P(I);if("Math.pow"==I.qName){var r=D("math_arithmetic");return r.inputs=[R("A",B(e.arguments[0]),se),R("B",B(e.arguments[1]),se)],r.fields=[z("OP","POWER")],r}if(pxt.Util.startsWith(I.qName,"Math.")){var n=I.qName.substring(5);if(Ie(n)){var a=D("math_js_op");return a.inputs=I.args.map(function(e,t){return R("ARG"+t,B(e),"math_number")}),a.fields=[z("OP",n)],a.mutation={"op-type":2==I.args.length?"binary":"unary"},a}}if(E.blockId===we.PAUSE_UNTIL_TYPE){var i=$(we.PAUSE_UNTIL_TYPE),s=e.arguments[0],o=void 0;return o=s.body.kind===ee.Block?s.body.statements[0].expression:s.body,i.inputs=[R("PREDICATE",B(o),"logic_boolean")],i}if(!E.blockId||!E.block){var l=pxt.blocks.builtinFunctionInfo[I.qName];if(!l){var u=X(e.expression);if(A.declaredFunctions[u]){var c=$("procedures_callnoreturn");return c.mutation={name:u},c}return G(e)}E.blockId=l.blockId}if(E.imageLiteral)return function(e,t){var r=e.arguments[0];if(r.kind==ee.StringLiteral||r.kind==ee.NoSubstitutionTemplateLiteral){var n=P(t),a=$(n.blockId);a.fields=[];var i=(r.text||"").replace(/\s+/g,""),s=5*n.imageLiteral;if(5*s==i.length){for(var o="",l=0;l<5;++l){for(var u=0;u<s;++u)o+=/[#*1]/.test(i[l*s+u])?"#":".";o+="\n"}return a.fields.push(z("LEDS","`"+o+"`")),a}C(e,we.Util.lf("Invalid image pattern"))}else C(e)}(e,I);Ee.isFunctionLike(I.decl);var p=Te(I,A.blocks),d=A.blocks.apis.byQName[I.qName],w=pxt.blocks.compileInfo(d);F();var _={kind:t?"expr":"statement",type:E.blockId},K=function(e){return(_.inputs||(_.inputs=[])).push(e)},N=function(e){return(_.fields||(_.fields=[])).push(e)};"Math.max"==I.qName&&N({kind:"field",name:"op",value:"max"});var L=0;return p.forEach(function(e,t){var r,n=e.value,a=e.param,i=e.info;if(0===t&&E.defaultInstance){if(n.getText()===E.defaultInstance)return;_.mutation={showing:"true"}}if(!E.mutatePropertyEnum||t!==I.args.length-2){var s;if(a&&a.isOptional&&++L,a&&a.shadowBlockId&&(s=U.blocksById[a.shadowBlockId]),n.kind===ee.CallExpression){var o=n.callInfo;o&&"TD_ID"===P(o).shim&&(n=ye(o.args[0]))}switch(n.kind){case ee.FunctionExpression:case ee.ArrowFunction:var l=function(e){var t=be(e);if(t)return{callbackproperties:t[0].join(","),renamemap:we.Util.htmlEscape(JSON.stringify(t[1]))}}(n);if(l)_.mutation=l;else{var u=n,c=U.blocksById[E.blockId].parameters[w.thisParameter?t-1:t];if(u.parameters.length&&(E.optionalVariableArgs?(_.mutation={numargs:u.parameters.length.toString()},u.parameters.forEach(function(e,t){_.mutation["arg"+t]=e.name.text})):u.parameters.forEach(function(e,t){var r=c.handlerParameters[t];E.draggableParameters?K(j("HANDLER_DRAG_PARAM_"+r.name,e.name.text)):N(z("HANDLER_"+r.name,e.name.text))})),E.draggableParameters&&u.parameters.length<c.handlerParameters.length)for(var p=u.parameters.length;p<c.handlerParameters.length;p++){var d=c.handlerParameters[p];K(j("HANDLER_DRAG_PARAM_"+d.name,d.name))}}(_.handlers||(_.handlers=[])).push({name:"HANDLER",statement:J(n)});break;case ee.PropertyAccessExpression:var f=n.callInfo,m=we.U.htmlEscape(a.definitionName),h=P(f);s&&"TD_ID"===s.attributes.shim?K(R(m,V(n,!1,a.shadowBlockId),a.shadowBlockId)):i&&i.isEnum||f&&(h.fixedInstance||h.blockIdentity===I.qName)?N(z(m,V(n,!0).value)):K(O(m,n,a.shadowBlockId));break;case ee.BinaryExpression:if(a&&a.shadowOptions&&a.shadowOptions.toString){var g=n;if(g.operatorToken.kind===ee.PlusToken&&((r=g.left).kind===ee.StringLiteral||r.kind===ee.NoSubstitutionTemplateLiteral)&&""===r.text){K(O(we.U.htmlEscape(a.definitionName),g.right,a.shadowBlockId||"text"));break}}K(O(we.U.htmlEscape(a.definitionName),n,a.shadowBlockId));break;default:var b=void 0,v=we.U.htmlEscape(a.definitionName),k=!0;if("Math.random"==I.qName)b=R(v,function(e){switch(e.kind){case ee.NumericLiteral:var t=e;return M((parseInt(t.text)-1).toString());case ee.BinaryExpression:var r=e;if(r.operatorToken.kind==ee.PlusToken&&"1"==r.right.text)return F(),B(r.left);default:return B(e)}}(n),se),k=!1;else if(Se(n)){var y="text"==a.fieldEditor?n.text:n.getText(),x=a.shadowBlockId&&!function(e){switch(e){case se:case oe:case le:case ue:case ce:return!0;default:return!1}}(a.shadowBlockId);if(Z(a)&&a.fieldOptions.onParentBlock)return void N(z(v,y));if(x){var S=function(e){if(U.blocksById[e]){var t=pxt.blocks.compileInfo(U.blocksById[e]);if(!t.thisParameter&&1===t.parameters.length)return t.parameters[0]}}(a.shadowBlockId);if(S&&Z(S)){var T=q(a.shadowBlockId,S.definitionName,y,!0);a.shadowOptions&&(T.mutation={customfield:we.Util.htmlEscape(JSON.stringify(a.shadowOptions))}),b=R(v,T,a.shadowBlockId),k=!1}}}else if(n.kind===ee.TaggedTemplateExpression&&a.fieldOptions&&a.fieldOptions[Q.TaggedTemplate])return void N(z(v,we.Util.htmlEscape(n.getText())));k&&(b=O(v,n,a.shadowBlockId)),K(b)}}}),L&&(_.mutation||(_.mutation={}),_.mutation._expanded=L.toString()),_}(y,n);break;case ee.DebuggerStatement:i=$(we.TS_DEBUGGER_TYPE);break;default:return void C(y,t?we.Util.lf("Unsupported statement in block: {0}",ee[y.kind]):we.Util.lf("Statement kind unsupported in blocks: {0}",ee[y.kind]))}return i&&(i.next=T(),i.next&&(i.next.prev=i)),I(r||y),i;function T(){if(t&&t.length)return J(t.shift(),t,void 0,!1,a)}function I(e){var t=Ee.getLeadingCommentRangesOfNode(e,E);if(t){var r=[],n=function(e,t,r){for(var s="",o="",n=function e(t){var r=ke(t)[0];return!r||r.kind==ee.SourceFile||(r.kind==ee.ExpressionStatement?e(r):r.kind==ee.VariableDeclarationList&&e(r.parent))}(t),a=0,i=e;a<i.length;a++){var l=i[a],u=w.substr(l.pos,l.end-l.pos);if(u&&(u=u.replace(/\r\n/g,"\n")),l.kind===Ee.SyntaxKind.SingleLineCommentTrivia)f(u,1,3,de);else if(l.kind===Ee.SyntaxKind.MultiLineCommentTrivia&&n){for(var c=u.split("\n"),p=0;p<c.length;p++)f(c[p],p,c.length,fe);o&&(s+=o);var d=N();r&&r.push(d),_.push({text:s,refId:d}),o=s=""}else for(var c=u.split("\n"),p=0;p<c.length;p++)f(c[p],p,c.length,fe)}return(s+=o).trim();function f(e,t,r,n){var a=n.exec(e);if(a){var i=a[1].trim();if(i===we.ON_START_COMMENT||i===we.HANDLER_COMMENT)return;i?o+=o?" "+i:i:t&&t<r-1&&(s+=o+"\n",o="")}}}(t,y,r);i&&(r.length&&(i.data=r.join(";")),n&&i&&(i.comment=n))}}}function G(e,t,r){c.errorOnGreyBlocks&&C(e);var n=$(we.TS_STATEMENT_TYPE);n.mutation={},T(e);var a=e.getText();a=b(a,e.getStart(),e.getEnd()),t&&(a=t+a);var i=[];if(e.kind===ee.VariableStatement)for(var s=0,o=e.declarationList.declarations;s<o.length;s++){var l=o[s];i.push(X(l.name))}else e.kind===ee.VariableDeclaration&&i.push(X(e.name));i.length&&(n.mutation.declaredvars=i.join(","));var u=a.split("\n");return n.mutation.numlines=u.length.toString(),r&&c.includeGreyBlockMessages&&(n.mutation.error=we.U.htmlEscape(r)),u.forEach(function(e,t){n.mutation["line"+t]=we.U.htmlEscape(e)}),n}function H(e,t,r,n){void 0===r&&(r=!1),void 0===n&&(n=!1);var a=X(e);S(a,me.InBlocksOnly);var i=$(r?"variables_change":"variables_set");return i.inputs=[O("VALUE",t,se)],i.fields=[z("VAR",a)],i}function W(e,t,r){return y(e,t,r)}function y(e,t,r){var n=e.callInfo,a=A.blocks.apis.byQName[n?n.qName:""];if(a&&a.attributes.blockCombine){var i=a.namespace+"."+a.retType+"."+r,s=A.blocks.blocks.find(function(e){return e.qName==i}),o=t?$(s.attributes.blockId):D(s.attributes.blockId),l=s.attributes._def.parameters;return o.inputs=[O(l[0].name,e.expression)],o.fields=[z(l[1].name,n.qName)],t&&o.inputs.push(O(l[2].name,t)),o}C(e)}function Z(e){return e&&e.fieldOptions&&e.fieldOptions[Q.DecompileLiterals]}function Y(e,t,r,n,a){void 0===r&&(r=!1),void 0===a&&(a=!1);for(var i=[],s=t||[],o=e.length-1;0<=o;o--){var l=e[o];(l.kind===ee.FunctionDeclaration||l.kind==ee.ExpressionStatement&&f(l))&&!he(l,A,!1,r)?i.unshift(l):s.unshift(l)}if(i.map(function(e){return J(e,void 0,void 0,!1,r)}).forEach(m),s.length){var u=J(s.shift(),s,n,!1,r);if(a){var c=u;if(K.forEach(function(e){var t,r=e[0],n=e[1];d[r]!==me.InBlocksOnly&&(n.initializer,(t=d[r]===me.InTextBlocks?G(n,"let "):H(n.name,n.initializer,!1,!0)).next=c,c=t)}),c){var p=$(Ee.pxtc.ON_START_TYPE);return p.handlers=[{name:"HANDLER",statement:c}],p}x()}return u}a&&x()}function x(){c.alwaysEmitOnStart&&o('<block type="'+Ee.pxtc.ON_START_TYPE+'"></block>')}function S(e,t){d[e]!==me.InTextBlocks&&(d[e]=t)}function T(e){Ee.forEachChild(e,function(e){e.kind===ee.Identifier&&S(X(e),me.InTextBlocks),T(e)})}function X(e){if(r){var t=r.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}}})((we=Ee.pxtc||(Ee.pxtc={})).decompiler||(we.decompiler={}))}(ts||(ts={})),function(e){var $;(function(e){var t=function(e){function t(){var t=e.call(this)||this;return t.addEnc("$r0","R0-7",function(e){return t.inrange(7,e,e)}),t.addEnc("$r1","R0-7",function(e){return t.inrange(7,e,e<<3)}),t.addEnc("$r2","R0-15",function(e){return t.inrange(15,e,7&e|(8&e)<<4)}),t.addEnc("$r3","R0-15",function(e){return t.inrange(15,e,e<<3)}),t.addEnc("$r4","R0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$r5","R0-7",function(e){return t.inrange(7,e,e<<8)}),t.addEnc("$r01","R0-7",function(e){return t.inrange(7,e,e|e<<3)}),t.addEnc("$i0","#0-255",function(e){return t.inrange(255,e,e)}),t.addEnc("$i1","#0-1020",function(e){return t.inrange(255,e/4,e>>2)}),t.addEnc("$i2","#0-510",function(e){return t.inrange(127,e/4,e>>2)}),t.addEnc("$i3","#0-7",function(e){return t.inrange(7,e,e<<6)}),t.addEnc("$i4","#0-31",function(e){return t.inrange(31,e,e<<6)}),t.addEnc("$i5","#0-124",function(e){return t.inrange(31,e/4,e>>2<<6)}),t.addEnc("$i6","#1-32",function(e){return 0==e?null:32==e?0:t.inrange(31,e,e<<6)}),t.addEnc("$i7","#0-62",function(e){return t.inrange(31,e/2,e>>1<<6)}),t.addEnc("$i32","#0-2^32",function(e){return 1}),t.addEnc("$rl0","{R0-7,...}",function(e){return t.inrange(255,e,e)}),t.addEnc("$rl1","{LR,R0-7,...}",function(e){return 16384&e?t.inrange(255,-16385&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$rl2","{PC,R0-7,...}",function(e){return 32768&e?t.inrange(255,-32769&e,256|255&e):t.inrange(255,e,e)}),t.addEnc("$la","LABEL",function(e){return t.inrange(255,e/4,e>>2)}).isWordAligned=!0,t.addEnc("$lb","LABEL",function(e){return t.inrangeSigned(127,e/2,e>>1)}),t.addEnc("$lb11","LABEL",function(e){return t.inrangeSigned(1023,e/2,e>>1)}),t.addInst("adcs  $r0, $r1",16704,65472),t.addInst("add   $r2, $r3",17408,65280),t.addInst("add   $r5, pc, $i1",40960,63488),t.addInst("add   $r5, sp, $i1",43008,63488),t.addInst("add   sp, $i2",45056,65408).canBeShared=!0,t.addInst("adds  $r0, $r1, $i3",7168,65024),t.addInst("adds  $r0, $r1, $r4",6144,65024),t.addInst("adds  $r01, $r4",6144,65024),t.addInst("adds  $r5, $i0",12288,63488),t.addInst("adr   $r5, $la",40960,63488),t.addInst("ands  $r0, $r1",16384,65472),t.addInst("asrs  $r0, $r1",16640,65472),t.addInst("asrs  $r0, $r1, $i6",4096,63488),t.addInst("bics  $r0, $r1",17280,65472),t.addInst("bkpt  $i0",48640,65280),t.addInst("blx   $r3",18304,65415),t.addInst("bx    $r3",18176,65408),t.addInst("cmn   $r0, $r1",17088,65472),t.addInst("cmp   $r0, $r1",17024,65472),t.addInst("cmp   $r2, $r3",17664,65280),t.addInst("cmp   $r5, $i0",10240,63488),t.addInst("eors  $r0, $r1",16448,65472),t.addInst("ldmia $r5!, $rl0",51200,63488),t.addInst("ldmia $r5, $rl0",51200,63488),t.addInst("ldr   $r0, [$r1, $i5]",26624,63488),t.addInst("ldr   $r0, [$r1, $r4]",22528,65024),t.addInst("ldr   $r5, [pc, $i1]",18432,63488),t.addInst("ldr   $r5, $la",18432,63488),t.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,t.addInst("ldr   $r5, [sp]",38912,63488).canBeShared=!0,t.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),t.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),t.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),t.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),t.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),t.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),t.addInst("lsls  $r0, $r1",16512,65472),t.addInst("lsls  $r0, $r1, $i4",0,63488),t.addInst("lsrs  $r0, $r1",16576,65472),t.addInst("lsrs  $r0, $r1, $i6",2048,63488),t.addInst("mov   $r2, $r3",17920,65280),t.addInst("movs  $r0, $r1",0,65472),t.addInst("movs  $r5, $i0",8192,63488),t.addInst("muls  $r0, $r1",17216,65472),t.addInst("mvns  $r0, $r1",17344,65472),t.addInst("negs  $r0, $r1",16960,65472),t.addInst("nop",18112,65535),t.addInst("orrs  $r0, $r1",17152,65472),t.addInst("pop   $rl2",48128,65024),t.addInst("push  $rl1",46080,65024),t.addInst("rev   $r0, $r1",47616,65472),t.addInst("rev16 $r0, $r1",47680,65472),t.addInst("revsh $r0, $r1",47808,65472),t.addInst("rors  $r0, $r1",16832,65472),t.addInst("sbcs  $r0, $r1",16768,65472),t.addInst("sev",48960,65535),t.addInst("stm   $r5!, $rl0",49152,63488),t.addInst("stmia $r5!, $rl0",49152,63488),t.addInst("stmea $r5!, $rl0",49152,63488),t.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1]",24576,63488).canBeShared=!0,t.addInst("str   $r0, [$r1, $r4]",20480,65024),t.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,t.addInst("str   $r5, [sp]",36864,63488).canBeShared=!0,t.addInst("strb  $r0, [$r1, $i4]",28672,63488),t.addInst("strb  $r0, [$r1, $r4]",21504,65024),t.addInst("strh  $r0, [$r1, $i7]",32768,63488),t.addInst("strh  $r0, [$r1, $r4]",20992,65024),t.addInst("sub   sp, $i2",45184,65408),t.addInst("subs  $r0, $r1, $i3",7680,65024),t.addInst("subs  $r0, $r1, $r4",6656,65024),t.addInst("subs  $r01, $r4",6656,65024),t.addInst("subs  $r5, $i0",14336,63488),t.addInst("svc   $i0",57088,65280),t.addInst("sxtb  $r0, $r1",45632,65472),t.addInst("sxth  $r0, $r1",45568,65472),t.addInst("tst   $r0, $r1",16896,65472),t.addInst("udf   $i0",56832,65280),t.addInst("uxtb  $r0, $r1",45760,65472),t.addInst("uxth  $r0, $r1",45696,65472),t.addInst("wfe",48928,65535),t.addInst("wfi",48944,65535),t.addInst("yield",48912,65535),t.addInst("cpsid i",46706,65535),t.addInst("cpsie i",46690,65535),t.addInst("beq   $lb",53248,65280),t.addInst("bne   $lb",53504,65280),t.addInst("bcs   $lb",53760,65280),t.addInst("bcc   $lb",54016,65280),t.addInst("bmi   $lb",54272,65280),t.addInst("bpl   $lb",54528,65280),t.addInst("bvs   $lb",54784,65280),t.addInst("bvc   $lb",55040,65280),t.addInst("bhi   $lb",55296,65280),t.addInst("bls   $lb",55552,65280),t.addInst("bge   $lb",55808,65280),t.addInst("blt   $lb",56064,65280),t.addInst("bgt   $lb",56320,65280),t.addInst("ble   $lb",56576,65280),t.addInst("bhs   $lb",53760,65280),t.addInst("blo   $lb",54016,65280),t.addInst("b     $lb11",57344,63488),t.addInst("bal   $lb11",57344,63488),t.addInst("bl    $lb",61440,63488,!0),t.addInst("bb    $lb",57344,63488,!0),t.addInst("ldlit   $r5, $i32",18432,63488),t}return __extends(t,e),t.prototype.toFnPtr=function(e,t){return e+t|1},t.prototype.wordSize=function(){return 4},t.prototype.is32bit=function(e){return"bl"==e.name||"bb"==e.name},t.prototype.postProcessAbsAddress=function(e,t){return t&=4294967294,t-=e.baseOffset},t.prototype.emit32=function(e,t,r){if(t%2)return $.assembler.emitErr("uneven BL?",r);var n=t/2;if($.assert(null!=n),(0|n)!=n||!(-2097152<n&&n<2097152))return $.assembler.emitErr("jump out of range",r);var a=n>>11&1023;return{opcode:4026531840&n?62464|a:61440|a,opcode2:63488|2047&n,stack:0,numArgs:[t],labelName:r}},t.prototype.commonalize=function(e){if($.target.commonalize){for(var t=function(e){if("empty"==e.type)return!0;if("instruction"==e.type){var t=e.instruction;if(t&&t.canBeShared)return!0;switch(e.words[0]){case"pop":case"push":return!(-16&e.numArgs[0]);case"bl":switch(e.words[1]){case"_numops_fromInt":case"_pxt_incr":case"_pxt_decr":case"pxt::incr":case"pxt::decr":case"pxt::fromInt":return!0;default:return!1}default:return!1}}return!1},r=[],n={},a=-1,i=0;i<e.lines.length;++i)if("empty"!=(L=e.lines[i]).type)if(t(L))r.push(L);else{if("_js_end"==L.words[0]&&(a=i),2<r.length){for(var s="",o=0,l=r;o<l.length;o++){var u=l[o];"empty"!=u.type&&($.assert(!!u.instruction),$.assert(!!u.opcode),s&&(s+=","),"bl"==u.words[0]?s+="BL "+u.words[1]:s+=u.opcode)}n[s]?n[s].push(r):n[s]=[r]}r=[]}if(!(a<0)){for(var c=0,p=Object.keys(n);c<p.length;c++)if(1==(I=n[T=p[c]]).length&&3<I[0].length){for(var d=T.split(","),f=d.slice(),m=I[0].slice(),h=I[0].slice(),g=null,b="";3<=m.length;){d.pop(),m.pop(),h.shift(),f.shift();var v=n[b=d.join(",")];if(v&&v.length){g=m;break}if((v=n[b=f.join(",")])&&v.length){g=h;break}}g&&(n[T]=[],n[b].push(g))}for(var k=[],y=0,x=0,S=Object.keys(n);x<S.length;x++){var T,I;if(!((I=n[T=S[x]]).length<=1)){0==k.length&&(e.buildLine("; shared assembly fragments",k),e.buildLine("@nostackcheck",k),e.buildLine("_frag_start:",k));var E=0<=T.indexOf("BL"),w="_frag_"+ ++y;e.buildLine("; num.uses: "+I.length,k),e.buildLine(w+":",k),E&&e.buildLine("mov r7, lr",k);for(var _=0,K=0,N=I[0];K<N.length;K++){var L,U=(L=N[K]).text.replace(/;.*/,"");/@\d/.test(U)&&(U=".short "+L.opcode+" ; "+U),e.buildLine(U,k),_+=L.stack}e.buildLine(E?"bx r7":"bx lr",k);for(var A=0,C=I;A<C.length;A++){var P=C[A];P[0].update("bl "+w),P[1].update("@dummystack "+_);for(var F=2;F<P.length;++F)P[F].update("")}}}0<k.length&&(e.lines=e.lines.slice(0,a).concat(k).concat(e.lines.slice(a)))}}},t.prototype.expandLdlit=function(e){for(var t,r=!1,n=[],a={},i=1,s=0;s<e.lines.length;++s){var o=e.lines[s];if(n.push(o),"instruction"==o.type&&o.instruction&&"ldlit"==o.instruction.name){if(!t){for(var l=o.location+900,u=s+1;u<e.lines.length&&!(e.lines[u].location>l);++u){var c=e.lines[u].getOp();("b"==c||"bb"==c||"pop"==c&&"pc"==e.lines[u].words[2])&&(t=e.lines[u])}if(t)r=!1;else for(r=!0;--u>s;)if("instruction"==e.lines[u].type){t=e.lines[u];break}}var p=o.words[1],d=o.words[3];(b=$.U.lookup(a,d))||(b="_ldlit_"+ ++i,a[d]=b),o.update("ldr "+p+", "+b)}if(o===t){t=null;var f=[],m="_jmpwords_"+ ++i;r&&f.push("bb "+m),f.push(".balign 4");for(var h=0,g=Object.keys(a);h<g.length;h++){var b=a[d=g[h]];f.push(b+": .word "+d)}r&&f.push(m+":");for(var v=0,k=f;v<k.length;v++){var y=k[v];e.buildLine(y,n);var x=n[n.length-1];x.scope=o.scope,x.lineNo=o.lineNo}a={}}}e.lines=n},t.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var a=e.lookupLabel(r);if(null==a)return null;var i=e.location()+4;return n&&(i&=4294967292),a-i},t.prototype.isPop=function(e){return 48128==e},t.prototype.isPush=function(e){return 46080==e},t.prototype.isAddSP=function(e){return 45056==e},t.prototype.isSubSP=function(e){return 45184==e},t.prototype.peephole=function(e,t,r){var n=this.encoders.$lb11,a=this.encoders.$lb;function i(e,t){return null!=e.encode(t.numArgs[0]+8)&&null!=e.encode(t.numArgs[0]-8)&&null!=e.encode(t.numArgs[0])}var s,o,l,u,c=e.getOp(),p=!1;"bne"!=c&&"beq"!=c||("b"==t.getOp()&&0==e.numArgs[0]&&(p=!0),"bb"==t.getOp()&&2==e.numArgs[0]&&(p=!0)),"bb"==c&&i(n,e)?e.update("b "+e.words[1]):"b"==c&&-2==e.numArgs[0]?e.update(""):"bne"==c&&p&&i(a,t)?(e.update("beq "+t.words[1]),t.update("")):"beq"==c&&p&&i(a,t)?(e.update("bne "+t.words[1]),t.update("")):"push"==c&&16384==e.numArgs[0]&&"push"==t.getOp()?(e.update(t.text.replace("{","{lr, ")),t.update("")):"pop"==c&&"pop"==t.getOp()&&32768==t.numArgs[0]?(e.update(e.text.replace("}",", pc}")),t.update("")):"push"==c&&"pop"==t.getOp()&&e.numArgs[0]==t.numArgs[0]?($.assert(0<e.numArgs[0]),e.update(""),t.update("")):"push"==c&&"pop"==t.getOp()&&4==e.words.length&&4==t.words.length?($.assert("{"==e.words[1]),e.update("mov "+t.words[2]+", "+e.words[2]),t.update("")):r&&"movs $r5, $i0"==e.getOpExt()&&"mov $r0, $r1"==t.getOpExt()&&e.numArgs[0]==t.numArgs[1]&&(l=r,u=e.numArgs[0],"pop"==l.getOp()&&l.numArgs[0]&1<<u)?(e.update("movs r"+t.numArgs[0]+", #"+e.numArgs[1]),t.update("")):"pop"==c&&0<=d(e)&&"push"==t.getOp()&&d(e)==d(t)?(e.update("ldr r"+d(e)+", [sp, #0]"),t.update("")):r&&"push"==c&&0<=d(e)&&(s=t,o=d(e),"movs $r5, $i0"==s.getOpExt()&&s.numArgs[0]!=o)&&"pop"==r.getOp()&&d(e)==d(r)&&(e.update(""),r.update(""))},t.prototype.registerNo=function(e){if(!e)return null;switch(e=e.toLowerCase()){case"pc":e="r15";break;case"lr":e="r14";break;case"sp":e="r13"}var t=/^r(\d+)$/.exec(e);if(t){var r=parseInt(t[1],10);if(0<=r&&r<16)return r}return null},t.prototype.testAssembler=function(){$.assembler.expectError(this,"lsl r0, r0, #8"),$.assembler.expectError(this,"push {pc,lr}"),$.assembler.expectError(this,"push {r17}"),$.assembler.expectError(this,"mov r0, r1 foo"),$.assembler.expectError(this,"movs r14, #100"),$.assembler.expectError(this,"push {r0"),$.assembler.expectError(this,"push lr,r0}"),$.assembler.expectError(this,"pop {lr,r0}"),$.assembler.expectError(this,"b #+11"),$.assembler.expectError(this,"b #+102400"),$.assembler.expectError(this,"bne undefined_label"),$.assembler.expectError(this,".foobar"),$.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),$.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),$.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),$.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),$.assembler.expect(this,'6261      .string "abc"\n0063      \n'),$.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),$.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")},t}($.assembler.AbstractProcessor);function d(e){$.assert("push"==e.getOp()||"pop"==e.getOp());for(var t=0,r=-1,n=e.numArgs[0];0<n;)1&n&&(r=-1==r?t:-2),n>>=1,t++;return 0<=r?r:-1}e.ThumbProcessor=t})(($=e.pxtc||(e.pxtc={})).thumb||($.thumb={}))}(ts||(ts={})),function(e){var x;(function(d){var f,e,m=x.Util,r=m.assert;(e=f=d.EK||(d.EK={}))[e.None=0]="None",e[e.NumberLiteral=1]="NumberLiteral",e[e.PointerLiteral=2]="PointerLiteral",e[e.RuntimeCall=3]="RuntimeCall",e[e.ProcCall=4]="ProcCall",e[e.SharedRef=5]="SharedRef",e[e.SharedDef=6]="SharedDef",e[e.FieldAccess=7]="FieldAccess",e[e.Store=8]="Store",e[e.CellRef=9]="CellRef",e[e.Incr=10]="Incr",e[e.Decr=11]="Decr",e[e.Sequence=12]="Sequence",e[e.JmpValue=13]="JmpValue",e[e.Nop=14]="Nop";var i,t,l,n,a=0,s=function(){function e(){}return e.prototype.isExpr=function(){return!1},e.prototype.isStmt=function(){return!1},e.prototype.getId=function(){return this._id||(this._id=++a),this._id},e}(),h=function(a){function r(e,t,r){var n=a.call(this)||this;return n.exprKind=e,n.args=t,n.data=r,n.callingConvention=d.CallingConvention.Plain,n}return __extends(r,a),r.clone=function(e){var t=new r(e.exprKind,e.args.slice(0),e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t},r.prototype.isExpr=function(){return!0},r.prototype.isPure=function(){return this.isStateless()||this.exprKind==f.CellRef},r.prototype.isStateless=function(){switch(this.exprKind){case f.NumberLiteral:case f.PointerLiteral:case f.SharedRef:return!0;default:return!1}},r.prototype.sharingInfo=function(){var e=this;return this.exprKind!=f.SharedRef&&this.exprKind!=f.SharedDef||(e=this.args[0])||(e={currUses:"",totalUses:""}),e.currUses+"/"+e.totalUses},r.prototype.toString=function(){return u(this)},r.prototype.canUpdateCells=function(){switch(this.exprKind){case f.NumberLiteral:case f.PointerLiteral:case f.CellRef:case f.JmpValue:case f.SharedRef:case f.Nop:return!1;case f.SharedDef:case f.Incr:case f.Decr:case f.FieldAccess:return this.args[0].canUpdateCells();case f.RuntimeCall:case f.ProcCall:case f.Sequence:case f.Store:return!0;default:throw x.oops()}},r}(d.Node=s);d.Expr=h,(t=i=d.SK||(d.SK={}))[t.None=0]="None",t[t.Expr=1]="Expr",t[t.Label=2]="Label",t[t.Jmp=3]="Jmp",t[t.StackEmpty=4]="StackEmpty",t[t.Breakpoint=5]="Breakpoint",(n=l=d.JmpMode||(d.JmpMode={}))[n.Always=1]="Always",n[n.IfZero=2]="IfZero",n[n.IfNotZero=3]="IfNotZero",n[n.IfJmpValEq=4]="IfJmpValEq",n[n.IfLambda=5]="IfLambda";var o=function(n){function e(e,t){var r=n.call(this)||this;return r.stmtKind=e,r.expr=t,r}return __extends(e,n),e.prototype.isStmt=function(){return!0},e.prototype.toString=function(){return u(this)},e}(s);function u(e){return function e(t){if(t.isExpr()){var r=t,n=r.args?r.args[0]:null;switch(r.exprKind){case f.NumberLiteral:case f.PointerLiteral:return r.data+"";case f.CellRef:return r.data.toString();case f.JmpValue:return"JMPVALUE";case f.Nop:return"NOP";case f.SharedRef:return"SHARED_REF(#"+n.getId()+")";case f.SharedDef:return"SHARED_DEF(#"+n.getId()+": "+e(n)+")";case f.Incr:return"INCR("+e(n)+")";case f.Decr:return"DECR("+e(n)+")";case f.FieldAccess:return e(n)+"."+r.data.name;case f.RuntimeCall:return r.data+"("+r.args.map(e).join(", ")+")";case f.ProcCall:var a=r.data;return(null!=a.ifaceIndex?"IFACE@"+a.ifaceIndex:null!=a.virtualIndex?"VTABLE@"+a.virtualIndex:x.getDeclName(a.proc.action))+"("+r.args.map(e).join(", ")+")";case f.Sequence:return"("+r.args.map(e).join("; ")+")";case f.Store:return"{ "+e(r.args[0])+" := "+e(r.args[1])+" }";default:throw x.oops()}}else{var i=t,s=i.expr?e(i.expr):"{null}";switch(i.stmtKind){case d.SK.Expr:return"    "+s+"\n";case d.SK.Jmp:var o="goto "+i.lblName+"\n";switch(i.jmpMode){case l.Always:return i.expr?"    { JMPVALUE := "+s+" } "+o:"    "+o;case l.IfZero:return"    if (! "+s+") "+o;case l.IfNotZero:return"    if ("+s+") "+o;case l.IfJmpValEq:return"    if (r0 == "+s+") "+o;case l.IfLambda:return"    if (LAMBDA) return "+s;default:throw x.oops()}case d.SK.StackEmpty:return"    ;\n";case d.SK.Breakpoint:return"    // brk "+i.breakpointInfo.id+"\n";case d.SK.Label:return i.lblName+":\n";default:throw x.oops()}}}(e)}d.Stmt=o;var c=function(){function e(e,t,r){this.index=e,this.def=t,this.info=r,this.isarg=!1,this.iscap=!1,this._isRef=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.bitSize=0,t&&r&&x.setCellProps(this)}return e.prototype.getName=function(){return x.getDeclName(this.def)},e.prototype.getDebugInfo=function(){return{name:this.getName(),type:this._debugType,index:this.index}},e.prototype.toString=function(){var e="";return this.def&&(e+=this.getName()||"?"),this.isarg&&(e="ARG "+e),this.isRef()&&(e="REF "+e),"["+e+"]"},e.prototype.uniqueName=function(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+x.getNodeId(this.def)},e.prototype.refSuffix=function(){return this.isRef()?"Ref":""},e.prototype.isRef=function(){return this._isRef},e.prototype.isLocal=function(){return this._isLocal},e.prototype.isGlobal=function(){return this._isGlobal},e.prototype.loadCore=function(){return v(f.CellRef,null,this)},e.prototype.load=function(){var e=this.loadCore();return x.target.taggedInts&&0!=this.bitSize?6==this.bitSize?y("pxt::fromUInt",[e]):y("pxt::fromInt",[e]):this.isByRefLocal()?y("pxtrt::ldloc"+this.refSuffix(),[e]):this.refCountingHandledHere()?v(f.Incr,[e]):e},e.prototype.refCountingHandledHere=function(){return this.isRef()&&!this.isByRefLocal()},e.prototype.isByRefLocal=function(){return this.isLocal()&&this.info.captured&&this.info.written},e.prototype.storeDirect=function(e){return v(f.Store,[this.loadCore(),e])},e.prototype.storeByRef=function(e){if(this.isByRefLocal())return y("pxtrt::stloc"+this.refSuffix(),[this.loadCore(),e]);if(x.target.taggedInts&&0!=this.bitSize){e=k(e);var t=k(y(6==this.bitSize?"pxt::toUInt":"pxt::toInt",[e]));return v(f.Sequence,[t,v(f.Decr,[e]),this.storeDirect(t)])}if(this.refCountingHandledHere()){var r=k(e);return v(f.Sequence,[r,v(f.Decr,[this.loadCore()]),this.storeDirect(r)])}return this.storeDirect(e)},Object.defineProperty(e.prototype,"isTemporary",{get:function(){return!1},enumerable:!0,configurable:!0}),e}(),p=function(n){function a(e,t){var r=n.call(this,e,null,null)||this;return r.index=e,r.owningProc=t,r.uid=a.unnamedCellCounter++,r}return __extends(a,n),a.prototype.getName=function(){return"unnamed"+this.uid},a.prototype.uniqueName=function(){return this.getName()+"___U"+this.index},a.prototype.isByRefLocal=function(){return!1},Object.defineProperty(a.prototype,"isTemporary",{get:function(){return!0},enumerable:!0,configurable:!0}),a.unnamedCellCounter=0,a}(d.Cell=c);d.UnnamedCell=p;var g=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.numArgs=0,e.isRoot=!1,e.locals=[],e.captured=[],e.args=[],e.body=[],e.lblNo=0,e}return __extends(e,t),e.prototype.reset=function(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]},e.prototype.label=function(){return x.getFunctionLabel(this.action,this.bindings)},e.prototype.matches=function(e){if(this.action==e.action){m.assert(this.bindings.length==e.bindings.length,"this.bindings.length == id.bindings.length");for(var t=0;t<this.bindings.length;++t)if(this.bindings[t].isRef!=e.bindings[t].isRef)return!1;return!0}return!1},e.prototype.toString=function(){return"\nPROC "+x.getDeclName(this.action)+"\n"+this.body.map(function(e){return e.toString()}).join("")+"\n"},e.prototype.emit=function(e){this.body.push(e)},e.prototype.emitExpr=function(e){this.emit(b(i.Expr,e))},e.prototype.mkLabel=function(e){var t=b(i.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t},e.prototype.emitLbl=function(e){this.emit(e)},e.prototype.emitLblDirect=function(e){var t=b(i.Label,null);t.lblName=e,t.lbl=t,this.emit(t)},e.prototype.getName=function(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"},e.prototype.mkLocal=function(e,t){var r=new c(this.locals.length,e,t);return this.locals.push(r),r},e.prototype.mkLocalUnnamed=function(e){void 0===e&&(e=!1);var t=new p(this.locals.length,this);return t._isRef=e,this.locals.push(t),t},e.prototype.localIndex=function(t,e){return void 0===e&&(e=!1),this.captured.filter(function(e){return e.def==t})[0]||this.locals.filter(function(e){return e.def==t})[0]||(e?null:this.args.filter(function(e){return e.def==t})[0])},e.prototype.stackEmpty=function(){this.emit(b(i.StackEmpty,null))},e.prototype.emitClrIfRef=function(e){r(!e.isGlobal()&&!e.iscap,"!p.isGlobal() && !p.iscap"),(e.isRef()||e.isByRefLocal())&&this.emitExpr(v(f.Decr,[e.loadCore()]))},e.prototype.emitClrs=function(e,t){var r=this;this.isRoot||(this.locals.forEach(function(e){return r.emitClrIfRef(e)}),x.isStackMachine()&&this.args.some(function(e){return e.isRef()||e.isByRefLocal()})&&this.emitJmp(e,t,d.JmpMode.IfLambda),this.args.forEach(function(e){return r.emitClrIfRef(e)}))},e.prototype.emitJmpZ=function(e,t){this.emitJmp(e,t,l.IfZero)},e.prototype.emitJmp=function(e,t,r,n){void 0===r&&(r=l.Always),void 0===n&&(n=null);var a=b(i.Jmp,t);a.jmpMode=r,n&&n.exprKind==f.NumberLiteral&&(n=null),a.terminateExpr=n,"string"==typeof e?a.lblName=e:(a.lbl=e,a.lblName=a.lbl.lblName),this.emit(a)},e.prototype.resolve=function(){var e,n=function(e,t){if(e.args)for(var r=0;r<e.args.length;++r)e.args[r]=t(e.args[r])},a=function(e){switch(e.exprKind){case f.SharedDef:throw m.oops();case f.SharedRef:var t=e.args[0];if(t.totalUses)return t.totalUses--,e;t.totalUses=-1,t.currUses=0;var r=h.clone(e);return r.exprKind=f.SharedDef,r.args[0]=a(r.args[0]),r}return n(e,a),e},t=function(r){if(r.exprKind==f.SharedRef)return r;if(n(r,t),(r.exprKind==f.Decr||r.exprKind==f.Incr)&&function e(t){switch(t.exprKind){case d.EK.Sequence:return e(t.args[t.args.length-1]);case d.EK.NumberLiteral:return!0;case d.EK.RuntimeCall:switch(t.data){case"String_::mkEmpty":case"pxt::ptrOfLiteral":return!0;default:return!1}case d.EK.SharedDef:case d.EK.SharedRef:return e(t.args[0]);default:return!1}}(r.args[0]))return r.args[0];switch(r.exprKind){case f.Decr:if(r.args[0].exprKind==f.Incr)return r.args[0].args[0];break;case f.Sequence:r.args=r.args.filter(function(e,t){return t==r.args.length-1||!e.isPure()})}return r},r=function(e){switch(e.exprKind){case f.SharedDef:var t=e.args[0];if(m.assert(t.totalUses<0,"arg.totalUses < 0"),m.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return r(t);t.totalUses=1;break;case f.SharedRef:return m.assert(0<e.args[0].totalUses,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e}return n(e,r),e};this.body=this.body.filter(function(e){return!e.expr||(e.expr=t(a(e.expr)),e.stmtKind!=d.SK.Expr||!e.expr.isPure())});for(var i=m.toDictionary(this.body.filter(function(e){return e.stmtKind==d.SK.Label}),function(e){return e.lblName}),s=0;s<this.body.length;++s)this.body[s].stmtNo=s;for(var o=0,l=this.body;o<l.length;o++)switch((e=l[o]).expr&&(e.expr=r(e.expr)),e.stmtKind){case d.SK.Expr:break;case d.SK.Jmp:e.lbl=m.lookup(i,e.lblName),e.lbl||x.oops("missing label: "+e.lblName),e.lbl.lblNumUses?e.lbl.lblNumUses++:e.lbl.lblNumUses=1;break;case d.SK.StackEmpty:case d.SK.Label:case d.SK.Breakpoint:break;default:x.oops()}for(var u=[],c=0,p=this.body;c<p.length;c++)(e=p[c]).stmtKind==d.SK.Breakpoint&&(u[e.breakpointInfo.id]=e.breakpointInfo)},e}(s);function b(e,t){return new o(e,t)}function v(e,t,r){return new h(e,t,r)}function k(e){switch(e.exprKind){case f.NumberLiteral:case f.SharedRef:return e}return v(f.SharedRef,[e])}function y(e,t){return v(f.RuntimeCall,t,e)}d.Procedure=g,d.iterExpr=function e(t,r){if(r(t),t.args)for(var n=0,a=t.args;n<a.length;n++)e(a[n],r)},d.stmt=b,d.op=v,d.numlit=function(e){return v(f.NumberLiteral,null,e)},d.shared=k,d.ptrlit=function(e,t,r){void 0===r&&(r=!1);var n=v(f.PointerLiteral,null,e);if(n.jsInfo=t,r){if(x.target.isNative&&x.isAVR())return y("pxt::stringLiteral",[n]);n.args=[]}return n},d.rtcall=y,d.rtcallMask=function(e,r,t,n){var a=[];m.startsWith(e,"@nomask@")&&(e=e.slice(8),r=0),x.isStackMachine()?e+="^"+r:n=n.map(function(e,t){return r&1<<t&&(e=k(e),a.push(v(f.Decr,[e]))),e});var i=v(f.RuntimeCall,n,e);return i.callingConvention=t,0<a.length&&(i=k(i),a.unshift(i),a.push(i),i=v(f.Sequence,a)),i},d.flattenArgs=function(e){for(var t=!1,n=[],r=0,a=m.reversed(e.args);r<a.length;r++){var i=a[r];i.isStateless()||(i.exprKind!=f.CellRef||t)&&(i.canUpdateCells()&&(t=!0),n.push(i))}n.reverse(),x.isStackMachine()&&(n=[]);var s=[],o=e.args.map(function(e){if(0<=n.indexOf(e)){var t=e,r=e;return e.exprKind==f.SharedDef?(e.args[0].totalUses++,t=d.op(f.SharedRef,[e.args[0]])):(t=d.op(f.SharedRef,[e]),r=d.op(f.SharedDef,[e]),e.totalUses=2,e.currUses=0),s.push(r),t}return e});return{precomp:s,flattened:o}}})((x=e.pxtc||(e.pxtc={})).ir||(x.ir={}))}(ts||(ts={})),function(nr){!function(Qe){var et,e;function t(e){return e<<2|2}(e=et||(et={}))[e.Enum=0]="Enum",e[e.Number=1]="Number",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Unsupported=4]="Unsupported",Qe.taggedUndefined=0,Qe.taggedNull=t(1),Qe.taggedFalse=t(2),Qe.taggedTrue=t(16),Qe.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},Qe.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0};var tt=Qe.ir.EK;Qe.SK=nr.SyntaxKind,Qe.numReservedGlobals=1;var rt=0,nt=1;function at(e){var t=e;return t.pxtNodeWave!==nt&&(t.pxtNodeId=++rt,t.pxtNodeWave=nt),t.pxtNodeId}function it(e){return e?nr.SyntaxKind[e.kind]:"<null>"}function st(e,t,r){void 0===r&&(r=!1);var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&wt)return Tt||(Tt=t,Et=e),n;throw n}function ot(){return Qe.target.nativeType==Qe.NATIVE_TYPE_CS||!Qe.target.jsRefCounting&&!Qe.target.isNative}function lt(){return Qe.target.isNative&&Qe.target.nativeType==Qe.NATIVE_TYPE_AVRVM}function ut(){return Qe.target.isNative&&(Qe.target.nativeType==Qe.NATIVE_TYPE_AVRVM||Qe.target.nativeType==Qe.NATIVE_TYPE_AVR)}function ct(){return Qe.target.isNative&&Qe.target.nativeType==Qe.NATIVE_TYPE_THUMB}function a(e){return e.isThisType}function pt(e){if(u(e),ot())return!1;if(e.flags&nr.TypeFlags.Null)return!1;if(e.flags&nr.TypeFlags.Undefined)return!1;if(e.flags&nr.TypeFlags.TypeParameter){if(a(e))return!0;var t=A(e);if(t)return t.isRef;Qe.U.oops("unbound type parameter: "+St.typeToString(e))}if(e.flags&(nr.TypeFlags.NumberLike|nr.TypeFlags.Boolean|nr.TypeFlags.NumberLiteral|nr.TypeFlags.BooleanLiteral|nr.TypeFlags.Enum|nr.TypeFlags.EnumLike))return!!Qe.target.taggedInts;var r=e.getSymbol();if(r){var n=r.valueDeclaration||r.declarations[0];if(n)if(Nt(n).noRefCounting)return!1}return!0}function n(e){return!!e.isThisParameter}function dt(e){return!!n(e)||pt(Dt(e))}function ft(e){return Qe.target.taggedInts?Qe.ir.rtcall("pxt::fromInt",[e]):e}function mt(e){return Qe.target.taggedInts?Qe.ir.rtcall("pxt::fromBool",[e]):e}function ht(e){switch(e){case 0:return Qe.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw Qe.oops()}}function i(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw Qe.oops()}}function gt(e){switch(e.kind){case Qe.SK.TemplateHead:case Qe.SK.TemplateMiddle:case Qe.SK.TemplateTail:case Qe.SK.StringLiteral:case Qe.SK.NoSubstitutionTemplateLiteral:return!0;default:return!1}}function bt(e){return e.modifiers&&e.modifiers.some(function(e){return e.kind==Qe.SK.StaticKeyword})}function r(e){if(!e)return null;switch(e.kind){case Qe.SK.MethodDeclaration:return"";case Qe.SK.Constructor:return"new/";case Qe.SK.GetAccessor:return"get/";case Qe.SK.SetAccessor:return"set/";default:return null}}function vt(e){return r(e)+Lt(e)}function kt(e){return null!=r(e)}function yt(e){for(var t=e;;)switch((t=t.parent)||st(9229,It("cannot determine parent of {0}",it(e))),t.kind){case Qe.SK.MethodDeclaration:case Qe.SK.Constructor:case Qe.SK.GetAccessor:case Qe.SK.SetAccessor:case Qe.SK.FunctionDeclaration:case Qe.SK.ArrowFunction:case Qe.SK.FunctionExpression:return t;case Qe.SK.SourceFile:return null}}function s(e){return"objectFlags"in e}function xt(e){return!!e&&(e.kind==Qe.SK.VariableDeclaration&&!yt(e)||e.kind==Qe.SK.PropertyDeclaration&&bt(e))}Qe.getNodeId=at,Qe.stringKind=it,Qe.isStackMachine=lt,Qe.isAVR=ut,Qe.isThumb=ct,Qe.sizeOfBitSize=ht,Qe.isBitSizeSigned=i,Qe.setCellProps=function(e){var t;if(e._isRef=dt(e.def),e._isLocal=(t=e.def).kind==Qe.SK.VariableDeclaration&&!xt(t)||e.def.kind==Qe.SK.Parameter,e._isGlobal=xt(e.def),!n(e.def)){var r=Dt(e.def);r.flags&nr.TypeFlags.Void&&Qe.oops("void-typed variable, "+e.toString()),e.bitSize=function(e){if(!e||!e.type)return 0;if(!Qt(Dt(e)))return 0;if(e.type.kind!=Qe.SK.TypeReference)return 0;switch(e.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}}(e.def),0!=e.bitSize?e._debugType=(i(e.bitSize)?"int":"uint")+8*ht(e.bitSize):Xt(r)?e._debugType="string":r.flags&nr.TypeFlags.NumberLike&&(e._debugType="number")}e.isLocal()&&0!=e.bitSize&&(e.bitSize=0,st(9256,It("bit sizes are not supported for locals and parameters")))},Qe.isObjectType=s;var St,Tt,It=Qe.assembler.lf,Et=0,wt=0,_t=[];function o(e){e.kind==Qe.SK.VariableDeclaration&&(e=e.parent.parent);var t=function(e){var t=nr.getSourceFileOfNode(e),r=nr.getLeadingCommentRangesOfNode(e,t);return r?r.map(function(e){return t.text.slice(e.pos,e.end)}).join("\n"):""};return e.symbol&&1<e.symbol.declarations.length?e.symbol.declarations.map(t).join("\n"):t(e)}function Kt(e){for(var t="",r=0,n=e.declarations;r<n.length;r++){t+=o(n[r])}return Qe.parseCommentString(t)}function Nt(e){if(!e||e.isBogusFunction)return Qe.parseCommentString("");var t=e,r=t.pxtCommentAttrs;if(r)return r;var n=Qe.parseCommentString(o(t));return n._name=Lt(t),t.pxtCommentAttrs=n}function Lt(e){return e.name&&e.name.kind==Qe.SK.Identifier?e.name.text:"???"}function l(e){if(s(e)&&e.objectFlags&nr.ObjectFlags.Reference){var t=e;if(t.typeArguments&&t.typeArguments.length)return t.target}return null}function Ut(e){return!!s(e)&&(e.objectFlags&nr.ObjectFlags.Reference&&"Array"==e.symbol.name)}function At(e){return!!s(e)&&(!!(e.objectFlags&nr.ObjectFlags.Interface)||!!(e.objectFlags&nr.ObjectFlags.Anonymous))}function Ct(e){return!!a(e)||!!s(e)&&!!(e.objectFlags&nr.ObjectFlags.Class||e.symbol.flags&nr.SymbolFlags.Class)}function L(e){return null==U(e)&&(Ct(e)||At(e)||(t=e).symbol&&0!=(t.symbol.flags&(nr.SymbolFlags.ObjectLiteral|nr.SymbolFlags.TypeLiteral)));var t}function Pt(e){var t=l(e);return Ct(t||e)}function Ft(e){return Ut(e)?u(e.typeArguments[0]):null}function U(e){if(0<e.getApparentProperties().length||0<e.getConstructSignatures().length)return null;var t=St.getSignaturesOfType(e,nr.SignatureKind.Call);return t&&1==t.length?t[0]:null}function A(e){if(!(e.flags&nr.TypeFlags.TypeParameter))return null;for(var t=_t.length-1;0<=t;--t)if(_t[t].tp==e)return _t[t];return null}function $t(e){var t=l(e);return!!(t&&t.typeParameters&&t.typeParameters.length)}function u(e){var t=nr.TypeFlags.String|nr.TypeFlags.Number|nr.TypeFlags.Boolean|nr.TypeFlags.StringLiteral|nr.TypeFlags.NumberLiteral|nr.TypeFlags.BooleanLiteral|nr.TypeFlags.Void|nr.TypeFlags.Enum|nr.TypeFlags.EnumLiteral|nr.TypeFlags.Null|nr.TypeFlags.Undefined;if(0==(e.flags&t)){if(Ut(e))return e;if(Ct(e))return e;if(At(e))return e;if(U(e))return e;if(A(e))return e;if(c(e)!==et.Unsupported)return e;var r=l(e);if(r)return u(r),e.typeArguments.forEach(u),e;st(9201,It("unsupported type: {0} 0x{1}",St.typeToString(e),e.flags.toString(16)),!0)}return e}function Dt(e){var t;if(e.typeOverride)return e.typeOverride;if(nr.isExpression(e)&&(t=St.getContextualType(e)),!t)try{t=St.getTypeAtLocation(e)}catch(e){st(9203,It("Unknown type for expression"))}return t?u(t):t}function c(e){if(!(e.flags&nr.TypeFlags.Union))return et.Unsupported;var t,r=!0;return e.types.forEach(function(e){if(void 0===t)e.flags&nr.TypeFlags.NumberLike?t=et.Number:e.flags&nr.TypeFlags.BooleanLike?t=et.Boolean:e.flags&nr.TypeFlags.StringLike?t=et.String:e.flags&nr.TypeFlags.EnumLike&&(t=et.Enum);else switch(t){case et.Number:r=r&&!!(e.flags&nr.TypeFlags.NumberLike);break;case et.Boolean:r=r&&!!(e.flags&nr.TypeFlags.BooleanLike);break;case et.String:r=r&&!!(e.flags&nr.TypeFlags.StringLike);break;case et.Enum:r=r&&!!(e.flags&nr.TypeFlags.EnumLike)}}),r?t:et.Unsupported}function C(e,t){if(e==t)return!0;if(e.heritageClauses)for(var r=0,n=e.heritageClauses;r<n.length;r++){var a=n[r];switch(a.token){case Qe.SK.ExtendsKeyword:var i=Dt(a.types[0]);if(Ct(i))return C(i.symbol.valueDeclaration,t)}}return!1}function Rt(e,t){var r=t.kind?St.getTypeAtLocation(t):t,n=e.kind?St.getTypeAtLocation(e):e,a=nr.isExpression(t)?St.getContextualType(t):r;a||(a=r);var i=nr.isExpression(e)?St.getContextualType(e):n;if(i||(i=n),a&&i){a==i&&i!=n&&(i=n),P=[];var s=function d(f,r){function e(){var e=St.getPropertiesOfType(r),u=St.getPropertiesOfType(f),t=[!0,""],c=t[0],p=t[1];return e.forEach(function(t){var e,r,n=t.valueDeclaration,a=u.filter(function(e){return e.name==t.name});if(1==a.length){var i=a[0].valueDeclaration,s=d(St.getTypeAtLocation(i),St.getTypeAtLocation(n)),o=s[0],l=s[1];c&&!o&&(c=(e=[o,l])[0],p=e[1])}else 0==a.length&&(t.flags&nr.SymbolFlags.Optional||(r=[!1,"Property "+t.name+" not present in "+f.getSymbol().name],c=r[0],p=r[1]))}),F(a,[c,p])}var t=f.id;var n=r.id;var a=t+","+n;if(Bt[a])return Bt[a];if(-1!=P.indexOf(a))return[!0,""];P.push(a);if(r.flags&nr.TypeFlags.Any)return F(a,[!1,"Unsupported type: any."]);if(L(r)&&(i=f,!(L(i)||i.flags&(nr.TypeFlags.Null|nr.TypeFlags.Undefined))))return F(a,[!1,"Cast to class/interface not supported."]);var i;if(Ct(r)&&!$t(r)){if(Ct(f)&&!$t(f)){var s=r.symbol.valueDeclaration,o=f.symbol.valueDeclaration;return C(o,s)?e():C(s,o)?F(a,[!1,"Downcasts not supported."]):F(a,[!1,"Classes "+o.name.getText()+" and "+s.name.getText()+" are not related by inheritance."])}if(!(f.flags&(nr.TypeFlags.Undefined|nr.TypeFlags.Null)))return F(a,[!1,"Cast to class not supported."])}else if(U(r)){var l=U(r);if(U(f)){var u=U(f);Qe.U.assert(l.parameters.length>=u.parameters.length,"sup should have at least params of sub");for(var c=[!0,""],p=c[0],m=c[1],h=0;h<u.parameters.length;h++){var g=St.getTypeAtLocation(l.parameters[h].valueDeclaration),b=St.getTypeAtLocation(u.parameters[h].valueDeclaration),v=d(g,b),k=v[0],y=v[1];p&&!k&&(p=(K=[k,y])[0],m=K[1])}var x=l.getReturnType(),S=l.getReturnType(),T=d(S,x),I=T[0],E=T[1];return p&&!I&&(p=(N=[I,E])[0],m=N[1]),F(a,[p,m])}}else if(At(r)){if(L(f))return e()}else if(Ut(r)){if(Ut(f)){var w=Ft(r),_=Ft(f);return d(_,w)}}else A(r);return F(a,[!0,""]);var K,N}(i,a),o=s[0],l=s[1];o||st(9263,It(l))}}Qe.getComments=o,Qe.parseCommentsOnSymbol=Kt,Qe.parseComments=Nt,Qe.getName=Lt;var P=[],Bt={};function F(e,t){return Bt[e]=t,P.pop(),t}function Ot(e){return 0<Mt(e).length}function Mt(e){return e.typeParameters&&e.typeParameters.length?e.typeParameters:!kt(e)&&e.kind!=Qe.SK.MethodSignature||e.parent.kind!=Qe.SK.ClassDeclaration&&e.parent.kind!=Qe.SK.InterfaceDeclaration?[]:e.parent.typeParameters||[]}function qt(e){var t=St.getSignatureFromDeclaration(e);return!(St.getReturnTypeOfSignature(t).flags&nr.TypeFlags.Void)}function jt(e){var t,r=(t=e)&&t.name?e.name.text:null;return r||e.kind!=Qe.SK.Constructor||(r="constructor"),e&&e.parent&&e.parent.kind==Qe.SK.ClassDeclaration&&(r=e.parent.name.text+"."+r),r=r||"inline"}function zt(e){var t=l(e);return t&&t.typeParameters?Vt(t.typeParameters,e.typeArguments):[]}function Vt(e,r){return Qe.U.assert(e.length==r.length,"typeParameters.length == args.length"),e.map(function(e,t){return{tp:e,isRef:pt(r[t])}})}function Jt(e){var t=[];return Gt(t,e),t}function Gt(n,e){if(e)for(var t=yt(e);t;t=yt(t))for(var r=function(e){var t=St.getTypeAtLocation(e),r=_t.filter(function(e){return e.tp==t})[0];r||Qe.U.oops("cannot find binding for: "+St.typeToString(t)),n.push(r)},a=0,i=Mt(t);a<i.length;a++){r(i[a])}}function Ht(e){return e&&e.length?"_"+e.map(function(e){return e.isRef?"R":"P"}).join(""):""}function Wt(e,t){return jt(e).replace(/[^\w]+/g,"_")+"__P"+at(e)+Ht(t)}function Zt(e,t,r){return{kind:Qe.SK.MethodDeclaration,parameters:r?[r]:[],name:{kind:Qe.SK.Identifier,text:t,pos:0,end:0},body:{kind:Qe.SK.Block,statements:[]},parent:e.decl,pos:0,end:0,isBogusFunction:!0}}function Yt(e,t,r){return!!(e.flags&t)||c(e)===r}function Xt(e){return Yt(e,nr.TypeFlags.String|nr.TypeFlags.StringLiteral,et.String)}function Qt(e){return Yt(e,nr.TypeFlags.Number|nr.TypeFlags.NumberLiteral,et.Number)}function er(e){return Yt(e,nr.TypeFlags.Enum|nr.TypeFlags.EnumLiteral,et.Enum)||Qt(e)}Qe.getDeclName=jt,Qe.getFunctionLabel=Wt,Qe.compileBinary=function(r,n,h,q,t){Qe.target=h.target;var o=nr.createDiagnosticCollection();St=r.getTypeChecker();var u={},c={},k=[],a={},i={},s=[],T={},l=0,j={},p={},d=null;if(Bt={},rt=0,nt++,h.target.isNative){if(!h.hexinfo)return{diagnostics:[{file:r.getSourceFiles()[0],start:0,length:0,category:Qe.DiagnosticCategory.Error,code:9043,messageText:It("The hex file is not available, please connect to internet and try again.")}],emittedFiles:[],emitSkipped:!0};Qe.hex.setupFor(h.target,h.extinfo||Qe.emptyExtInfo(),h.hexinfo),Qe.hex.setupInlineAssembly(h)}else h.target.taggedInts=!1;var z,V=new tr;function e(){V.reset(),z=null,q.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}]}V.res=q,V.options=h,V.target=h.target,h.computeUsedSymbols&&(q.usedSymbols={},q.usedArguments={});var f=[];h.forceEmit&&0!=q.diagnostics.length||r.getSourceFiles().forEach(function(e){e.statements.forEach(function(e){f.push(e)})});var m=r.getSourceFiles().filter(function(e){return Qe.Util.endsWith(e.fileName,t)})[0],g={kind:Qe.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:Qe.SK.Block,statements:f},parent:m,pos:0,end:0,isRootFunction:!0,isBogusFunction:!0};if(X(g),k=[],e(),Ye(g),function(){var e=V.globals.slice(0);e.forEach(function(e,t){return e.index=t}),e.sort(function(e,t){return ht(e.bitSize)-ht(t.bitSize)||e.index-t.index});for(var t=4*Qe.numReservedGlobals,r=0,n=e;r<n.length;r++){for(var a=n[r],i=ht(a.bitSize);t&i-1;)t++;a.index=t,t+=i}V.globalsWords=t+3>>2}(),function(){for(var e in i)i[e].virtualParent=void 0,i[e].virtualIndex=void 0,i[e].virtualInstances=void 0;for(var t in u)u[t].methods=u[t].methods.filter(function(e){return G(e).isUsed});for(var t in u)u[t].baseClassInfo&&L(u[t])}(),function(){for(var e=0,t=V.usedClassInfos;e<t.length;e++){var r=t[e];N(r)}}(),0==o.getModificationCount()){e(),V.finalPass=!0,Ye(g),q.configData=[];for(var b=0,v=Object.keys(p);b<v.length;b++){var y=v[b];p["!"+y]||q.configData.push({name:y.replace(/^\!/,""),key:p[y].key,value:p[y].value})}He(g,function(){o.getModificationCount()||h.noEmit||!n||(V.writeFile=function(e,t){return n.writeFile(e,t,!1,null,r.getSourceFiles())},h.target.isNative?(h.extinfo.yotta&&V.writeFile("yotta.json",JSON.stringify(h.extinfo.yotta,null,2)),h.extinfo.platformio&&V.writeFile("platformio.json",JSON.stringify(h.extinfo.platformio,null,2)),h.target.nativeType==Qe.NATIVE_TYPE_CS?Qe.csEmit(V,h):h.target.nativeType==Qe.NATIVE_TYPE_AVRVM?Qe.vmEmit(V,h):Qe.processorEmit(V,h,q)):Qe.jsEmit(V))})}return{diagnostics:o.getDiagnostics(),emittedFiles:void 0,emitSkipped:!!h.noEmit};function x(e,t,r,n,a,i,s){o.add(nr.createDiagnosticForNode(t,{code:r,message:n,key:n.replace(/^[a-zA-Z]+/g,"_"),category:e},a,i,s))}function S(e,t,r,n,a,i){x(Qe.DiagnosticCategory.Error,e,t,r,n,a,i)}function J(e,t,r){if(void 0===r&&(r=9202),t)return st(r,t);e||st(r,It("Sorry, this language feature is not supported"));var n=it(e),a=!1,i=null;switch(e.kind){case nr.SyntaxKind.ForInStatement:n=It("for in loops");break;case nr.SyntaxKind.ForOfStatement:n=It("for of loops"),a=!0;break;case nr.SyntaxKind.PropertyAccessExpression:n=It("property access");break;case nr.SyntaxKind.DeleteExpression:n=It("delete");break;case nr.SyntaxKind.GetAccessor:n=It("get accessor method"),a=!0;break;case nr.SyntaxKind.SetAccessor:n=It("set accessor method"),a=!0;break;case nr.SyntaxKind.TaggedTemplateExpression:n=It("tagged templates");break;case nr.SyntaxKind.TypeOfExpression:n=It("typeof");break;case nr.SyntaxKind.SpreadElement:n=It("spread");break;case nr.SyntaxKind.TryStatement:case nr.SyntaxKind.CatchClause:case nr.SyntaxKind.FinallyKeyword:case nr.SyntaxKind.ThrowStatement:n=It("throwing and catching exceptions");break;case nr.SyntaxKind.ClassExpression:n=It("class expressions"),i=It("declare a class as class C {} not let C = class {}")}var s="";return s=a?It("{0} not currently supported",n):It("{0} not supported",nr.SyntaxKind[e.kind]),i&&(s+=" - "+i),st(r,s)}function I(e){return at(e)+""}function G(e){var t=I(e),r=i[t];return r||(i[t]=r={decl:e,capturedVars:[]}),r}function E(e){var t=at(e)+"",r=a[t];return r||(a[t]=r={}),r}function w(e,t){void 0===t&&(t=!1);var r=E(e);t&&(r.written=!0);var n=yt(e);if(null==n||n==z.action);else{for(var a=z.action;a&&a!=n;){var i=G(a);i.capturedVars.indexOf(e)<0&&i.capturedVars.push(e),a=yt(a)}r.captured=!0}}function H(e){var t=z,r=_t.slice();try{e()}finally{z=t,_t=r}}function W(e){var t=Qe.U.lookup(T,e);if(null!=t)return t;for(var r=0,n=V.usedClassInfos;r<n.length;r++)for(var a=n[r],i=0,s=a.methods;i<s.length;i++){var o=s[i];Lt(o)==e&&Y(o,a.bindings)}return t=T[e]=l++}function _(e){e||st(9203,It("variable has unknown type")),Dt(e).flags&nr.TypeFlags.Void&&st(9203,It("void-typed variables not supported"))}function K(t){if(xt(t)){X(t),_(t);var e=V.globals.filter(function(e){return e.def==t})[0];return e||(e=new Qe.ir.Cell(null,t,E(t)),V.globals.push(e)),e}var r=z.localIndex(t);return r||(V.finalPass?st(9204,It("cannot locate identifer")):r=z.mkLocal(t,E(t))),r}function N(x){if(Qe.assert(x.isUsed,"inf.isUsed"),x.vtable)return x.vtable;var S=x.baseClassInfo?N(x.baseClassInfo).slice(0):[];return H(function(){Qe.U.pushRange(_t,x.bindings);for(var e=0,t=x.methods;e<t.length;e++){var r=G(h=t[e]);if(r.virtualParent){var n=vt(h),a=!1,i=se(h,x.bindings);Qe.U.assert(!!i);for(var s=0;s<S.length;++s)vt(S[s].action)==n&&(S[s]=i,r.virtualIndex=s,a=!0);a||(r.virtualIndex=S.length,S.push(i))}}x.vtable=S,x.itable=[],x.itableInfo=[];for(var o=function(e,t){var r=W(e);x.itable[r]=t,x.itableInfo[r]=e,Qe.assert(!!t,"!!proc")},l=function(e,t){var r=se(e,x.bindings);r||H(function(){he(e,x.bindings),(r=se(e,x.bindings)).body=[],t(r)}),Qe.assert(!!r,"!!proc"),o(Lt(e),r)},u=function(e){var t=e,r=Lt(t),n="set/"+r;if(ue(r)){t.irGetter||(t.irGetter=Zt(x,r));var a=Te(x,t,Dt(t));l(t.irGetter,function(e){Fe(Qe.ir.op(tt.FieldAccess,[e.args[0].loadCore()],a))})}if(ue(n)){t.irSetter||(t.irSetter=Zt(x,n,{kind:Qe.SK.Parameter,name:{text:"v"},parent:t.irSetter,typeOverride:Dt(t),symbol:{}}));var i=Te(x,t,Dt(t));l(t.irSetter,function(e){var t=Qe.ir.op(tt.FieldAccess,[e.args[0].loadCore()],i);e.emitExpr(Qe.ir.op(tt.Store,[t,e.args[1].loadCore()]))})}},c=0,p=x.allfields;c<p.length;c++)u(p[c]);for(var d=x;d;d=d.baseClassInfo)for(var f=0,m=d.methods;f<m.length;f++){var h,g=Lt(h=m[f]);if(ue(g)){var b=W(g);x.itable[b]||o(g,se(h,d.bindings))}}for(s=0;s<x.itable.length;++s)x.itable[s]||(x.itable[s]=null);for(var v=0,k=Object.keys(T);v<k.length;v++){var y=k[v];x.itableInfo[T[y]]=y}}),x.vtable}function L(e){for(var t={},r=e.baseClassInfo;r;r=r.baseClassInfo)for(var n=0,a=r.methods;n<a.length;n++)t[vt(o=a[n])]=o;for(var i=0,s=e.methods;i<s.length;i++){var o=s[i],l=Qe.U.lookup(t,vt(o));if(l){var u=G(o),c=G(l);l.parameters.length!=o.parameters.length&&S(o,9255,It("the overriding method is currently required to have the same number of arguments as the base one")),(u.virtualParent=c).virtualParent||(c.virtualParent=c),Qe.assert(c.virtualParent==c,"pinf.virtualParent == pinf"),c.virtualInstances||(c.virtualInstances=[]),c.virtualInstances.push(u)}}}function U(e,a,i){void 0===a&&(a=null),void 0===i&&(i=null),a||(a=e.symbol.valueDeclaration),i||(i=e?zt(e):a.typeParameters?a.typeParameters.map(function(e){return{isRef:!0,tp:St.getTypeAtLocation(e),arg:St.getTypeAtLocation(e)}}):[]);var t="C"+at(a)+Ht(i),s=u[t];if(!s){var o=[],l=[];(s={id:t,numRefFields:0,allfields:[],attrs:Nt(a),decl:a,refmask:null,baseClassInfo:null,methods:[],bindings:i}).attrs.autoCreate&&(j[s.attrs.autoCreate]=!0),(u[t]=s).baseClassInfo=function(e){if(e.heritageClauses)for(var t=0,r=e.heritageClauses;t<r.length;t++){var n=r[t];switch(n.token){case Qe.SK.ExtendsKeyword:if(!n.types||1!=n.types.length)throw st(9228,It("invalid extends clause"));var a=Dt(n.types[0]);if(a&&Ct(a)&&!$t(a))return Rt(St.getTypeAtLocation(e),a),U(a);throw st(9228,It("cannot inherit from this type"));case Qe.SK.ImplementsKeyword:break;default:throw st(9228,It("invalid heritage clause"))}}return null}(a),H(function(){Qe.U.pushRange(_t,i);for(var e=0,t=a.members;e<t.length;e++){var r=t[e];if(r.kind==Qe.SK.PropertyDeclaration){var n=r;pt(Dt(n))?o.push(n):l.push(n),s.allfields.push(n)}else kt(r)&&r.kind!=Qe.SK.Constructor&&(G(r).parentClassInfo=s).methods.push(r)}s.baseClassInfo?(s.allfields=s.baseClassInfo.allfields.concat(s.allfields),s.numRefFields=-1,L(s)):(s.allfields=o.concat(l),s.numRefFields=o.length),s.refmask=s.allfields.map(function(e){return pt(Dt(e))})})}return s}function A(e){if(xt(e)&&e.parent.flags&nr.NodeFlags.Const){var t=e.initializer;return!!t&&t.kind!=Qe.SK.ArrayLiteralExpression&&!C(t)}return!1}function C(e){if(!e)return!1;if(gt(e))return!1;switch(e.kind){case Qe.SK.NullKeyword:case Qe.SK.NumericLiteral:case Qe.SK.TrueKeyword:case Qe.SK.FalseKeyword:return!1;case Qe.SK.Identifier:return!A(Q(e));case Qe.SK.PropertyAccessExpression:var t=Q(e);return!t||t.kind!=Qe.SK.EnumMember;case Qe.SK.ArrayLiteralExpression:return e.elements.some(C);default:return!0}}function P(e){if(xt(e)){if(Nt(e).shim)return re(e,e,[]);if(A(e))return We(e.initializer)}var t=K(e);return w(e),t.load()}function F(e){Nt(e).shim&&st(9207,It("built-in functions cannot be yet used as values; did you forget ()?")),Ot(e)&&st(9232,It("generic functions cannot be yet used as values; did you forget ()?"));var t=G(e);return t.location?t.location.load():(Qe.assert(!V.finalPass||0==t.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),me(e))}function Z(e){var t=function e(t){return t?kt(t)?t:e(t.parent):null}(e);t||st(9208,It("'this' used outside of a method"));var r=G(t);return r.thisParameter||Qe.oops("no this"),P(r.thisParameter)}function $(e){if(""==e)return Qe.ir.rtcall("String_::mkEmpty",[]);var t=V.emitString(e);return Qe.ir.ptrlit(t+"meta",JSON.stringify(e),!0)}function D(e){for(var t=function(e,t){return gt(r=t)&&""==r.text?e:Qe.ir.rtcallMask("String_::concat",3,Qe.ir.CallingConvention.Plain,[e,Be(t)]);var r},r=Be(e.head),n=0,a=e.templateSpans;n<a.length;n++){var i=a[n];r=t(r=t(r,i.expression),i.literal)}return r}function R(e){var t=Q(e);if((!t||t.kind==Qe.SK.PropertyDeclaration&&!bt(t)||t.kind==Qe.SK.PropertySignature||t.kind==Qe.SK.PropertyAssignment)&&(We(e.expression,!1),!t))return Qe.ir.numlit(0);if(t.kind==Qe.SK.GetAccessor)return ae(e,e,[],null);var r=Nt(t),n={decl:t,qName:Qe.getFullName(St,t.symbol),args:[],isExpression:!0};if(e.callInfo=n,t.kind==Qe.SK.EnumMember){var a=r.enumval;if(!a){var i=St.getConstantValue(t);if(null==i){if(t.initializer)return We(t.initializer);st(9210,It("Cannot compute enum value"))}a=i+""}return/^[+-]?\d+$/.test(a)?Ae(parseInt(a)):/^0x[A-Fa-f\d]{2,8}$/.test(a)?Ae(parseInt(a,16)):(Qe.U.userError("enumval only support number literals"),Qe.ir.rtcall(a,[]))}if(t.kind==Qe.SK.PropertySignature||t.kind==Qe.SK.PropertyAssignment)return ae(e,e,[],null,t,e.expression);if(t.kind==Qe.SK.PropertyDeclaration){if(bt(t))return P(t);var s=function(e){var t=Dt(e.expression);if(Pt(t)){var r=U(t);return Te(r,Ie(r,e.name.text),Dt(e))}throw J(e,It("bad field access"),9247)}(e);return n.args.push(e.expression),Qe.ir.op(tt.FieldAccess,[We(e.expression)],s)}if(kt(t)||t.kind==Qe.SK.MethodSignature)throw st(9211,It("cannot use method as lambda; did you forget '()' ?"));if(t.kind==Qe.SK.FunctionDeclaration)return F(t);if(t.kind==Qe.SK.VariableDeclaration)return P(t);throw J(e,It("Unknown property access for {0}",it(t)),9237)}function B(e,t){void 0===t&&(t=null);var r=Dt(e.expression),n={callingConvention:Qe.ir.CallingConvention.Plain,paramDefl:{}},a=null;if(!t&&Xt(r)?a="String_::charAt":Ut(r)?a=t?"Array_::setAt":"Array_::getAt":At(r)&&(n=Kt(r.symbol),a=t?n.indexerSet:n.indexerGet),a){if(Ce(e.argumentExpression))return Pe(a,[e.expression,e.argumentExpression],n,t?[t]:[]);throw J(e,It("non-numeric indexer on {0}",a),9238)}throw J(e,It("unsupported indexer"),9239)}function O(e){var t,r,n=!(!xt(r=e)||C(r.initializer)&&!Nt(r).whenUsed)||(t=e).kind==Qe.SK.FunctionDeclaration&&!yt(t)||kt(t);return!(h.testMode&&n&&!Qe.U.startsWith(nr.getSourceFileOfNode(e).fileName,"pxt_modules"))&&n}function M(e){return!O(e)||c.hasOwnProperty(I(e))}function Y(e,t){if(G(e).isUsed=!0,t&&t.length){var r=G(e);r.usages||(c[I(e)]=e,r.usages=[],r.prePassUsagesEmitted=0,h.computeUsedSymbols&&e&&e.symbol&&(q.usedSymbols[Qe.getFullName(St,e.symbol)]=null));var n=Ht(t);r.usages.some(function(e){return Ht(e)==n})||(r.usages.push(t),k.push(e))}else X(e)}function X(e){h.computeUsedSymbols&&e&&e.symbol&&(q.usedSymbols[Qe.getFullName(St,e.symbol)]=null),e&&!M(e)&&(c[I(e)]=e,k.push(e))}function Q(e){if(!e)return null;var t,r=St.getSymbolAtLocation(e);if(r&&!(t=r.valueDeclaration)&&r.declarations){var n=r.declarations[0];n&&n.kind==nr.SyntaxKind.ImportEqualsDeclaration&&(r=St.getSymbolAtLocation(n.moduleReference))&&(t=r.valueDeclaration)}return X(t),t}function ee(e){return e.kind==Qe.SK.NullKeyword||e.kind==Qe.SK.NumericLiteral?!!e.isRefOverride:!(!ut()&&gt(e))&&pt(Dt(e))}function te(e){Qe.assert(e.length<=8,"args.length <= 8");var r=0;return e.forEach(function(e,t){ee(e)&&(r|=1<<t)}),r}function re(e,t,r){var n,a,i,s=Nt(e),o=!(Dt(t).flags&nr.TypeFlags.Void),l=s.shim;if(h.target.needsUnboxing)switch(l){case"Number_::toString":case"Boolean_::toString":l="numops::toString"}if(0<=l.indexOf("(")){var u=/(.*)\((.*)\)$/.exec(l);if(u){r.length&&Qe.U.userError("no arguments expected");var c=[];if(u[2].replace(/\s/g,"")){for(var p=0,d=u[2].split(/,/);p<d.length;p++){var f=d[p],m=parseInt(f);isNaN(m)&&(null==(m=Le(t,f))&&(i=void 0,null==(i=Ne(n=t,a=f,"userconfig"))&&(i=Ne(n,a,"config")),m=i),null==m&&Qe.U.userError("invalid argument: "+f+" in "+l)),c.push(Qe.ir.numlit(m))}4<c.length&&Qe.U.userError("too many args")}return l=u[1],h.target.isNative&&Qe.hex.validateShim(jt(e),l,s,!0,c.map(function(e){return!0})),Qe.ir.rtcallMask(l,0,s.callingConvention,c)}}return"TD_NOOP"==l?(Qe.assert(!o,"!hasRet"),Ae(void 0)):"TD_ID"==l?(Qe.assert(1==r.length,"args.length == 1"),We(r[0])):(h.target.isNative&&Qe.hex.validateShim(jt(e),l,s,o,r.map(Ce)),Pe(l,r,s))}function ne(e,a,i){if(e){var t=e.getParameters(),r=a.length;t.length>a.length&&t.slice(a.length).forEach(function(e){if(e.valueDeclaration&&e.valueDeclaration.kind==Qe.SK.Parameter){var t=e.valueDeclaration;if(t.initializer)(function(e){switch(e.kind){case Qe.SK.NullKeyword:case Qe.SK.TrueKeyword:case Qe.SK.FalseKeyword:case Qe.SK.NumericLiteral:return!0;case Qe.SK.PropertyAccessExpression:return We(e).exprKind==tt.NumberLiteral;default:return!1}})(t.initializer)||st(9212,It("only numbers, null, true and false supported as default arguments")),a.push(t.initializer);else{var r=i.paramDefl[Lt(t)],n=r?Ae(parseInt(r)):null;null==n&&(n=Dt(t).flags&nr.TypeFlags.NumberLike?Ae(0):Ae(void 0)),a.push(xe(n))}}else st(9213,It("unsupported default argument (shouldn't happen)"))});for(var n=0;n<r;n++){var s=t[n];s&&s.valueDeclaration&&s.valueDeclaration.kind==Qe.SK.Parameter&&Rt(a[n],s.valueDeclaration)}i.imageLiteral&&(gt(a[0])||st(9214,It("Only image literals (string literals) supported here; {0}",it(a[0]))),a[0]=function(e){e||(e="0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n");var t=0,r=0,n=0,a="";e+="\n";for(var i=0;i<e.length;++i)switch(e[i]){case".":case"_":case"0":a+="0,",t++;break;case"#":case"*":case"1":a+="1,",t++;break;case"\t":case"\r":case" ":break;case"\n":t&&(0==r?r=t:t!=r&&st(9205,It("lines in image literal have to have the same width (got {0} and then {1} pixels)",r,t)),t=0,n++);break;default:st(9206,It("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var s="_img"+V.lblNo++;a.length%4!=0&&(a+="42"),V.otherLiterals.push("\n.balign 4\n"+s+": .short 0xffff\n        .short "+r+", "+n+"\n        .byte "+a+"\n");var o="new pxsim.Image("+r+", ["+a+"])";return{kind:Qe.SK.NumericLiteral,imageLiteral:s,jsLit:o}}(a[0].text))}}function ae(e,t,r,n,a,i){void 0===a&&(a=null),void 0===i&&(i=null),a||(a=Q(t));var s=!1;if(a)switch(a.kind){case Qe.SK.PropertySignature:case Qe.SK.PropertyAssignment:case Qe.SK.MethodDeclaration:case Qe.SK.MethodSignature:case Qe.SK.GetAccessor:case Qe.SK.SetAccessor:s=!0;break;case Qe.SK.ModuleDeclaration:case Qe.SK.FunctionDeclaration:break;default:a=null}var o=Nt(a),l=!(Dt(e).flags&nr.TypeFlags.Void),u=r.slice(0),c={decl:a,qName:a?Qe.getFullName(St,a.symbol):"?",args:u.slice(0),isExpression:l};e.callInfo=c,!s||i||bt(a)||t.kind!=Qe.SK.PropertyAccessExpression||(i=t.expression),0==c.args.length&&Qe.U.lookup(j,c.qName)&&(c.isAutoCreate=!0);var p=ce(n),d=0<p.length;if(Gt(p,a),q.usedArguments&&o.trackArgs){var f=i?[i].concat(u):u,m=o.trackArgs.map(function(e){return f[e]}).map(function(e){var t=Q(e);return!t||t.kind!=Qe.SK.EnumMember&&t.kind!=Qe.SK.VariableDeclaration?"*":Qe.getFullName(St,t.symbol)}).join(","),h=Qe.getFullName(St,a.symbol),g=q.usedArguments[h];g||(g=q.usedArguments[h]=[]),g.indexOf(m)<0&&g.push(m)}function b(){return oe(a,u.map(function(e){return We(e)}),p)}if(H(function(){Qe.U.pushRange(_t,p),ne(n,u,o)}),a&&a.kind==Qe.SK.FunctionDeclaration&&!(y=G(a)).location)return o.shim&&!ge(a)?re(a,e,u):(Y(a,p),b());if(t.kind==Qe.SK.SuperKeyword){var v=z.classInfo.baseClassInfo.ctor;Qe.assert(!V.finalPass||!!v,"!bin.finalPass || !!baseCtor");var k=u.map(function(e){return We(e)});return k.unshift(Z(t)),ie(v,null,k)}if(s){var y,x=!1;if(bt(a)||(i?(i.kind==Qe.SK.SuperKeyword&&(x=!0),u.unshift(i),c.args.unshift(i),p=zt(Dt(i)).concat(p)):J(e,It("strange method call"),9241)),(y=G(a)).virtualParent&&(y=y.virtualParent),!y.isUsed){y.isUsed=!0;for(var S=0,T=y.virtualInstances||[];S<T.length;S++){var I=T[S];I.parentClassInfo.isUsed&&Y(I.decl,p)}y.decl.kind==Qe.SK.MethodDeclaration&&Y(y.decl,p)}if(y.virtualParent&&!x)return Qe.U.assert(!V.finalPass||null!=y.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),ie(null,y.virtualIndex,u.map(function(e){return We(e)}));if(o.shim&&!ge(a))return re(a,e,u);if(o.helper){for(var E=void 0,w=0,_=St.getSymbolsInScope(e,nr.SymbolFlags.Module);w<_.length;w++){var K=_[w];if("helpers"==K.name)for(var N=0,L=K.declarations||[K.valueDeclaration];N<L.length;N++){var U=L[N];if(U.kind==Qe.SK.ModuleDeclaration)for(var A=0,C=U.body.statements;A<C.length;A++){var P=C[A];P.symbol.name==o.helper&&(E=P)}}}E||st(9215,It("helpers.{0} not found",o.helper)),E.kind!=Qe.SK.FunctionDeclaration&&st(9216,It("helpers.{0} isn't a function",o.helper)),a=E;var F=St.getSignatureFromDeclaration(a).getTypeParameters()||[];return F.length!=p.length&&Qe.U.oops("helpers type parameter mismatch"),p.forEach(function(e,t){e.tp=F[t]}),Y(a,p),b()}if(a.kind==Qe.SK.MethodSignature){var $=Lt(a);return ie(null,null,u.map(function(e){return We(e)}),W($))}if(a.kind!=Qe.SK.PropertySignature&&a.kind!=Qe.SK.PropertyAssignment)return Y(a,p),b();if(e==t){var D=Lt(a),R=ie(null,null,u.map(function(e){return We(e)}),W(D));if(a.kind==Qe.SK.PropertySignature||a.kind==Qe.SK.PropertyAssignment){var B=R.data;B.mapIdx=B.ifaceIndex;var O="";2==u.length?(ee(u[1])&&(O="Ref"),B.ifaceIndex=W("set/"+D),B.mapMethod="pxtrt::mapSet"+O):(pt(Dt(e))&&(O="Ref"),B.mapMethod="pxtrt::mapGet"+O)}return R}u.shift(),c.args.shift()}d&&Qe.U.oops("invalid generic call"),a&&a.kind==Qe.SK.ModuleDeclaration&&("String"==Lt(a)?st(9219,It('to convert X to string use: X + ""')):st(9220,It("namespaces cannot be called directly"))),u.length>(lt()?2:3)&&st(9217,It("lambda functions with more than 3 arguments not supported"));var M=u.length+"";return u.unshift(t),c.args.unshift(t),Qe.ir.rtcallMask("pxt::runAction"+M,te(u),Qe.ir.CallingConvention.Async,u.map(function(e){return We(e)}))}function ie(e,t,r,n){void 0===n&&(n=null);var a={proc:e,virtualIndex:t,ifaceIndex:n};return Qe.ir.op(tt.ProcCall,r,a)}function se(e,t){var r={action:e,bindings:t};return V.procs.filter(function(e){return e.matches(r)})[0]}function oe(e,t,r){var n=se(e,r);return Qe.assert(!!n||!V.finalPass,"!!proc || !bin.finalPass"),ie(n,null,t)}function le(e){return e.members.filter(function(e){return e.kind==Qe.SK.Constructor})[0]}function ue(e){return null!=Qe.U.lookup(T,e)}function ce(t){var e=[];if(t){var r=t.target,n=t.typeParameters||(r?r.typeParameters:null)||[];e=Vt(n,n.map(function(e){return t.mapper(e)}))}return e}function pe(e){var t=Dt(e);if(Ut(t))throw Qe.oops();if(Pt(t)){var r=Q(e.expression);r.kind!=Qe.SK.ClassDeclaration&&st(9221,It("new expression only supported on class types"));for(var n=void 0,a=U(Dt(e),r),i=a;i&&!(n=le(i.decl));i=i.baseClassInfo);!function e(t){if(!t.isUsed){t.isUsed=!0,t.baseClassInfo&&e(t.baseClassInfo),V.usedClassInfos.push(t);for(var r=0,n=t.methods;r<n.length;r++){var a=n[r],i=G(a);(ue(Lt(a))||i.virtualParent&&i.virtualParent.isUsed)&&Y(a,t.bindings)}var s=le(t.decl);s&&Y(s,t.bindings)}}(a);var s=a.id+"_VT",o=Qe.ir.rtcall("pxt::mkClassInstance",[Qe.ir.ptrlit(s,s)]);if(o=Qe.ir.shared(o),n){X(n);var l=e.arguments.slice(0),u=Nt(n),c=ce(St.getResolvedSignature(e));ne(St.getResolvedSignature(e),l,u);var p=l.map(function(e){return We(e)});return u.shim?(ot()||Qe.U.userError("shim=... on constructor not supported right now"),Qe.ir.rtcall(u.shim,p)):(p.unshift(Qe.ir.op(tt.Incr,[o])),z.emitExpr(oe(n,p,c)),o)}return e.arguments&&e.arguments.length&&st(9222,It("constructor with arguments not found")),o}throw J(e,It("unknown type for new"),9243)}function de(u){function s(e){return/^[0-9a-f]$/i.test(e)}var e=Q(u.tag);if(!e)throw J(u,It("invalid tagged template"),9265);var t,c=Nt(e),r={decl:e,qName:e?Qe.getFullName(St,e.symbol):"?",args:[u.template],isExpression:!0};function n(e){if(u.template.kind!=Qe.SK.NoSubstitutionTemplateLiteral)throw J(u,It("substitution not supported in hex literal",c.shim),9265);t=function(e){var t=d;"_"==e[0]&&"_"==e[1]&&h.jres[e]&&(t=h.jres[e],e=""),""==e&&t&&(t.dataEncoding&&"base64"!=t.dataEncoding?"hex"==t.dataEncoding?e=t.data:st(9271,It("invalid jres encoding '{0}' on '{1}'",t.dataEncoding,t.id)):e=Qe.U.toHex(Qe.U.stringToUint8Array(nr.pxtc.decodeBase64(t.data))));for(var r="",n=0;n<e.length;++n){var a=e[n];if(!s(a)){if(/^[\s\.]$/.test(a))continue;throw J(u,It("invalid character in hex literal '{0}'",a),9265)}s(e[n+1])&&(r+=a+e[n+1],n++)}var i=V.emitHexLiteral(r.toLowerCase());return Qe.ir.ptrlit(i,i,!0)}(e(u.template.text))}switch(u.callInfo=r,c.shim){case"@hex":n(function(e){return e});break;case"@f4":n(function(e){if(!Array.isArray(c.groups))throw J(u,It("missing groups in @f4 literal"),9272);var r=[],t=[],i={},n=0;c.groups.forEach(function(e,t){for(var r=0,n=e;r<n.length;r++){var a=n[r];i[a]=t}}),e+="\n";for(var a=0;a<e.length;++a){var s=e[a];switch(s){case" ":case"\t":break;case"\n":0<t.length&&(r.push(t),n=Math.max(t.length,n),t=[]);break;default:var o=Qe.U.lookup(i,s);if(null==o){if(2!=c.groups.length)throw J(u,It("invalid character in image literal: '{0}'",o),9273);o=1}t.push(o)}}var l=8;return c.groups.length<=2?l=1:c.groups.length<=16&&(l=4),Qe.f4EncodeImg(n,r.length,l,function(e,t){return r[t][e]||0})});break;default:throw J(u,It("invalid shim '{0}' on tagged template",c.shim),9265)}return c.helper&&(t=Qe.ir.rtcall(c.helper,[t])),t}function fe(e){var t=e.parameters.slice(0);if(!bt(e)&&kt(e)){var r=G(e);r.thisParameter||(r.thisParameter={kind:Qe.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),t.unshift(r.thisParameter)}return t}function me(e,t){void 0===t&&(t=!1);var r=Wt(e,Jt(e)),n=r;Qe.target.nativeType==Qe.NATIVE_TYPE_CS&&(n="(FnPtr)"+n,t||(n="PXT.pxt.mkAction(0, 0, "+n+")"));var a=Qe.ir.ptrlit(r+"_Lit",n,!ut()&&!t);return!t&&ut()&&(a=Qe.ir.shared(Qe.ir.rtcall("pxt::mkAction",[Qe.ir.numlit(0),Qe.ir.numlit(0),a]))),a}function he(e,t){var r=G(e),a=null,n=e.kind==Qe.SK.ArrowFunction||e.kind==Qe.SK.FunctionExpression,i=function(e){if(dt(e))return!0;var t=E(e);return t.captured&&t.written},s=r.capturedVars.filter(function(e){return i(e)}),o=r.capturedVars.filter(function(e){return!i(e)}),l=s.concat(o),u=l.map(function(e,t){var r=new Qe.ir.Cell(t,e,E(e));return r.iscap=!0,r});n&&Ot(e)&&st(9233,It("function expressions cannot be generic")),0<l.length&&Ot(e)&&st(9234,It("nested functions cannot be generic yet")),0<l.length?(Qe.assert(null!=yt(e),"getEnclosingFunction(node) != null)"),a=Qe.ir.shared(Qe.ir.rtcall("pxt::mkAction",[Qe.ir.numlit(s.length),Qe.ir.numlit(l.length),me(e,!0)])),l.forEach(function(e,t){var r=z.localIndex(e);r||st(9223,It("cannot find captured value: {0}",St.symbolToString(e.symbol)));var n=r.loadCore();(r.isRef()||r.isByRefLocal())&&(n=Qe.ir.op(tt.Incr,[n])),z.emitExpr(Qe.ir.rtcall("pxtrt::stclo",[a,Qe.ir.numlit(t),n]))}),e.kind==Qe.SK.FunctionDeclaration&&(r.location=z.mkLocal(e,E(e)),z.emitExpr(r.location.storeDirect(a)),a=null)):n&&(a=me(e)),Qe.assert(!!a==n,"!!lit == isExpression");var c={action:e,bindings:t},p=V.procs.filter(function(e){return e.matches(c)})[0];if(p?(z=p).reset():(Qe.assert(!V.finalPass,"!bin.finalPass"),(z=new Qe.ir.Procedure).isRoot=!!e.isRootFunction,z.action=e,z.info=r,z.bindings=t,V.addProc(z)),z.captured=u,e.parent.kind==Qe.SK.ClassDeclaration){var d=e.parent,f=d.typeParameters?d.typeParameters.length:0;Qe.assert(t.length>=f,"bindings.length >= numTP");var m=U(null,d,t.slice(0,f));z.classInfo?Qe.assert(z.classInfo==m,"proc.classInfo == classInfo"):z.classInfo=m,e.kind==Qe.SK.Constructor&&(m.ctor?Qe.assert(m.ctor==z,"classInfo.ctor == proc"):m.ctor=z)}Qe.U.pushRange(_t,t);var h=[];if(z.args=fe(e).map(function(e,t){e.name.kind===Qe.SK.ObjectBindingPattern&&h.push(e);var r=new Qe.ir.Cell(t,e,E(e));return r.isarg=!0,r}),z.args.forEach(function(e){if(e.isByRefLocal()){var t=Qe.ir.shared(Qe.ir.rtcall("pxtrt::mkloc"+e.refSuffix(),[]));z.emitExpr(Qe.ir.rtcall("pxtrt::stloc"+e.refSuffix(),[t,e.loadCore()])),z.emitExpr(e.storeDirect(t))}}),h.forEach(function(e){return Je(e)}),e.body.kind==Qe.SK.Block)Ye(e.body);else{var g=We(e.body);z.emitJmp(qe(e).ret,g,Qe.ir.JmpMode.Always)}z.emitLblDirect(qe(e).ret),z.stackEmpty();var b=z.mkLabel("final"),v=qt(z.action);for(v?(g=Qe.ir.shared(Qe.ir.op(tt.JmpValue,[])),z.emitExpr(g),z.emitClrs(b,g),z.emitJmp(b,g,Qe.ir.JmpMode.Always)):z.emitClrs(b,null),(v||lt())&&z.emitLbl(b),Qe.assert(!V.finalPass||0==k.length,"!bin.finalPass || usedWorkList.length == 0");0<k.length;)Ye(k.pop());return a}function ge(e){if(h.target.isNative)return!1;var t=e;return t.body&&(t.body.kind!=Qe.SK.Block||0<t.body.statements.length)}function be(r){if(M(r)){var e=Nt(r);if(null!=e.shim){if("@"==e.shim[0])return;if(h.target.isNative&&Qe.hex.validateShim(jt(r),e.shim,e,qt(r),fe(r).map(function(e){return rr(Dt(e))})),!ge(r))return}if(!nr.isInAmbientContext(r)&&r.body){var t=G(r),n=null;if(Ot(r)){t.usages||(Qe.assert(h.testMode&&!c[I(r)]&&!V.finalPass,"opts.testMode && !usedDecls[nodeKey(node)] && !bin.finalPass"),Gt(l=Qe.Util.toArray(Mt(r)).map(function(e){return{arg:St.getTypeAtLocation(e),tp:St.getTypeAtLocation(e),isRef:!0}}),r),Qe.U.assert(0<l.length,"bindings.length > 0"),t.usages=[l]),Qe.U.assert(0<t.usages.length,"no generic usages recorded");var a=t.usages;V.finalPass||(a=t.usages.slice(t.prePassUsagesEmitted),t.prePassUsagesEmitted=t.usages.length);for(var i=function(t){H(function(){var e=he(r,t);Qe.U.assert(null==e,"nolit == null")})},s=0,o=a;s<o.length;s++){var l;i(l=o[s])}}else H(function(){n=he(r,Jt(r))});return n}}}function ve(){}function ke(e){var t=e;t.needsIRCache=!0,s.push(t)}function ye(e,t){void 0===t&&(t=null);var r=s.length;return e.kind!=Qe.SK.PropertyAccessExpression&&e.kind!=Qe.SK.ElementAccessExpression||ke(e.expression),t&&ke(t),s.length==r?ve:function(){for(var e=r;e<s.length;++e)s[e].cachedIR=null,s[e].needsIRCache=!1;s.splice(r,s.length-r)}}function xe(e,t){return void 0===t&&(t=!1),{kind:Qe.SK.NullKeyword,isRefOverride:t,valueOverride:e}}function Se(e,t,r,n){void 0===n&&(n=null);var a=ye(e),i=n?We(n):Ae(1),s=Qe.ir.shared(We(e)),o=Qe.ir.shared(_e(t,s,i));Ee(e,xe(o,h.target.taggedInts)),a();var l=r?s:o;return h.target.taggedInts?Qe.ir.op(tt.Incr,[l]):l}function Te(e,t,r){var n=Nt(t);return{idx:e.allfields.indexOf(t),name:Lt(t),isRef:pt(r),shimName:n.shim}}function Ie(e,t){var r=e.allfields.filter(function(e){return e.name.text==t})[0];return r||st(9224,It("field {0} not found",t)),r}function Ee(e,t,r){void 0===r&&(r=!1),r&&Rt(t,e);var n=Q(e),a=xt(n);if(e.kind==Qe.SK.Identifier||a)if(n&&(a||n.kind==Qe.SK.VariableDeclaration||n.kind==Qe.SK.Parameter)){var i=K(n);w(n,!0),z.emitExpr(i.storeByRef(We(t)))}else J(e,It("bad target identifier"),9248);else if(e.kind==Qe.SK.PropertyAccessExpression){var s=Q(e);s&&s.kind==Qe.SK.GetAccessor?((s=nr.getDeclarationOfKind(s.symbol,Qe.SK.SetAccessor))||J(e,It("setter not available"),9253),z.emitExpr(ae(e,e,[t],null,s))):!s||s.kind!=Qe.SK.PropertySignature&&s.kind!=Qe.SK.PropertyAssignment?z.emitExpr(Qe.ir.op(tt.Store,[We(e),We(t)])):z.emitExpr(ae(e,e,[t],null,s))}else e.kind==Qe.SK.ElementAccessExpression?z.emitExpr(B(e,t)):J(e,It("bad assignment target"),9249)}function we(e){if(!h.target.floatingPoint){if(Qe.U.startsWith(e,"numops::")){var t=e.slice(8);return Qe.U.lookup(Qe.thumbArithmeticInstr,t)?"thumb::"+t:"lt_bool"==t?"Number_::lt":"Number_::"+t.replace(/eqq/,"eq")}switch(e){case"pxt::eq_bool":case"pxt::eqq_bool":case"langsupp::ptreq":case"langsupp::ptreqq":return"Number_::eq";case"langsupp::ptrneq":case"langsupp::ptrneqq":return"Number_::neq"}}if(h.target.taggedInts&&ct())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":case"numops::orrs":return"@nomask@"+e}return e}function _e(e,t,r){return e=we(e),Qe.ir.rtcallMask(e,h.target.taggedInts?3:0,Qe.ir.CallingConvention.Plain,[t,r])}function Ke(e){var t=Ue(We(e));if(void 0===t)throw st(9267,It("a constant number-like expression is required here"));return t}function Ne(e,t,r){var n=St.getSymbolsInScope(e,nr.SymbolFlags.Module).filter(function(e){return e.name==r&&!!e.valueDeclaration})[0];if(!n)return null;for(var a=0,i=n.valueDeclaration.body.statements;a<i.length;a++){var s=i[a];if(s.kind==Qe.SK.VariableStatement)for(var o=0,l=s.declarationList.declarations;o<l.length;o++){var u=l[o];if(u.symbol.name==t)return Ke(u.initializer)}}return null}function Le(e,t){var r=St.getSymbolsInScope(e,nr.SymbolFlags.Enum).filter(function(e){return"DAL"==e.name&&!!e.valueDeclaration})[0];if(!r)return null;var n=r.valueDeclaration.members.filter(function(e){return e.symbol.name==t})[0];return n?St.getConstantValue(n):null}function Ue(e){if(e.exprKind==Qe.ir.EK.NumberLiteral){var t=e.data;if(h.target.taggedInts){if(t==Qe.taggedNull||t==Qe.taggedUndefined||t==Qe.taggedFalse)return 0;if(t==Qe.taggedTrue)return 1;if("number"==typeof t)return t>>1}else if("number"==typeof t)return t}}function Ae(e){if(h.target.taggedInts){if(null===e)return Qe.ir.numlit(Qe.taggedNull);if(void 0===e)return Qe.ir.numlit(Qe.taggedUndefined);if(!1===e)return Qe.ir.numlit(Qe.taggedFalse);if(!0===e)return Qe.ir.numlit(Qe.taggedTrue);if("number"==typeof e){if(r=e,!Qe.target.boxDebug&&(0|r)==r&&-1073741824<=r&&r<=1073741823)return Qe.ir.numlit(e<<1|1);var t=V.emitDouble(e);return Qe.ir.ptrlit(t,JSON.stringify(e),!0)}throw Qe.U.oops("bad literal: "+e)}return h.target.floatingPoint||(!1!==e&&null!=e||(e=0),!0===e&&(e=1)),Qe.ir.numlit(e);var r}function Ce(e){if(e.kind==Qe.SK.NullKeyword){var t=e.valueOverride;if(void 0!==t)return t.exprKind==tt.NumberLiteral?!h.target.taggedInts||!!(1&t.data):t.exprKind==tt.RuntimeCall&&"pxt::ptrOfLiteral"==t.data?t.args[0].exprKind==tt.PointerLiteral&&!isNaN(parseFloat(t.args[0].jsInfo)):t.exprKind==tt.PointerLiteral&&!isNaN(parseFloat(t.jsInfo))}return e.kind==Qe.SK.NumericLiteral||rr(Dt(e))}function Pe(i,e,t,r){void 0===r&&(r=null);var s="",n=Qe.hex.lookupFunc(i);n&&(s=n.argsFmt),r&&(e=e.concat(r));var a,o,l=te(e),u=e.map(function(e,t){var r=We(e);if(!h.target.taggedInts)return r;var n=s.charAt(t+1),a=Ce(e);if(n){if("_"==n||"T"==n||"N"==n)return r;if("I"==n)return a||Qe.U.userError("argsFmt=...I... but argument not a number in "+i),r.exprKind==tt.NumberLiteral&&"number"==typeof r.data?Qe.ir.numlit(r.data>>1):(l&=~(1<<t),Qe.ir.rtcallMask("pxt::toInt",te([e]),Qe.ir.CallingConvention.Plain,[r]));if("B"==n)return l&=~(1<<t),Me(e,r);if("F"==n||"D"==n)return"D"==n&&Qe.U.oops("double arguments not yet supported"),a||Qe.U.userError("argsFmt=...F/D... but argument not a number in "+i),l&=~(1<<t),Qe.ir.rtcallMask("D"==n?"pxt::toDouble":"pxt::toFloat",te([e]),Qe.ir.CallingConvention.Plain,[r]);throw Qe.U.oops("invalid format specifier: "+n)}throw Qe.U.userError("not enough args for "+i)}),c=Qe.ir.rtcallMask(i,l,t.callingConvention,u);return h.target.taggedInts&&("I"==s.charAt(0)?c=ft(c):"B"==s.charAt(0)?c=mt(c):"F"==s.charAt(0)?(o=c,c=Qe.target.taggedInts?Qe.ir.rtcall("pxt::fromFloat",[o]):o):"D"==s.charAt(0)&&(Qe.U.oops("double returns not yet supported"),a=c,c=Qe.target.taggedInts?Qe.ir.rtcall("pxt::fromDouble",[a]):a)),c}function Fe(e){var t=z.mkLabel("ldjmp");z.emitJmp(t,e,Qe.ir.JmpMode.Always),z.emitLbl(t)}function $e(e){if(V.numStmts++,h.breakpoints){var t=nr.getSourceFileOfNode(e);if(!h.justMyCode||!Qe.U.startsWith(t.fileName,"pxt_modules")){for(var r=e.pos;/^\s$/.exec(t.text[r]);)r++;var n=nr.getLineAndCharacterOfPosition(t,r),a=nr.getLineAndCharacterOfPosition(t,e.end),i={id:q.breakpoints.length,isDebuggerStmt:e.kind==Qe.SK.DebuggerStatement,fileName:t.fileName,start:r,length:e.end-r,line:n.line,endLine:a.line,column:n.character,endColumn:a.character};q.breakpoints.push(i);var s=Qe.ir.stmt(Qe.ir.SK.Breakpoint,null);s.breakpointInfo=i,z.emit(s)}}}function De(e,t){switch(t){case Qe.SK.PlusToken:return"numops::adds";case Qe.SK.MinusToken:return"numops::subs";case Qe.SK.SlashToken:return h.warnDiv&&(r=e,n=9274,a="usage of / operator",x(Qe.DiagnosticCategory.Warning,r,n,a,i,s,o)),"numops::div";case Qe.SK.PercentToken:return"numops::mod";case Qe.SK.AsteriskToken:return"numops::muls";case Qe.SK.AsteriskAsteriskToken:return"Math_::pow";case Qe.SK.AmpersandToken:return"numops::ands";case Qe.SK.BarToken:return"numops::orrs";case Qe.SK.CaretToken:return"numops::eors";case Qe.SK.LessThanLessThanToken:return"numops::lsls";case Qe.SK.GreaterThanGreaterThanToken:return"numops::asrs";case Qe.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case Qe.SK.LessThanEqualsToken:return"numops::le";case Qe.SK.LessThanToken:return"numops::lt";case Qe.SK.GreaterThanEqualsToken:return"numops::ge";case Qe.SK.GreaterThanToken:return"numops::gt";case Qe.SK.EqualsEqualsToken:return"numops::eq";case Qe.SK.EqualsEqualsEqualsToken:return"numops::eqq";case Qe.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case Qe.SK.ExclamationEqualsToken:return"numops::neq";default:return null}var r,n,a,i,s,o}function Re(r){if(r.operatorToken.kind==Qe.SK.EqualsToken)return function(e){var t=ye(e.left,e.right);Ee(e.left,e.right,!0);var r=We(e.right);return t(),r}(r);var e=Dt(r.left),t=Dt(r.right);r.operatorToken.kind==Qe.SK.PlusToken&&(Xt(e)||Xt(t))&&(r.exprInfo={leftType:St.typeToString(e),rightType:St.typeToString(t)});var n=function(e){e=we(e);var t=[r.left,r.right];return Qe.ir.rtcallMask(e,te(t),Qe.ir.CallingConvention.Plain,t.map(function(e){return We(e)}))};if(r.operatorToken.kind==Qe.SK.CommaToken){if(je(r.left))return We(r.right);var a=ze(r.left);return Qe.ir.op(tt.Sequence,[a,We(r.right)])}switch(r.operatorToken.kind){case Qe.SK.BarBarToken:case Qe.SK.AmpersandAmpersandToken:return function(e){var t=We(e.left),r=Xt(Dt(e.left)),n=z.mkLabel("lazy");if(h.target.floatingPoint){t=Qe.ir.shared(t);var a=Qe.ir.rtcall("numops::toBool",[t]),i=z.mkLabel("lazySkip"),s=e.operatorToken.kind==Qe.SK.BarBarToken?Qe.ir.JmpMode.IfZero:e.operatorToken.kind==Qe.SK.AmpersandAmpersandToken?Qe.ir.JmpMode.IfNotZero:Qe.U.oops();z.emitJmp(i,a,s),z.emitJmp(n,t,Qe.ir.JmpMode.Always,t),z.emitLbl(i),ee(e.left)?z.emitExpr(Qe.ir.op(tt.Decr,[t])):z.emitExpr(Qe.ir.rtcall("langsupp::ignore",[t]))}else if(e.operatorToken.kind==Qe.SK.BarBarToken)r&&(t=Qe.ir.rtcall("pxtrt::emptyToNull",[t])),z.emitJmp(n,t,Qe.ir.JmpMode.IfNotZero);else if(e.operatorToken.kind==Qe.SK.AmpersandAmpersandToken)if(t=Qe.ir.shared(t),r){var o=z.mkLabel("lazyStr");z.emitJmp(o,Qe.ir.rtcall("pxtrt::emptyToNull",[t]),Qe.ir.JmpMode.IfNotZero),z.emitJmp(n,t,Qe.ir.JmpMode.Always,t),z.emitLbl(o),ee(e.left)?z.emitExpr(Qe.ir.op(tt.Decr,[t])):z.emitExpr(Qe.ir.rtcall("langsupp::ignore",[t]))}else ee(e.left)&&z.emitExpr(Qe.ir.op(tt.Decr,[t])),z.emitJmpZ(n,t);else Qe.oops();z.emitJmp(n,We(e.right),Qe.ir.JmpMode.Always),z.emitLbl(n);var l=Qe.ir.shared(Qe.ir.op(tt.JmpValue,[]));return z.emitExpr(l),l}(r)}if(er(e)&&er(t)){var i=function(e){switch(e){case Qe.SK.PlusEqualsToken:return Qe.SK.PlusToken;case Qe.SK.MinusEqualsToken:return Qe.SK.MinusToken;case Qe.SK.AsteriskEqualsToken:return Qe.SK.AsteriskToken;case Qe.SK.AsteriskAsteriskEqualsToken:return Qe.SK.AsteriskAsteriskToken;case Qe.SK.SlashEqualsToken:return Qe.SK.SlashToken;case Qe.SK.PercentEqualsToken:return Qe.SK.PercentToken;case Qe.SK.LessThanLessThanEqualsToken:return Qe.SK.LessThanLessThanToken;case Qe.SK.GreaterThanGreaterThanEqualsToken:return Qe.SK.GreaterThanGreaterThanToken;case Qe.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return Qe.SK.GreaterThanGreaterThanGreaterThanToken;case Qe.SK.AmpersandEqualsToken:return Qe.SK.AmpersandToken;case Qe.SK.BarEqualsToken:return Qe.SK.BarToken;case Qe.SK.CaretEqualsToken:return Qe.SK.CaretToken;default:return Qe.SK.Unknown}}(r.operatorToken.kind),s=De(r,i||r.operatorToken.kind);return s||J(r.operatorToken,It("unsupported numeric operator"),9250),i?Se(r.left,s,!1,r.right):n(s)}if(r.operatorToken.kind==Qe.SK.PlusToken&&(Xt(e)||Xt(t)))return Qe.ir.rtcallMask("String_::concat",3,Qe.ir.CallingConvention.Plain,[Be(r.left),Be(r.right)]);if(r.operatorToken.kind==Qe.SK.PlusEqualsToken&&Xt(e)){var o=ye(r.left),l=Qe.ir.shared(Qe.ir.rtcallMask("String_::concat",3,Qe.ir.CallingConvention.Plain,[We(r.left),Be(r.right)]));return Ee(r.left,xe(l)),o(),Qe.ir.op(tt.Incr,[l])}if(Xt(e)&&Xt(t))switch(r.operatorToken.kind){case Qe.SK.EqualsEqualsToken:case Qe.SK.EqualsEqualsEqualsToken:case Qe.SK.ExclamationEqualsEqualsToken:case Qe.SK.ExclamationEqualsToken:if(h.target.needsUnboxing)break;case Qe.SK.LessThanEqualsToken:case Qe.SK.LessThanToken:case Qe.SK.GreaterThanEqualsToken:case Qe.SK.GreaterThanToken:return Qe.ir.rtcallMask(we(De(r,r.operatorToken.kind)),h.target.boxDebug?1:0,Qe.ir.CallingConvention.Plain,[ft(n("String_::compare")),Ae(0)]);default:J(r.operatorToken,It("unknown string operator"),9251)}switch(r.operatorToken.kind){case Qe.SK.EqualsEqualsToken:return n("langsupp::ptreq");case Qe.SK.EqualsEqualsEqualsToken:return n("langsupp::ptreqq");case Qe.SK.ExclamationEqualsEqualsToken:return n("langsupp::ptrneqq");case Qe.SK.ExclamationEqualsToken:return n("langsupp::ptrneq");default:throw J(r.operatorToken,It("unknown generic operator"),9252)}}function Be(e){var t=We(e);if(gt(e))return t;var r=Dt(e);if(Qe.target.floatingPoint&&r.flags&(nr.TypeFlags.NumberLike|nr.TypeFlags.Boolean|nr.TypeFlags.BooleanLiteral))return Qe.ir.rtcallMask("numops::toString",1,Qe.ir.CallingConvention.Plain,[t]);if(r.flags&nr.TypeFlags.NumberLike)return Qe.ir.rtcall("Number_::toString",[t]);if(Yt(r,nr.TypeFlags.Boolean|nr.TypeFlags.BooleanLiteral,et.Boolean))return Qe.ir.rtcall("Boolean_::toString",[t]);if(Xt(r))return t;var n=r.symbol?r.symbol.valueDeclaration:null;if(n&&(n.kind==Qe.SK.ClassDeclaration||n.kind==Qe.SK.InterfaceDeclaration)){var a=n.members.filter(function(e){return(e.kind==Qe.SK.MethodDeclaration||e.kind==Qe.SK.MethodSignature)&&0==e.parameters.length&&"toString"==Lt(e)})[0];if(a)return ae(e,e,[],null,a,e);throw st(9254,It("type {0} lacks toString() method",Lt(n)))}throw st(9225,It("don't know how to convert to string"))}function Oe(e){if(e.flags&nr.NodeFlags.Let||e.flags&nr.NodeFlags.Const)return!0;throw st(9260,It("variable needs to be defined using 'let' instead of 'var'"))}function Me(e,t){if(void 0===t&&(t=null),!t&&h.target.taggedInts&&ct()&&e.kind==Qe.SK.BinaryExpression){var r=e,n=Dt(r.left),a=Dt(r.right);if(n.flags&nr.TypeFlags.NumberLike&&a.flags&nr.TypeFlags.NumberLike){var i=Qe.U.lookup(Qe.thumbCmpMap,De(r,r.operatorToken.kind));if(i)return Qe.ir.rtcall(i,[We(r.left),We(r.right)])}}return t||(t=We(e)),h.target.floatingPoint?Qe.ir.rtcall("numops::toBoolDecr",[t]):Xt(Dt(e))?Qe.ir.rtcall("pxtrt::stringToBool",[t]):ee(e)?Qe.ir.rtcall("pxtrt::ptrToBool",[t]):t}function qe(e){var t=at(e);return{fortop:".fortop."+t,cont:".cont."+t,brk:".brk."+t,ret:".ret."+t}}function je(e){if(!e)return!0;switch(e.kind){case Qe.SK.Identifier:case Qe.SK.StringLiteral:case Qe.SK.NumericLiteral:case Qe.SK.NullKeyword:return!0}return!1}function ze(e){var t=We(e),r=Dt(e);return r.flags&nr.TypeFlags.Void||pt(r)&&(t=Qe.ir.op(tt.Decr,[t])),t}function Ve(e){if(!je(e)){$e(e);var t=ze(e);z.emitExpr(t),z.stackEmpty()}}function Je(e){if(e.name.kind===Qe.SK.ObjectBindingPattern){if(!e.initializer)return e.name.elements.forEach(function(e){return Je(e)}),null;st(9259,"Object destructuring with initializers is not supported")}if(_(e),!M(e))return null;if(A(e))return null;var t=xt(e)?K(e):z.mkLocal(e,E(e));if(t.isByRefLocal()&&(z.emitClrIfRef(t),z.emitExpr(t.storeDirect(Qe.ir.rtcall("pxtrt::mkloc"+t.refSuffix(),[])))),e.kind===Qe.SK.BindingElement){$e(e);var r=function e(t){var r,n,a=t.parent.parent;if(a.kind===Qe.SK.BindingElement){var i=e(a);r=i[0],n=i[1]}else n=Dt(a);var s=t.propertyName||t.name;if(Pt(n)){var o=U(n);r=r||P(a);var l=St.getTypeOfSymbolAtLocation(St.getPropertyOfType(n,s.text),t);return[Qe.ir.op(tt.FieldAccess,[r],Te(o,Ie(o,s.text),l)),l]}throw J(t,It("bad field access"),9247)}(e);Rt(r[1],e),z.emitExpr(t.storeByRef(r[0])),z.stackEmpty()}else if(e.initializer){if($e(e),xt(e)){var n=Nt(e).jres;if(n){"true"==n&&(n=Qe.getFullName(St,e.symbol));var a=Qe.U.lookup(h.jres||{},n);a?d=a:st(9270,It("resource '{0}' not found in any .jres file",n))}}Rt(e.initializer,e),z.emitExpr(t.storeByRef(We(e.initializer))),d=null,z.stackEmpty()}return t}function Ge(e){!function(e,t){for(var r in t)t[r].decl.symbol==e.symbol&&st(9261,It("Interface with same name as a class not supported"));if(e.heritageClauses)for(var n=0,a=e.heritageClauses;n<a.length;n++){var i=a[n];switch(i.token){case Qe.SK.ExtendsKeyword:Ct(Dt(i.types[0]))&&st(9262,It("Extending a class by an interface not supported."))}}}(e,u);var t=Nt(e);t.autoCreate&&(j[t.autoCreate]=!0)}function He(t,e){var r=Tt;wt++;try{Tt=null;var n=e(t);return Tt&&st(Et,Tt),Tt=r,wt--,n}catch(e){return wt--,Tt=null,S(t,e.ksErrorCode||9200,e.message),null}}function We(e,t){void 0===t&&(t=!0);var r=e;if(t&&r.cachedIR)return ee(e)?Qe.ir.op(tt.Incr,[r.cachedIR]):r.cachedIR;var n=He(r,Ze)||Ae(void 0);return t&&r.needsIRCache?(r.cachedIR=Qe.ir.shared(n),r.cachedIR):n}function Ze(e){var t=function(e){switch(e.kind){case Qe.SK.NullKeyword:var t=e.valueOverride;return t||Ae(null);case Qe.SK.TrueKeyword:return Ae(!0);case Qe.SK.FalseKeyword:return Ae(!1);case Qe.SK.TemplateHead:case Qe.SK.TemplateMiddle:case Qe.SK.TemplateTail:case Qe.SK.NumericLiteral:case Qe.SK.StringLiteral:case Qe.SK.NoSubstitutionTemplateLiteral:return function(e){if(e.kind==Qe.SK.NumericLiteral){if(e.imageLiteral)return Qe.ir.ptrlit(e.imageLiteral,e.jsLit);var t=parseFloat(e.text);return h.target.floatingPoint||(Math.floor(t)!==t?st(9257,It("Decimal numbers are not supported")):t<<0!==t&&st(9258,It("Number is either too big or too small"))),Ae(t)}if(gt(e))return $(e.text);throw Qe.oops()}(e);case Qe.SK.TaggedTemplateExpression:return de(e);case Qe.SK.PropertyAccessExpression:return R(e);case Qe.SK.BinaryExpression:return Re(e);case Qe.SK.PrefixUnaryExpression:return function(e){var t=Dt(e.operand);if(e.operator==Qe.SK.ExclamationToken)return mt(Qe.ir.rtcall("Boolean_::bang",[Me(e.operand)]));if(Qt(t))switch(e.operator){case Qe.SK.PlusPlusToken:return Se(e.operand,"numops::adds",!1);case Qe.SK.MinusMinusToken:return Se(e.operand,"numops::subs",!1);case Qe.SK.MinusToken:return null!=(n=Ue(r=We(e.operand)))?Ae(-n):_e("numops::subs",Ae(0),r);case Qe.SK.PlusToken:return We(e.operand);case Qe.SK.TildeToken:var r,n;return null!=(n=Ue(r=We(e.operand)))?Ae(~n):Qe.ir.rtcallMask(we("numops::bnot"),1,Qe.ir.CallingConvention.Plain,[r])}throw J(e,It("unsupported prefix unary operation"),9245)}(e);case Qe.SK.PostfixUnaryExpression:return function(e){if(Qt(Dt(e.operand)))switch(e.operator){case Qe.SK.PlusPlusToken:return Se(e.operand,"numops::adds",!0);case Qe.SK.MinusMinusToken:return Se(e.operand,"numops::subs",!0)}throw J(e,It("unsupported postfix unary operation"),9246)}(e);case Qe.SK.ElementAccessExpression:return B(e);case Qe.SK.ParenthesizedExpression:return We(e.expression);case Qe.SK.TypeAssertionExpression:return Rt((o=e).expression,o),We(o.expression);case Qe.SK.ArrayLiteralExpression:return function(e){var t=Ft(Dt(e)),r=pt(t),n=0;Xt(t)?n=3:r&&(n=1);for(var a=Qe.ir.shared(Qe.ir.rtcall("Array_::mk",h.target.floatingPoint?[]:[Qe.ir.numlit(n)])),i=0,s=e.elements;i<s.length;i++){var o=s[i],l=Qe.ir.shared(We(o));z.emitExpr(Qe.ir.rtcall("Array_::push",[a,l])),r&&z.emitExpr(Qe.ir.op(tt.Decr,[l]))}return a}(e);case Qe.SK.NewExpression:return pe(e);case Qe.SK.SuperKeyword:case Qe.SK.ThisKeyword:return Z(e);case Qe.SK.CallExpression:return i=e,s=St.getResolvedSignature(i),ae(i,i.expression,i.arguments,s);case Qe.SK.FunctionExpression:case Qe.SK.ArrowFunction:return be(e);case Qe.SK.Identifier:return function(e){var t=Q(e);if(!t||t.kind!=Qe.SK.VariableDeclaration&&t.kind!=Qe.SK.Parameter&&t.kind!==Qe.SK.BindingElement){if(t&&t.kind==Qe.SK.FunctionDeclaration)return F(t);if("undefined"==e.text)return Ae(void 0);throw J(e,It("Unknown or undeclared identifier"),9235)}return P(t)}(e);case Qe.SK.ConditionalExpression:return function(e){var t=z.mkLabel("condexprz"),r=z.mkLabel("condexprfin");z.emitJmp(t,Me(e.condition),Qe.ir.JmpMode.IfZero),z.emitJmp(r,We(e.whenTrue),Qe.ir.JmpMode.Always),z.emitLbl(t),z.emitJmp(r,We(e.whenFalse),Qe.ir.JmpMode.Always),z.emitLbl(r);var n=Qe.ir.shared(Qe.ir.op(tt.JmpValue,[]));return z.emitExpr(n),n}(e);case Qe.SK.AsExpression:return Rt((n=e).expression,n),We(n.expression);case Qe.SK.TemplateExpression:return D(e);case Qe.SK.ObjectLiteralExpression:return r=e,a=Qe.ir.shared(Qe.ir.rtcall("pxtrt::mkMap",[])),r.properties.forEach(function(e){if(e.kind!=Qe.SK.ShorthandPropertyAssignment){var t="";ee(e.initializer)&&(t="Ref");var r=e.name.getText(),n=[Qe.ir.op(tt.Incr,[a]),Qe.ir.numlit(W(r)),We(e.initializer)];h.target.isNative||n.push($(r)),z.emitExpr(Qe.ir.rtcall("pxtrt::mapSet"+t,n))}else st(9264,"Shorthand properties not supported.")}),a;default:return J(e),null}var r,a,n,i,s,o}(e);if(t.isExpr())return t;throw new Error("expecting expression")}function Ye(e){He(e,Xe)}function Xe(e){switch(e.kind){case Qe.SK.SourceFile:return void e.statements.forEach(Ye);case Qe.SK.InterfaceDeclaration:return Ge(e);case Qe.SK.VariableStatement:return function(e){function t(e){var t=Qe.U.lookup(p,e.name);if(t||(p[(t=e).name]=t),t.value!=e.value)throw st(9269,It("conflicting values for config.{0}",e.name))}if(e.declarationList.flags&nr.NodeFlags.Const)for(var r=0,n=e.declarationList.declarations;r<n.length;r++){var a=n[r],i=jt(a),s=e.parent&&e.parent.kind==Qe.SK.ModuleBlock?Lt(e.parent.parent):"?";if("config"==s||"userconfig"==s){if(!a.initializer)continue;var o=Ke(a.initializer),l=Le(e,"CFG_"+i);if(null==l||0==l)throw st(9268,It("can't find DAL.CFG_{0}",i));"userconfig"==s&&(i="!"+i),t({name:i,key:l,value:o})}}nr.isInAmbientContext(e)||(Oe(e.declarationList),e.declarationList.declarations.forEach(Ye))}(e);case Qe.SK.ModuleDeclaration:return void Ye(e.body);case Qe.SK.EnumDeclaration:return;case Qe.SK.FunctionDeclaration:case Qe.SK.Constructor:case Qe.SK.MethodDeclaration:return void be(e);case Qe.SK.ExpressionStatement:return void Ve(e.expression);case Qe.SK.Block:case Qe.SK.ModuleBlock:return void e.statements.forEach(Ye);case Qe.SK.VariableDeclaration:return void Je(e);case Qe.SK.IfStatement:return function(e){$e(e);var t=z.mkLabel("else");z.emitJmpZ(t,Me(e.expression)),Ye(e.thenStatement);var r=z.mkLabel("afterif");z.emitJmp(r),z.emitLbl(t),e.elseStatement&&Ye(e.elseStatement),z.emitLbl(r)}(e);case Qe.SK.WhileStatement:return function(e){$e(e);var t=qe(e);z.emitLblDirect(t.cont),$e(e.expression),z.emitJmpZ(t.brk,Me(e.expression)),Ye(e.statement),z.emitJmp(t.cont),z.emitLblDirect(t.brk)}(e);case Qe.SK.DoStatement:return function(e){$e(e);var t=qe(e);z.emitLblDirect(t.cont),Ye(e.statement),$e(e.expression),z.emitJmpZ(t.brk,Me(e.expression)),z.emitJmp(t.cont),z.emitLblDirect(t.brk)}(e);case Qe.SK.ForStatement:return function(e){e.initializer&&e.initializer.kind==Qe.SK.VariableDeclarationList?(Oe(e.initializer),e.initializer.declarations.forEach(Ye)):Ve(e.initializer),$e(e);var t=qe(e);z.emitLblDirect(t.fortop),e.condition&&($e(e.condition),z.emitJmpZ(t.brk,Me(e.condition))),Ye(e.statement),z.emitLblDirect(t.cont),Ve(e.incrementor),z.emitJmp(t.fortop),z.emitLblDirect(t.brk)}(e);case Qe.SK.ForOfStatement:return function(e){if(e.initializer&&e.initializer.kind==Qe.SK.VariableDeclarationList){var t=e.initializer;if(1==t.declarations.length){Oe(t);var r=Dt(e.expression),n="",a="";if(Xt(r))n="String_::charAt",a="String_::length";else{if(!Ut(r))return void J(e.expression,"cannot use for...of with this expression");n="Array_::getAt",a="Array_::length"}X(t.declarations[0]);var i=Je(t.declarations[0]);z.emitExpr(i.storeByRef(Ae(void 0))),z.stackEmpty();var s=z.mkLocalUnnamed(!0);z.emitExpr(s.storeByRef(We(e.expression)));var o=z.mkLocalUnnamed(!!h.target.taggedInts);z.emitExpr(o.storeByRef(Ae(0))),z.stackEmpty(),$e(e);var l=qe(e);z.emitLblDirect(l.fortop);var u,c=Qe.ir.rtcall(a,[s.loadCore()]),p=_e("numops::lt_bool",o.load(),ft(c));z.emitJmpZ(l.brk,p),z.emitExpr(i.storeByRef(Qe.ir.rtcall(n,[s.loadCore(),(u=o.loadCore(),h.target.needsUnboxing?Qe.ir.rtcall("pxt::toInt",[u]):u)]))),Ye(e.statement),z.emitLblDirect(l.cont),z.emitExpr(o.storeByRef(_e("numops::adds",o.load(),Ae(1)))),z.emitJmp(l.fortop),z.emitLblDirect(l.brk),z.emitExpr(s.storeByRef(Ae(void 0)))}else J(e,"only a single variable may be used to iterate a collection")}else J(e,"only a single variable may be used to iterate a collection")}(e);case Qe.SK.ContinueStatement:case Qe.SK.BreakStatement:return function(e){$e(e);var r=e.label?e.label.text:null,n=e.kind==Qe.SK.BreakStatement,t=function e(t){return t?r&&t.kind==Qe.SK.LabeledStatement&&t.label.text==r?t.statement:t.kind==Qe.SK.SwitchStatement&&!r&&n?t:!r&&nr.isIterationStatement(t,!1)?t:e(t.parent):null}(e);if(t){var a=qe(t);e.kind==Qe.SK.ContinueStatement?nr.isIterationStatement(t,!1)?z.emitJmp(a.cont):S(e,9231,It("continue on non-loop")):e.kind==Qe.SK.BreakStatement?z.emitJmp(a.brk):Qe.oops()}else S(e,9230,It("cannot find outer loop"))}(e);case Qe.SK.LabeledStatement:return a=qe((n=e).statement),Ye(n.statement),void z.emitLblDirect(a.brk);case Qe.SK.ReturnStatement:return function(e){$e(e);var t=null;e.expression?t=We(e.expression):qt(z.action)&&(t=Ae(void 0)),z.emitJmp(qe(z.action).ret,t,Qe.ir.JmpMode.Always)}(e);case Qe.SK.ClassDeclaration:return U(null,r=e),void r.members.forEach(Ye);case Qe.SK.PropertyDeclaration:case Qe.SK.PropertyAssignment:return void(bt(t=e)?Je(t):t.initializer&&st(9209,It("class field initializers not supported")));case Qe.SK.SwitchStatement:return function(e){$e(e);var s,o=Dt(e.expression),t=!!(o.flags&nr.TypeFlags.NumberLike),r=qe(e),l=t,u=Qe.ir.shared(We(e.expression)),c=ee(e.expression)?"Decr":"",p=u;t&&Fe(u);var n=e.caseBlock.clauses.map(function(e){var t=z.mkLabel("switch");if(e.kind==Qe.SK.CaseClause){var r=e,n=We(r.expression),a=ee(r.expression)?1:0;if(h.target.needsUnboxing){var i=Qe.ir.rtcallMask(we("pxt::switch_eq"),a,Qe.ir.CallingConvention.Plain,[n,u]);l=!1,z.emitJmp(t,i,Qe.ir.JmpMode.IfNotZero,p)}else Xt(o)?(i=Qe.ir.rtcallMask("String_::compare"+c,a,Qe.ir.CallingConvention.Plain,[n,u]),z.emitJmp(t,i,Qe.ir.JmpMode.IfZero,p)):ee(r.expression)||c?(i=Qe.ir.rtcallMask(we("langsupp::ptreq")+c,3,Qe.ir.CallingConvention.Plain,[n,u]),l=!1,z.emitJmp(t,i,Qe.ir.JmpMode.IfNotZero,p)):lt()||h.target.needsUnboxing||n.exprKind!=tt.NumberLiteral?(i=_e("pxt::eq_bool",n,u),l=!1,z.emitJmp(t,i,Qe.ir.JmpMode.IfNotZero,p)):(l||(Fe(u),l=!0),z.emitJmp(t,n,Qe.ir.JmpMode.IfJmpValEq,p))}else e.kind==Qe.SK.DefaultClause?(Qe.assert(!s,"!defaultLabel"),s=t):Qe.oops();return t});(h.target.taggedInts||c)&&z.emitExpr(Qe.ir.op(tt.Decr,[u])),s?z.emitJmp(s,p):z.emitJmp(r.brk,p),e.caseBlock.clauses.forEach(function(e,t){z.emitLbl(n[t]),e.statements.forEach(Ye)}),z.emitLblDirect(r.brk)}(e);case Qe.SK.TypeAliasDeclaration:return;case Qe.SK.DebuggerStatement:return void $e(e);case Qe.SK.GetAccessor:case Qe.SK.SetAccessor:return void be(e);case Qe.SK.ImportEqualsDeclaration:case Qe.SK.EmptyStatement:return;default:J(e)}var t,r,n,a}};var tr=function(){function e(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=function(e,t){},this.usedClassInfos=[],this.sourceHash="",this.numStmts=1,this.commSize=0,this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}return e.prototype.reset=function(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={},this.numStmts=0},e.prototype.addProc=function(e){Qe.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length},e.prototype.emitLabelled=function(e,t,r){var n=Qe.U.lookup(t,e);if(null!=n)return n;var a=r+this.lblNo++;return t[e]=a},e.prototype.emitDouble=function(e){return this.emitLabelled((t=e,(r=new Float64Array(1))[0]=t,Qe.U.toHex(new Uint8Array(r.buffer))),this.doubles,"_dbl");var t,r},e.prototype.emitString=function(e){return this.emitLabelled(e,this.strings,"_str")},e.prototype.emitHexLiteral=function(e){return this.emitLabelled(e,this.hexlits,"_hexlit")},e}();function rr(e){return!!(e.flags&(nr.TypeFlags.NumberLike|nr.TypeFlags.EnumLike))}Qe.Binary=tr}(nr.pxtc||(nr.pxtc={}))}(ts||(ts={})),function(S){!function(v){function k(e){var t=S.getDefaultCompilerOptions();return t.target=S.ScriptTarget.ES5,t.module=S.ModuleKind.None,t.noImplicitAny=!0,t.noImplicitReturns=!0,t.allowUnreachableCode=!0,t}function y(e,t){void 0===t&&(t=!1),t&&(e=e.filter(function(e){return 5012!==e.code}));var r=e.filter(function(e){return 1148==e.code});return 0<r.length&&(e=r),e.map(function(e){if(!e.file)return{code:e.code,start:e.start,length:e.length,line:0,column:0,messageText:e.messageText,category:e.category,fileName:"?"};var t=S.getLineAndCharacterOfPosition(e.file,e.start),r={code:e.code,start:e.start,length:e.length,line:t.line,column:t.character,messageText:e.messageText,category:e.category,fileName:e.file.fileName};return 1148==r.code&&(r.messageText=v.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),r})}function o(e){var t=Date.now(),a={outfiles:{},diagnostics:[],success:!1,times:{}};e.target.taggedInts&&(e.target.floatingPoint=!0),e.target.isNative||(e.target.taggedInts=!1);var i={};for(var r in e.fileSystem)i[x(r)]=e.fileSystem[r];var n=k(),s={getSourceFile:function(e,t,r){e=x(e);var n="";return i.hasOwnProperty(e)?n=i[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),S.createSourceFile(e,n,t,!0)},fileExists:function(e){return e=x(e),i.hasOwnProperty(e)},getCanonicalFileName:function(e){return e},getDefaultLibFileName:function(){return"no-default-lib.d.ts"},writeFile:function(e,t,r,n){a.outfiles[e]=t},getCurrentDirectory:function(){return"."},useCaseSensitiveFileNames:function(){return!0},getNewLine:function(){return"\n"},readFile:function(e){return e=x(e),i[e]||""},directoryExists:function(e){return!0},getDirectories:function(){return[]}};e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));var o=e.sourceFiles.filter(function(e){return v.U.endsWith(e,".ts")}),l=o.filter(function(e){return"main.ts"!=e}),u=!1;o.length>l.length&&((o=l).push("main.ts"),u=!0);var c,p=S.createProgram(o,n,s);if(u)c="main.ts";else{var d=o[o.length-1];c=d.substring(d.lastIndexOf("/")+1)}if(a.diagnostics=y(p.getSyntacticDiagnostics(),e.ignoreFileResolutionErrors),0<a.diagnostics.length)return e.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),v.compileBinary(p,s,e,a,c)),a;a.diagnostics=y(p.getOptionsDiagnostics().concat(v.Util.toArray(p.getGlobalDiagnostics())),e.ignoreFileResolutionErrors),0==a.diagnostics.length&&(a.diagnostics=y(p.getSemanticDiagnostics(),e.ignoreFileResolutionErrors));var f=v.U.now();if(a.times.typescript=f-t,e.ast&&(a.ast=p),e.ast||e.forceEmit||0==a.diagnostics.length){var m=v.compileBinary(p,s,e,a,c);a.times.compilebinary=v.U.now()-f,a.diagnostics=a.diagnostics.concat(y(m.diagnostics))}0==a.diagnostics.length&&(a.success=!0);for(var h=0,g=e.sourceFiles;h<g.length;h++){var b=g[h];v.Util.startsWith(b,"built/")&&(a.outfiles[b.slice(6)]=e.fileSystem[b])}return a.times.all=v.U.now()-t,pxt.tickEvent("compile",a.times),a}function x(e){e=e.replace(/\\/g,"/");var t=[];return e.split("/").forEach(function(e){".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}v.getTsCompilerOptions=k,v.nodeLocationInfo=function(e){var t=S.getSourceFileOfNode(e),r=e.getStart?e.getStart():e.pos,n=S.getLineAndCharacterOfPosition(t,r),a=n.line,i=n.character,s=S.getLineAndCharacterOfPosition(t,e.end),o=s.line,l=s.character;return{start:r,length:e.end-r,line:a,column:i,endLine:o,endColumn:l,fileName:t.fileName}},v.patchUpDiagnostics=y,v.compile=o,v.decompile=function(e,t,r){void 0===r&&(r=!1);var n=o(e);if(!n.success)return n;var a=n.ast.getSourceFile(t),i=v.getApiInfo(e,n.ast),s=v.getBlocksInfo(i);return v.decompiler.decompileToBlocks(s,a,{snippetMode:!1,alwaysEmitOnStart:e.alwaysDecompileOnStart,includeGreyBlockMessages:r},v.decompiler.buildRenameMap(n.ast,a))}}(S.pxtc||(S.pxtc={}))}(ts||(ts={})),function(m){var e,h,g,b,v;e=m.elf||(m.elf={}),h=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],g=m.HF2.read32,b=m.HF2.read16,v=4096,e.parse=function(o){1179403647!=g(o,0)&&m.U.userError("no magic"),1!=o[4]&&m.U.userError("not 32 bit"),1!=o[5]&&m.U.userError("not little endian"),1!=o[6]&&m.U.userError("bad version"),2!=b(o,16)&&m.U.userError("wrong object type"),40!=b(o,18)&&m.U.userError("not ARM");var t=g(o,28);g(o,32),0==t&&m.U.userError("expecting program headers");for(var r=b(o,42),e=b(o,44),n=m.U.range(e).map(function(e){return function(e){for(var t={},r=e,n=0,a=h;n<a.length;n++){var i=a[n];t[i]=g(o,e),e+=4}var s=t;return s._filepos=r,s}(t+e*r)}),a=o.length+1;15&a;)a++;for(var i=0,s=0,l=n;s<l.length;s++)1==(f=l[s]).type&&(i=Math.max(i,f.vaddr+f.memsz));for(var u=(i+v-1&~(v-1))+(a&v-1),c=-1,p=0,d=n;p<d.length;p++){var f;4==(f=d[p]).type&&(c=f._filepos)}return{imageMemStart:u,imageFileStart:a,phOffset:c,template:o}},e.patch=function(e,t){var r=new Uint8Array(e.imageFileStart+t.length);return r.fill(0),m.U.memcpy(r,0,e.template),m.U.memcpy(r,e.imageFileStart,t),function(e,t){for(var r=t._filepos,n=0,a=h;n<a.length;n++){var i=a[n];m.HF2.write32(e,r,t[i]||0),r+=4}}(r,{_filepos:e.phOffset,type:1,offset:e.imageFileStart,vaddr:e.imageMemStart,paddr:e.imageMemStart,filesz:t.length,memsz:t.length,flags:5,align:v}),r}}(pxt||(pxt={})),function(g){!function(b){var v,e;(e=v||(v={}))[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF";var k=g.SyntaxKind;function y(e){switch(e){case k.CommaToken:return 2;case k.EqualsToken:case k.PlusEqualsToken:case k.MinusEqualsToken:case k.AsteriskEqualsToken:case k.AsteriskAsteriskEqualsToken:case k.SlashEqualsToken:case k.PercentEqualsToken:case k.LessThanLessThanEqualsToken:case k.GreaterThanGreaterThanEqualsToken:case k.GreaterThanGreaterThanGreaterThanEqualsToken:case k.AmpersandEqualsToken:case k.BarEqualsToken:case k.CaretEqualsToken:return 5;case k.QuestionToken:case k.ColonToken:return 7;case k.BarBarToken:return 10;case k.AmpersandAmpersandToken:return 20;case k.BarToken:return 30;case k.CaretToken:return 40;case k.AmpersandToken:return 50;case k.EqualsEqualsToken:case k.ExclamationEqualsToken:case k.EqualsEqualsEqualsToken:case k.ExclamationEqualsEqualsToken:return 60;case k.LessThanToken:case k.GreaterThanToken:case k.LessThanEqualsToken:case k.GreaterThanEqualsToken:case k.InstanceOfKeyword:case k.InKeyword:case k.AsKeyword:return 70;case k.LessThanLessThanToken:case k.GreaterThanGreaterThanToken:case k.GreaterThanGreaterThanGreaterThanToken:return 80;case k.PlusToken:case k.MinusToken:return 90;case k.AsteriskToken:case k.SlashToken:case k.PercentToken:return 100;case k.AsteriskAsteriskToken:return 101;case k.DotToken:return 120;default:return 0}}function d(e){switch(e){case k.EndOfFileToken:return v.EOF;case k.SingleLineCommentTrivia:return v.CommentLine;case k.MultiLineCommentTrivia:return v.CommentBlock;case k.NewLineTrivia:return v.NewLine;case k.WhitespaceTrivia:return v.Whitespace;case k.ShebangTrivia:case k.ConflictMarkerTrivia:return v.CommentBlock;case k.NumericLiteral:case k.StringLiteral:case k.RegularExpressionLiteral:case k.NoSubstitutionTemplateLiteral:case k.TemplateHead:case k.TemplateMiddle:case k.TemplateTail:return v.Literal;case k.Identifier:return v.Identifier;default:return e<k.Identifier?v.Operator:v.Keyword}}var f=!1;function m(e,t){for(;e[t]&&e[t].kind==v.Whitespace;)t++;return t}function x(){return{kind:v.EOF,synKind:k.EndOfFileToken,pos:0,lineNo:0,text:""}}function S(e,t){return{kind:v.Whitespace,synKind:k.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function T(e){if(!e)return!1;switch(e.synKind){case k.IfKeyword:case k.ElseKeyword:case k.LetKeyword:case k.ConstKeyword:case k.VarKeyword:case k.DoKeyword:case k.WhileKeyword:case k.SwitchKeyword:case k.CaseKeyword:case k.DefaultKeyword:case k.ForKeyword:case k.ReturnKeyword:case k.BreakKeyword:case k.ContinueKeyword:case k.TryKeyword:case k.CatchKeyword:case k.FinallyKeyword:case k.DeleteKeyword:case k.FunctionKeyword:case k.ClassKeyword:case k.YieldKeyword:case k.DebuggerKeyword:return!0;default:return!1}}function I(i,s,o){void 0===o&&(o=null);var l,n=[],u=0,c=!1;for(i=i.concat([x()]);i[u].kind!=v.EOF;){var e=u;g(),b.Util.assert(e<u,"Error at "+i[u].text),t(i.slice(e,u))}return n;function t(e){if(s&&(e=E(e)),0!=e.length){e.forEach(a),e=function e(t){var r=[];var n=0;for(;n<t.length;)if(t[n].blockSpanLength){var a=t.slice(n,n+t[n].blockSpanLength),i=!!a[0].blockSpanIsVirtual;delete a[0].blockSpanLength,delete a[0].blockSpanIsVirtual,n+=a.length,a=e(a),i?r.push((o=a,{kind:v.Tree,synKind:k.WhitespaceTrivia,pos:o[0].pos,lineNo:o[0].lineNo,children:o,endToken:null,text:""})):(r.push(S(a[0]," ")),r.push((s=E(a),{kind:v.Block,synKind:k.OpenBraceToken,pos:s[0].pos,lineNo:s[0].lineNo,stmts:[{tokens:s}],text:"{",endToken:null})))}else r.push(t[n++]);var s;var o;return r}(e);if(s&&0<n.length){var t=n[n.length-1].tokens[0].synKind,r=e[0].synKind;if(t==k.IfKeyword&&r==k.ElseKeyword||t==k.TryKeyword&&r==k.CatchKeyword||t==k.TryKeyword&&r==k.FinallyKeyword||t==k.CatchKeyword&&r==k.FinallyKeyword)return e.unshift(S(e[0]," ")),void b.Util.pushRange(n[n.length-1].tokens,e)}n.push({tokens:e})}}function a(e){if(e.kind==v.Tree){var t=e;t.children=b.Util.concat(I(t.children,!1,t).map(function(e){return e.tokens}))}}function p(e){for(void 0===e&&(e=!1);;)switch(i[++u].kind){case v.Whitespace:case v.CommentBlock:case v.CommentLine:break;case v.NewLine:if(e)break;break;default:return}}function d(){for(;i[u].kind==v.Whitespace;)u++;i[u].kind==v.NewLine&&u++}function f(){for(;;)switch(i[++u].kind){case v.EOF:return;case v.Tree:if(i[u].synKind==k.OpenBraceToken)return u--,void h()}}function m(){b.Util.assert(i[u].synKind==k.OpenBraceToken);var e=i[u];b.Util.assert(e.kind==v.Tree);var t=i[u];t.stmts=I(e.children,!0,l),delete e.children,t.kind=v.Block,u++,c=!0}function h(){var e=u+1;p(),i[u].synKind==k.OpenBraceToken?(m(),d()):(g(),i[e].blockSpanLength=u-e)}function g(){for(;;){var e=i[u],t=u;if(c=!1,(l=e).kind==v.EOF)return;if(s&&e.synKind==k.SemicolonToken)return u++,void d();if(e.synKind==k.EqualsGreaterThanToken){if(p(),i[u].synKind==k.OpenBraceToken){m();continue}var r=u;g();for(var n=u;i[n].kind==v.NewLine;)n--;return i[r].blockSpanLength=n-r,void(i[r].blockSpanIsVirtual=!0)}if(s&&y(e.synKind)){r=u;if(p(),!T(i[u]))continue;u=r}if(s&&e.kind==v.NewLine){if(p(),y((e=i[u]).synKind)&&e.synKind!=k.PlusToken&&e.synKind!=k.MinusToken)continue;return void(u=t+1)}if(e.synKind==k.OpenBraceToken&&o&&o.synKind==k.ClassKeyword){for(var a=u-1;0<=a&&i[a].kind==v.Whitespace;)a--;if(a<0||i[a].synKind!=k.EqualsToken)return u--,void h()}switch(b.Util.assert(t==u),e.synKind){case k.ForKeyword:case k.WhileKeyword:case k.IfKeyword:case k.CatchKeyword:if(p(),i[u].synKind!=k.OpenParenToken)continue;return void h();case k.DoKeyword:if(h(),u--,p(),i[u].synKind==k.WhileKeyword){u++;continue}return;case k.ElseKeyword:if(p(),i[u].synKind==k.IfKeyword)continue;return u=t,void h();case k.TryKeyword:case k.FinallyKeyword:return void h();case k.ClassKeyword:case k.NamespaceKeyword:case k.ModuleKeyword:case k.InterfaceKeyword:case k.FunctionKeyword:return void f()}b.Util.assert(!c,"forgot continue/return after expectBlock"),u++}}}function t(e){return e&&(e.kind==v.Whitespace||e.kind==v.NewLine)}function h(e){for(var t=[],r=!1,n=0;n<e.length;++n)r&&(n=m(e,n)),e[n]&&(t.push(e[n]),r=e[n].kind==v.NewLine);return t}function E(e){for(e=e.slice(0);t(e[0]);)e.shift();for(;t(e[e.length-1]);)e.pop();return e}b.toStr=function e(t){return Array.isArray(t)?"[[ "+t.map(e).join("  ")+" ]]":"string"==typeof t.text?JSON.stringify(t.text):t+""},b.format=function(e,t){var r=function(e){e;for(var r=g.createScanner(g.ScriptTarget.Latest,!1,g.LanguageVariant.Standard,e,function(e){var t=r.getTextPos();console.log("scanner error",t,e.message)}),t=[],n=0,a=-1;;){var i=r.scan();if(i==k.CloseBraceToken&&n==a&&(a=-1,i=r.reScanTemplateToken()),f&&i==k.SlashToken||i==k.SlashEqualsToken){var s=r.reScanSlashToken();s==k.RegularExpressionLiteral&&(i=s)}i==k.GreaterThanToken&&(i=r.reScanGreaterToken());var o={kind:d(i),synKind:i,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(i==k.OpenBraceToken&&n++,i==k.CloseBraceToken&&--n<0&&(n=-1e7),t.push(o),i!=k.TemplateHead&&i!=k.TemplateMiddle||(a=n),o.kind==v.EOF)break}return{tokens:t,braceBalance:n}}(e).tokens,n=I(r=function(e){var t=[];t.push({synKind:k.EndOfFileToken,token:{children:[]}});for(var r,n,a,i=0;i<e.length;++i){var s=e[i],o=t[t.length-1];switch(o.token.children.push(s),s.kind){case v.Operator:switch(s.synKind){case k.OpenBraceToken:case k.OpenParenToken:case k.OpenBracketToken:n=(r=s).synKind+1,a=void 0,(a=r).children=[],a.kind=v.Tree,t.push({synKind:n,token:a});break;case k.CloseBraceToken:case k.CloseParenToken:case k.CloseBracketToken:for(o.token.children.pop();;){if((o=t.pop()).synKind==s.synKind){o.token.endToken=s;break}if(0==t.length||o.synKind==k.CloseBraceToken){t.push(o);break}}}}}return t[0].token.children}(r=function(e,t){for(var r=[],n=!0,a=1,i=0;i<e.length;++i){if(n){var s=i;if(e[i=m(e,i)].kind==v.NewLine){var o=!1;0<=t&&e[i].pos>=t&&(t=-1,o=!0),r.push({text:"",kind:v.CommentLine,pos:e[i].pos,lineNo:a,synKind:k.SingleLineCommentTrivia,isCursor:o})}else i=s}r.push(e[i]),e[i].lineNo=a,e[i].kind==v.NewLine?(n=!0,a++):n=!1,0<=t&&e[i].pos>=t&&(t=-1)}return r}(r,t)),!0),s="",o="",a=-1,i=0;return n.forEach(c),n.forEach(function(e){return e.tokens.forEach(l)}),-1==a&&(a=o.length),{formatted:o,pos:a};function l(e){if(e.kind==v.Tree){var t=e;e.synKind,k.OpenBraceToken,t.children.forEach(l)}else e.kind==v.Block&&e.stmts.forEach(function(e){return e.tokens.forEach(l)})}function u(e,t){if(i==e.lineNo)t();else{i=e.lineNo;var r=s;s+="    ",t(),s=r}}function c(e){var t=h(e.tokens);1!=t.length||t[0].isCursor||""!=t[0].text?(o+=s,u(t[0],function(){!function a(i){i=function(e){var t,r=[],n=0,a=x();for(e=e.concat([x()]);n<e.length;){var i=e[n=m(e,n)];if(i.kind==v.EOF)break;var s=m(e,n+1);if(i.kind!=v.NewLine||e[s].synKind!=k.OpenBraceToken){var o=!0,l=0==r.length?(t=i,{kind:v.NewLine,synKind:k.NewLineTrivia,pos:t.pos,lineNo:t.lineNo,text:"\n"}):r[r.length-1];switch(l.synKind){case k.ExclamationToken:case k.TildeToken:case k.DotToken:o=!1;break;case k.PlusToken:case k.MinusToken:case k.PlusPlusToken:case k.MinusMinusToken:l.isPrefix&&(o=!1)}switch(i.synKind){case k.DotToken:case k.CommaToken:case k.NewLineTrivia:case k.ColonToken:case k.SemicolonToken:case k.OpenBracketToken:o=!1;break;case k.PlusPlusToken:case k.MinusMinusToken:l.kind!=v.Tree&&l.kind!=v.Identifier&&l.kind!=v.Keyword||(o=!1);case k.PlusToken:case k.MinusToken:(a.kind==v.EOF||y(a.synKind)||a.synKind==k.SemicolonToken)&&(i.isPrefix=!0);break;case k.OpenParenToken:if(l.kind==v.Identifier&&(o=!1),l.kind==v.Keyword)switch(l.synKind){case k.IfKeyword:case k.ForKeyword:case k.WhileKeyword:case k.SwitchKeyword:case k.ReturnKeyword:case k.ThrowKeyword:case k.CatchKeyword:break;default:o=!1}}l.kind==v.NewLine&&(o=!1),o&&r.push(S(i," ")),r.push(i),i.kind!=v.NewLine&&(a=i),n++}else n=s}return r}(i);for(var e=function(e){var t=i[e];switch(function(e,t){if(t.synKind==k.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(t.text)){var r=t.text.slice(1,t.text.length-1).split("\n").map(function(e){return e.replace(/\s/g,"")}).filter(function(e){return!!e});if(r.length<4||5<r.length)return;var n=Math.floor((Math.max.apply(Math,r.map(function(e){return e.length}))+2)/5);n<=0&&(n=1);for(var a="`\n",i=0;i<5;++i){for(var s=r[i]||"";s.length<5*n;)s+=".";a+=e+(s=(s=(s=s.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,function(e){return"/"+e})).replace(/./g,function(e){return" "+e}).replace(/\//g," ").slice(3)+"\n"}a+=e+"`",t.text=a}}(s,t),p(t),t.kind){case v.Tree:var r=t;u(t,function(){a(h(r.children))}),r.endToken&&p(r.endToken);break;case v.Block:var n=t;0==n.stmts.length?o+=" ":(o+="\n",n.stmts.forEach(c),o+=s.slice(4)),n.endToken?p(n.endToken):o+="}";break;case v.NewLine:if(i[e+1]&&i[e+1].kind==v.CommentLine&&""==i[e+1].text&&!i[e+1].isCursor)break;e==i.length-1?o+=s.slice(4):o+=s;break;case v.Whitespace:}},t=0;t<i.length;++t)e(t)}(t)}),"\n"!=o[o.length-1]&&(o+="\n")):o+="\n"}function p(e){-1==a&&e.pos+e.text.length>=t&&(a=o.length+(t-e.pos)),o+=e.text}}}(g.pxtc||(g.pxtc={}))}(ts||(ts={})),function(U){!function(P){var K;function o(e,t){var r="\n        .balign "+(1<<t.target.vtableShift)+"\n"+e.id+"_VT:\n        .short "+(4*e.refmask.length+4)+"  ; size in bytes\n        .byte "+(e.vtable.length+2)+", 0  ; num. methods\n",n=P.target.shortPointers?".short":".word",a=function(e){"0"!=e&&(!P.isStackMachine()||0<=e.indexOf("::"))&&(e+="@fn"),r+="        "+n+" "+e+"\n"};r+="        "+n+" "+e.id+"_IfaceVT\n",a("pxt::RefRecord_destroy"),a("pxt::RefRecord_print");for(var i=0,s=e.vtable;i<s.length;i++){a((c=s[i]).label())}for(var o=e.refmask.map(function(e){return e?"1":"0"});o.length<2||o.length%2!=0;)o.push("0");r+="        .byte "+o.join(",")+"\n",r+="\n        .balign "+(P.target.shortPointers?2:4)+"\n"+e.id+"_IfaceVT:\n";for(var l=0,u=e.itable;l<u.length;l++){var c;a((c=u[l])?c.label():"0")}return r+="\n"}function N(r,t){var n="; start\n"+K.hexPrelude()+"\n    .hex 708E3B92C615A841C49866C975EE5197 ; magic number\n    .hex "+K.hexTemplateHash()+" ; hex template hash\n    .hex 0000000000000000 ; @SRCHASH@\n    .short "+r.globalsWords+"   ; num. globals\n    .short 0 ; patched with number of words resulting from assembly\n    .word _pxt_config_data\n    .short 0 ; patched with comm section size\n    .short 0 ; reserved\n    .word 0 ; reserved\n",a=null;a=t.target.nativeType==P.NATIVE_TYPE_AVR?new P.AVRSnippets:new P.ThumbSnippets,r.procs.forEach(function(e){var t=new P.ProctoAssembler(a,r,e);n+="\n"+t.getAssembly()+"\n"}),r.usedClassInfos.forEach(function(e){n+=o(e,t)}),P.U.iterMap(r.codeHelpers,function(e,t){n+="    .section code\n"+t+":\n"+e+"\n"}),n+=a.arithmetic(),n+="\n.balign 4\n_pxt_config_data:\n";for(var e=0,i=r.res.configData||[];e<i.length;e++){var s=i[e];n+="    .word "+s.key+", "+s.value+"  ; "+s.name+"="+s.value+"\n"}return n+="    .word 0\n\n",n+=K.asmTotalSource,n+="_js_end:\n",function(e,t){for(var r=0,n=Object.keys(t.strings);r<n.length;r++){var a=n[r];t.otherLiterals.push(e.string_literal(t.strings[a],a))}for(var i=0,s=Object.keys(t.doubles);i<s.length;i++){var o=s[i],l=t.doubles[o];t.otherLiterals.push("\n.balign 4\n"+l+": .short 0xffff, "+pxt.REF_TAG_NUMBER+"\n        .hex "+o+"\n")}for(var u=0,c=Object.keys(t.hexlits);u<c.length;u++)o=c[u],t.otherLiterals.push(e.hex_literal(t.hexlits[o],o)),t.otherLiterals.push()}(a,r),n+=r.otherLiterals.join(""),n+="_program_end:\n"}function i(e){var t;return(t=e.nativeType==P.NATIVE_TYPE_AVR?new P.assembler.File(new P.avr.AVRProcessor):e.nativeType==P.NATIVE_TYPE_AVRVM?new P.assembler.VMFile(new P.vm.VmProcessor(e)):new P.assembler.File(new P.thumb.ThumbProcessor)).ei.testAssembler(),t.lookupExternalLabel=K.lookupFunctionAddr,t.normalizeExternalLabel=function(e){var t=K.lookupFunc(e);return t?t.name:e},t}function s(e){if(0<e.errors.length){var r="";throw e.errors.forEach(function(e){var t=/^user(\d+)/.exec(e.scope);if(t){parseInt(t[1]);r+=P.U.lf("At inline assembly:\n"),r+=e.message}}),r&&(console.log(P.U.lf("errors in inline assembly")),console.log(r)),new Error(e.errors[0].message)}}!function(S){var T,I,E,w,_,K,N,v={},c={};function L(e){for(var t="",r=0;r<e.length;r+=2)t=e[r]+e[r+1]+t;return P.assert(r==e.length),t}function k(e){return e.flashCodeAlign||S.defaultPageSize}function p(e){return v[e]}function U(){for(var e=S.currentSetup?S.currentSetup.slice(0,16):"";e.length<16;)e+="0";return e.toUpperCase()}function A(e){var t=0,r=":";return e.forEach(function(e){return t+=e}),e.push(255&-t),e.forEach(function(e){return r+=("0"+e.toString(16)).slice(-2)}),r.toUpperCase()}function C(n,r){void 0===r&&(r=null);var i=[255,255,1,0];P.assert(4==i.length);var a=function(e,t,r){if(64==e[t]&&80==e[t+1]&&88==e[t+2]&&84==e[t+3]){var n=r();if(64==n[4]&&58==n[5]){for(var a=0;6+a<n.length&&0!=n[6+a];)a++;return 6+a>=n.length&&P.U.oops("constant string too long!"),i.concat([255&a,a>>8])}}return null};if(r)for(var e=function(e){var t=a(r,e,function(){return r.slice(e,e+200)});t&&P.U.memcpy(r,e,t)},t=0;t<r.length-8;t+=4)e(t);else for(var s=0;s<n.blocks.length;++s){var o=n.blocks[s],l=n.ptrs[s]<<8,u=function(e){var t=l+e-32,r=a(o,e,function(){return P.UF2.readBytesFromFile(n,t,200)});r&&P.UF2.writeBytes(n,t,r)};for(t=32;t<288;t+=4)u(t)}}S.asmTotalSource="",S.defaultPageSize=1024,S.commBase=0,S.hexDump=function(e,t){function r(e,t){void 0===t&&(t=8);for(var r=e.toString(16);r.length<t;)r="0"+r;return r}void 0===t&&(t=0);for(var n="",a=0;a<e.length;a+=16){n+=r(t+a)+": ";for(var i="",s=0;s<16;s++){0==(3&s)&&(n+=" ");var o=e[a+s];null!=o?(n+=r(o,2)+" ",i+=32<=o&&o<127?String.fromCharCode(o):"."):n+="   "}n+=" "+i+"\n"}return n},S.setupInlineAssembly=function(e){c={};var t=e.sourceFiles.filter(function(e){return P.U.endsWith(e,".asm")});S.asmTotalSource="";for(var r=0,n=0,a=t;n<a.length;n++){var i=a[n],s=e.fileSystem[i];s.replace(/^\s*(\w+):/gm,function(e,t){return c[t]=!0,""});var o=".section code\n@stackmark func\n@scope user"+r+++"\n"+s+"\n@stackempty func\n@scope\n";S.asmTotalSource+=o}},S.flashCodeAlign=k,S.encodeVTPtr=function(e,t){var r=e>>t.target.vtableShift;return P.assert(r<65535),P.assert(r<<t.target.vtableShift==e),r},S.setupFor=function(o,e,t){if(!S.isSetupFor(e)){var i=e.functions;if(S.commBase=e.commBase||0,S.currentSetup=e.sha,S.currentHexInfo=t,function(e){for(var t=0;t<e.length;++t)if("2"==e[t][8]){var r=/^:02....02(....)..$/.exec(e[t]);P.U.assert(!!r);var n=16*parseInt(r[1],16);P.U.assert(0==(65535&n)),e[t]=A([2,0,0,4,0,n>>16])}}(T=t.hex),o.nativeType!=P.NATIVE_TYPE_CS){if(T.length<=2){K=pxt.elf.parse(P.U.fromHex(T[0])),N=-1,_=K.imageMemStart,S.bytecodeStartAddrPadded=K.imageMemStart;var r=T[w=0].indexOf("0108010842424242010801083ed8e98d");return r<0&&P.oops("no jmp table in elf"),I=r/2,E=-1,g(T[0].slice(r+32,r+32+8*i.length+16)),void b()}var n=0,a="0000",l=0,u=0;_=0;for(var s=function(){if(!_){var e=function e(t){if(!(t=t.replace(/^[\s:]/,"")))return[];var r=/^([a-f0-9][a-f0-9])/i.exec(t);if(r)return[parseInt(r[1],16)].concat(e(t.slice(2)));throw P.oops("bad bytes "+t)}(T[u]),t=16-(l+e[0]&15)&15;if(t)if(15&e[2]){for(var r=l+e[0],n=[t,r>>8,255&r,0],a=0;a<t;++a)n.push(0);u++,T.splice(u,0,A(n)),_=r+t}else{if(16!=e[0]){for(e.pop(),e[0]=16;e.length<20;)e.push(0);T[u]=A(e)}_=l+16}else _=l+e[0];N=u+1;var i=k(o);S.bytecodeStartAddrPadded=(_&~(i-1))+i;var s=S.bytecodeStartAddrPadded-_;P.assert(0==(15&s)),w=s}};n<T.length;++n){if((d=/:02000004(....)/.exec(T[n]))&&(a=d[1]),d=/^:..(....)00/.exec(T[n])){var c=parseInt(a+d[1],16);o.flashUsableEnd&&c>=o.flashUsableEnd&&s(),u=n,l=c}/^:00000001/.test(T[n])&&s(),(d=/^:10....000108010842424242010801083ED8E98D/.exec(T[n]))&&(I=l,E=n)}I||P.oops("No hex start"),_||P.oops("No hex end"),v={};for(var p=E+1;p<T.length;++p){var d;if((d=/^:..(....)00(.{4,})/.exec(T[p]))&&(g(d[2]),0==i.length))break}return void b()}for(var f=0,m=i;f<m.length;f++){var h=m[f];v[h.name]=h}}function g(e){for(var t=o.shortPointers?4:8;e.length>=t;){var r=e.slice(0,t),n=parseInt(L(r),16);e=e.slice(t);var a=i.shift();if(!a)break;v[a.name]=a,n||P.U.oops("No value for "+a.name+" / "+r),o.nativeType!=P.NATIVE_TYPE_THUMB||1&n||P.U.oops("Non-thumb addr for "+a.name+" / "+r),a.value=n}}function b(){i.length&&P.oops("premature EOF in hex file; missing: "+i.map(function(e){return e.name}).join(", "))}},S.validateShim=function(e,t,r,n,a){if("TD_ID"!=t&&"TD_NOOP"!=t&&!P.U.lookup(c,t)){var i=e+"(...) (shim="+t+")",s=p(t);if(s){if(P.target.nativeType==P.NATIVE_TYPE_CS)return;n?"V"==s.argsFmt[0]&&P.U.userError("expecting function for "+i):"V"!=s.argsFmt[0]&&P.U.userError("expecting procedure for "+i);for(var o=0;o<a.length;++o){var l=s.argsFmt[o+1];if(l||P.U.userError("excessive parameters passed to "+i),P.target.taggedInts){var u="I"==l||"N"==l||"F"==l;"T"==l||(u&&!a[o]?P.U.userError("expecting number at parameter "+(o+1)+" of "+i):!u&&a[o]&&P.U.userError("expecting non-number at parameter "+(o+1)+" of "+i+" / "+s.argsFmt))}}a.length!=s.argsFmt.length-1&&P.U.userError("not enough arguments for "+i+" (got "+a.length+"; fmt="+s.argsFmt+")")}else P.U.userError("function not found: "+i)}},S.lookupFunc=p,S.lookupFunctionAddr=function(e){if("_pxt_comm_base"==e)return S.commBase;var t=p(e);return t?t.value:null},S.hexTemplateHash=U,S.hexPrelude=function(){return"    .startaddr 0x"+S.bytecodeStartAddrPadded.toString(16)+"\n"},S.patchHex=function(e,t,r,n){var a=T.slice(0,N);P.assert(t.length<64e3,"program too large, words: "+t.length),t[17]=t.length,t[20]=e.commSize;for(var i=[],s=0;s<w>>1;++s)i.push(0);t=i.concat(t);var o=0;function l(e,t){for(var r=[16,t>>8&255,255&t,0],n=0;n<8;++n)r.push(255&(e[o]||0)),r.push((e[o]||0)>>>8),o++;return r}var u=[16905,0,65535&S.bytecodeStartAddrPadded,S.bytecodeStartAddrPadded>>>16],c=U();for(s=0;s<4;++s)u.push(parseInt(L(c.slice(4*s,4*s+4)),16));var p=n?P.UF2.newBlockFile():null;if(K){var d=new Uint8Array(2*t.length);for(s=0;s<t.length;++s)pxt.HF2.write16(d,2*s,t[s]);var f=pxt.elf.patch(K,d);for(s=0;s<u.length;++s)pxt.HF2.write16(f,2*s+I,u[s]);return C(null,f),p?(P.UF2.writeBytes(p,0,f),[P.UF2.serializeFile(p)]):[P.U.uint8ArrayToString(f)]}if(p){if(P.UF2.writeHex(p,a),C(p),P.UF2.writeBytes(p,I,l(u,E).slice(4)),e.checksumBlock){for(var m=[],h=0,g=e.checksumBlock;h<g.length;h++){var b=g[h];m.push(255&b,b>>8)}P.UF2.writeBytes(p,e.target.flashChecksumAddr,m)}}else a[E]=A(l(u,I)),e.checksumBlock&&P.U.oops("checksum block in HEX not implemented yet");o=0,r&&(a=[]);for(var v=_,k=v-16>>16;o<t.length;)p?P.UF2.writeBytes(p,v,l(t,v).slice(4)):(v>>16!=k&&(k=v>>16,a.push(A([2,0,0,4,k>>8,255&k]))),a.push(A(l(t,v)))),v+=16;if(!r){var y=T.slice(N);p?P.UF2.writeHex(p,y):P.Util.pushRange(a,y)}if(e.packedSource)if(p)P.U.userError("TODO");else for(k=536870912,v=0,a.push(A([2,0,0,4,k>>8,255&k])),s=0;s<e.packedSource.length;s+=16){m=[16,v>>8&255,255&v,0];for(var x=0;x<16;++x)m.push(255&(e.packedSource.charCodeAt(s+x)||0));a.push(A(m)),v+=16}return p?[P.UF2.serializeFile(p)]:a}}(K=P.hex||(P.hex={})),P.asmline=function(e){return/(^[\s;])|(:$)/.test(e)||(e="    "+e),e+"\n"},P.vtableToAsm=o;var a=!(P.processorInlineAssemble=function(e,t){var r=i(e);r.disablePeepHole=!0,r.emit(t),s(r);for(var n=[],a=0;a<r.buf.length;a+=2)n.push(((r.buf[a+1]||0)<<16|r.buf[a])>>>0);return n});function L(e,t,r){var n=i(e);return n.emit(r),r=n.getSource(!a,t.numStmts,e.flashEnd),s(n),{src:r,buf:n.buf,thumbFile:n}}P.assemble=L,P.processorEmit=function(e,t,r){var n,a,i,s,o,l,u,c=N(e,t);n=e,a=c,i=P.U.sha256(a),n.sourceHash=i,c=a.replace(/\n.*@SRCHASH@\n/,"\n    .hex "+i.slice(0,16).toUpperCase()+" ; program hash\n"),t.embedBlob&&(e.packedSource=(s=t.embedMeta,o=U.pxtc.decodeBase64(t.embedBlob),(l=P.Util.toUTF8(s)).length,o.length,u="A//",u+=P.U.uint8ArrayToString([255&l.length,l.length>>8,255&o.length,o.length>>8,0,0,0,0]),u+=l,(u+=o).length%2&&(u+="\0"),u),!e.target.noSourceInFlash&&e.packedSource.length<4e4&&(c+=function(e){for(var t="",r=0;r<e.length;++r){var n=255&e.charCodeAt(r);t+=n<=15?"0"+n.toString(16):n.toString(16)}return"\n    .balign 16\n_stored_program: .hex "+t+"\n"}(e.packedSource),e.packedSource=null));var p=K.flashCodeAlign(t.target);if(t.target.flashChecksumAddr){for(var d=0;1<<d<p;)d++;var f=parseInt(e.sourceHash.slice(0,8),16),m=K.bytecodeStartAddrPadded/p;f=4294967040&f|d;var h=0,g=m;t.target.flashChecksumAddr<K.bytecodeStartAddrPadded&&(g-=h=Math.ceil((t.target.flashChecksumAddr+32)/p)),c+="\n    .balign 4\n__end_marker:\n    .word "+f+"\n\n; ------- this will get removed from the final binary ------\n__flash_checksums:\n    .word 0x87eeb07c ; magic\n    .word __end_marker ; end marker position\n    .word "+f+" ; end marker\n    ; template region\n    .short "+h+", "+g+"\n    .word 0x"+K.hexTemplateHash().slice(0,8)+"\n    ; user region\n    .short "+m+", 0xffff\n    .word 0x"+e.sourceHash.slice(0,8)+"\n    .word 0x0 ; terminator\n"}e.writeFile(P.BINARY_ASM,c);var b=L(t.target,e,c);if(b.thumbFile.commPtr&&(e.commSize=b.thumbFile.commPtr-K.commBase),b.src&&e.writeFile(P.BINARY_ASM,b.src),b.buf){if(t.target.flashChecksumAddr){var v=b.thumbFile.lookupLabel("__flash_checksums")/2;P.U.assert(v==b.buf.length-16);var k=b.buf.slice(b.buf.length-16);b.buf.splice(b.buf.length-16,16);var y=Math.ceil(2*b.buf.length/p);k[k.length-5]=y,e.checksumBlock=k}if(pxt.isOutputText(P.target))x=K.patchHex(e,b.buf,!1,!1).join("\r\n")+"\r\n",e.writeFile(pxt.outputName(P.target),x);else{var x=U.pxtc.encodeBase64(K.patchHex(e,b.buf,!1,!0)[0]);e.writeFile(pxt.outputName(P.target),x)}}for(var S=0,T=r.breakpoints;S<T.length;S++){var I=T[S],E=P.U.lookup(b.thumbFile.getLabels(),"__brkp_"+I.id);null!=E&&(I.binAddr=E)}for(var w=0,_=e.procs;w<_.length;w++)_[w].fillDebugInfo(b.thumbFile);r.procDebugInfo=e.procs.map(function(e){return e.debugInfo})},P.validateShim=K.validateShim,P.f4EncodeImg=function(e,t,r,n){for(var a=p(224|r)+p(e)+p(t)+"00",i=4,s=0,o=0,l=function(e){s|=e<<o,o==8-r?(a+=p(s),i++,o=s=0):o+=r},u=0;u<e;++u){for(var c=0;c<t;++c)l(n(u,c));for(;0!=o;)l(0);if(1<r)for(;3&i;)l(0)}return a;function p(e){return("0"+e.toString(16)).slice(-2)}}}(U.pxtc||(U.pxtc={}))}(ts||(ts={})),function(d){!function(c){var i=function(e,t){var r="";if(e.file){var n=d.getLineAndCharacterOfPosition(e.file,e.start),a=n.line,i=n.character,s=e.file.fileName;r+=s+"("+(a+1)+","+(i+1)+"): "}var o=c.DiagnosticCategory[e.category].toLowerCase();r+=o+" TS"+e.code+": "+c.flattenDiagnosticMessageText(e.messageText,d.sys.newLine)+d.sys.newLine,d.sys.write(r)};function p(e,t){for(var r=0,n=e;r<n.length;r++){var a=n[r];i(a,t)}}c.plainTsc=function(a){var e,t,r,n,i,s,o,l=d.parseCommandLine([]),u=d.findConfigFile(a,d.sys.fileExists);return e=function(){var e=d.sys.readFile(u),t=d.parseConfigFileTextToJson(u,e),r=t.config;if(!r)return p([t.error],void 0),void d.sys.exit(d.ExitStatus.DiagnosticsPresent_OutputsSkipped);var n=d.parseJsonConfigFileContent(r,d.sys,a,l.options,u);return 0<n.errors.length?(p(n.errors,void 0),void d.sys.exit(d.ExitStatus.DiagnosticsPresent_OutputsSkipped)):n}(),(t=d.createCompilerHost(e.options)).getDefaultLibFileName=function(){return"node_modules/typescript/lib/lib.d.ts"},r=e.fileNames,n=e.options,i=t,o=d.createProgram(r,n,i),0===(s=o.getSyntacticDiagnostics()).length&&0===(s=o.getOptionsDiagnostics().concat(c.Util.toArray(o.getGlobalDiagnostics()))).length&&(s=o.getSemanticDiagnostics()),p(s,i),o}}(d.pxtc||(d.pxtc={}))}(ts||(ts={})),function(T){!function(S){function r(t,e,r){if(void 0===r&&(r=""),e.parameters){var n=!!e.attributes.imageLiteral;return"("+e.parameters.filter(function(e){return!e.initializer}).map(function(e){return function(e,t,r,n){if(t.initializer)return t.initializer;if(t.default)return t.default;if("number"==t.type)return"0";if("boolean"==t.type)return"false";if("string"==t.type)return r?(r=!1,"`"+S.defaultImgLit+n+"`"):'"'+n+'"';var a=e?S.Util.lookup(e.byQName,t.type):void 0;if(a&&a.kind==S.SymbolKind.Enum){var i=S.Util.values(e.byQName).filter(function(e){return e.namespace==t.type})[0];if(i)return i.namespace+"."+i.name}var s=/^\((.*)\) => (.*)$/.exec(t.type);return s?"("+s[1]+") => {\n    "+n+"\n}":S.placeholderChar}(t,e,n,r)}).join(", ")+")"}return""}function h(f,e,t){function m(e,t,r){void 0===r&&(r=!1);var n=f.getTypeAtLocation(t);if(!n)return"None";r&&(n=n.getCallSignatures()[0].getReturnType());var a=f.typeToString(n,void 0,T.TypeFormatFlags.UseFullyQualifiedType);return isNaN(Number(a))?a:"number"}var r,n=function(e){switch(e.kind){case S.SK.MethodDeclaration:case S.SK.MethodSignature:return S.SymbolKind.Method;case S.SK.PropertyDeclaration:case S.SK.PropertySignature:case S.SK.GetAccessor:case S.SK.SetAccessor:return S.SymbolKind.Property;case S.SK.FunctionDeclaration:return S.SymbolKind.Function;case S.SK.VariableDeclaration:return S.SymbolKind.Variable;case S.SK.ModuleDeclaration:return S.SymbolKind.Module;case S.SK.EnumDeclaration:return S.SymbolKind.Enum;case S.SK.EnumMember:return S.SymbolKind.EnumMember;case S.SK.ClassDeclaration:return S.SymbolKind.Class;case S.SK.InterfaceDeclaration:return S.SymbolKind.Interface;default:return S.SymbolKind.None}}(t);if(n!=S.SymbolKind.None){var a=t,h=S.parseComments(a);if(h.weight<0)return null;var i=/^(.*)\.(.*)/.exec(e),s=n==S.SymbolKind.Function||n==S.SymbolKind.Method,o=null,l=T.getSourceFileOfNode(t);if(l){var u=/^pxt_modules\/([^\/]+)/.exec(l.fileName);u&&(o=u[1])}var c=void 0;if(n==S.SymbolKind.Class||n==S.SymbolKind.Interface){var p=t;if(c=[],p.heritageClauses)for(var d=0,g=p.heritageClauses;d<g.length;d++){var b=g[d];if(b.types)for(var v=0,k=b.types;v<k.length;v++){var y=k[v];c.push(m(0,y))}}}var x={kind:n,namespace:i?i[1]:"",name:i?i[2]:e,attributes:h,pkg:o,extendsTypes:c,retType:n==S.SymbolKind.Module?"":m(a.type,a,s),parameters:s?S.Util.toArray(a.parameters).map(function(r,e){var t,n,a=S.getName(r),i=h.paramHelp[a]||"",s=h.paramMin&&h.paramMin[a],o=h.paramMax&&h.paramMax[a];/\beg\.?:\s*(.+)/.exec(i);if(r.type&&r.type.kind===S.SK.FunctionType){var l=f.getSignatureFromDeclaration(r.type).getParameters();"objectdestructuring"===h.mutate?(S.assert(0<l.length),t=f.getTypeAtLocation(l[0].valueDeclaration).getProperties().map(function(e){return{name:e.getName(),type:f.typeToString(f.getTypeOfSymbolAtLocation(e,l[0].valueDeclaration))}})):n=l.map(function(e,t){return{name:e.getName(),type:f.typeToString(f.getTypeOfSymbolAtLocation(e,r))}})}var u={},c=f.getTypeAtLocation(r),p=c&&!!(c.flags&(T.TypeFlags.Enum|T.TypeFlags.EnumLiteral));if(h.block&&h.paramShadowOptions){var d=[];h.block.replace(/%(\w+)/g,function(e,t){return d.push(t),""}),h.paramShadowOptions[d[e]]&&(u.fieldEditorOptions={value:h.paramShadowOptions[d[e]]})}return s&&(u.min={value:s}),o&&(u.max={value:o}),{name:a,description:i,type:m(r.type,r),initializer:r.initializer?r.initializer.getText():h.paramDefl[a],default:h.paramDefl[a],properties:t,handlerParameters:n,options:u,isEnum:p}}):null,snippet:S.service.getSnippet(a,h)};return(t.kind===S.SK.GetAccessor||(t.kind===S.SK.PropertyDeclaration||t.kind===S.SK.PropertySignature)&&((r=t).modifiers&&r.modifiers.some(function(e){return e.kind==S.SK.ReadonlyKeyword})))&&(x.isReadOnly=!0),x}return null}function g(e,t){return e.getFullyQualifiedName(t)}S.placeholderChar="",S.defaultImgLit="\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n",S.renderCall=function(e,t){return t.namespace+"."+t.name+r(e,t)+";"},S.renderParameters=r,S.genDocs=function(n,e,a){void 0===a&&(a={}),pxt.debug("generating docs for "+n),pxt.debug(JSON.stringify(Object.keys(e.byQName),null,2));for(var i={},r=S.Util.values(e.byQName),t=r.filter(function(e){return e.kind==S.SymbolKind.EnumMember}).sort(function(e,t){var r=-(d(e)?1:-1)+(d(t)?1:-1);return r||(r=-(e.attributes.weight||50)+(t.attributes.weight||50))||S.U.strcmp(e.name,t.name)}),s={},o={},l=function(t,e){if(a.locs){var r={};Object.keys(t).sort().forEach(function(e){return r[e]=t[e]}),i[n+e+"-strings.json"]=JSON.stringify(r,null,2)}},u=function(t){if(t.kind==S.SymbolKind.Module){if(!r.filter(function(e){return e.namespace==t.name&&!!e.attributes.jsDoc})[0])return"continue";t.attributes.block||(t.attributes.block=t.name)}!function(t){if(a.locs&&t.qName&&!t.attributes.deprecated&&!/^__/.test(t.name)){if(pxt.debug("loc: "+t.qName),t.kind!=S.SymbolKind.EnumMember){var e=T.pxtc.blocksCategory(t);e&&(s["{id:category}"+e]=e)}t.attributes.jsDoc&&(o[t.qName]=t.attributes.jsDoc),t.attributes.block&&(s[t.qName+"|block"]=t.attributes.block),t.attributes.group&&(s["{id:group}"+t.attributes.group]=t.attributes.group),t.parameters&&t.parameters.filter(function(e){return!!e.description}).forEach(function(e){o[t.qName+"|param|"+e.name]=e.description})}}(t)},c=0,p=r;c<p.length;c++)u(p[c]);return a.locs&&t.forEach(function(e){e.attributes.block&&(s[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(s[e.qName]=e.attributes.jsDoc)}),l(s,""),l(o,"-jsdoc"),i;function d(e){return!!e.attributes.block&&!!e.attributes.blockId}},S.getApiInfo=function(e,t,r){void 0===r&&(r=!1);for(var l={byQName:{},jres:e.jres},i=t.getTypeChecker(),s=function(e){if(e.kind!=S.SK.VariableStatement){if(function(e){if(e.modifiers&&e.modifiers.some(function(e){return e.kind==S.SK.PrivateKeyword||e.kind==S.SK.ProtectedKeyword}))return!1;var t=e.symbol;if(!t)return!1;for(;;){var r=t.parent;if(!r)break;t=r}var n=t.valueDeclaration||t.declarations[0];return n.kind==S.SK.VariableDeclaration&&(n=n.parent.parent),!(!n.parent||n.parent.kind!=S.SK.SourceFile)}(e)){if(!e.symbol)return void console.warn("no symbol",e);var t=g(i,e.symbol);e.kind==S.SK.SetAccessor&&(t+="@set");var r=h(i,t,e);if(r){var n=S.U.lookup(l.byQName,t);n&&(r.attributes=S.parseCommentString(n.attributes._source+"\n"+r.attributes._source),n.extendsTypes&&(r.extendsTypes=r.extendsTypes||[],n.extendsTypes.forEach(function(e){-1===r.extendsTypes.indexOf(e)&&r.extendsTypes.push(e)}))),l.byQName[t]=r}}if(e.kind==S.SK.ModuleDeclaration){var a=e;a.body.kind==S.SK.ModuleBlock?a.body.statements.forEach(s):a.body.kind==S.SK.ModuleDeclaration&&s(a.body)}else e.kind==S.SK.InterfaceDeclaration?e.members.forEach(s):e.kind==S.SK.ClassDeclaration?e.members.forEach(s):e.kind==S.SK.EnumDeclaration&&e.members.forEach(s)}else e.declarationList.declarations.forEach(s)},n=0,a=t.getSourceFiles();n<a.length;n++)a[n].statements.forEach(s);var o=[];for(var u in l.byQName){var c=l.byQName[u];c.qName=u,c.attributes._source=null,c.extendsTypes&&c.extendsTypes.length&&o.push(c);var p=c.attributes.jres;if(p){"true"==p&&(p=u);var d=S.U.lookup(e.jres||{},p);d&&d.icon&&!c.attributes.iconURL&&(c.attributes.iconURL=d.icon),d&&d.data&&!c.attributes.jresURL&&(c.attributes.jresURL="data:"+d.mimeType+";base64,"+d.data)}}var f={},m=function(e){if(!S.U.lookup(f,e.qName)){f[e.qName]=!0;var t={};t[e.qName]=!0;for(var r=0,n=e.extendsTypes||[];r<n.length;r++){var a=n[r];t[a]=!0;var i=l.byQName[a];if(i){m(i);for(var s=0,o=i.extendsTypes;s<o.length;s++)t[o[s]]=!0}}e.extendsTypes=Object.keys(t)}};return o.forEach(m),r&&delete l.byQName["Array.map"],l},S.getFullName=g,S.fillCompletionEntries=function(e,t,r,n){for(var a=e.getTypeChecker(),i=0,s=t;i<s.length;i++){var o=s[i],l=g(a,o);if((r.isMemberCompletion||!S.Util.lookup(n.byQName,l))&&!S.Util.lookup(r.entries,l)){var u=o.valueDeclaration||(o.declarations||[])[0];if(u){var c=h(a,l,u);c&&(c.isContextual=!0,r.entries[l]=c)}}}}}(T.pxtc||(T.pxtc={}))}(ts||(ts={})),function(b){var v;(function(e){var a,i,s,t,r,p,d,f,m,n={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1},hexinfo:null},o=function(){function e(){this.opts=n,this.fileVersions={},this.projectVer=0}return e.prototype.getProjectVersion=function(){return this.projectVer+""},e.prototype.setFile=function(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)},e.prototype.setOpts=function(e){var r=this;v.Util.iterMap(e.fileSystem,function(e,t){r.opts.fileSystem[e]!=t&&(r.fileVersions[e]=(r.fileVersions[e]||0)+1)}),this.opts=e,this.projectVer++},e.prototype.getCompilationSettings=function(){return v.getTsCompilerOptions(this.opts)},e.prototype.getScriptFileNames=function(){return this.opts.sourceFiles.filter(function(e){return v.U.endsWith(e,".ts")})},e.prototype.getScriptVersion=function(e){return(this.fileVersions[e]||0).toString()},e.prototype.getScriptSnapshot=function(e){var t=this.opts.fileSystem[e];return t?b.ScriptSnapshot.fromString(t):null},e.prototype.getNewLine=function(){return"\n"},e.prototype.getCurrentDirectory=function(){return"."},e.prototype.getDefaultLibFileName=function(e){return"no-default-lib.d.ts"},e.prototype.log=function(e){console.log("LOG",e)},e.prototype.trace=function(e){console.log("TRACE",e)},e.prototype.error=function(e){console.error("ERROR",e)},e.prototype.useCaseSensitiveFileNames=function(){return!0},e}();function l(e){if(!/\.ts$/.test(e))return[];var t=a.getSyntacticDiagnostics(e);return t&&t.length||(t=a.getSemanticDiagnostics(e)),t||(t=[]),t}var h=function(e){return e?(r||(r=v.getBlocksInfo(e)),r):(t||(t=v.getBlocksInfo(s)),t)},u={reset:function(){a.cleanupSemanticCache(),i.setOpts(n)},setOptions:function(e){i.setOpts(e.options)},getCompletions:function(e){e.fileContent&&i.setFile(e.fileName,e.fileContent);var t=a.getProgram(),r=a.getCompletionData(e.fileName,e.position);if(!r)return{};t.getTypeChecker();var n={entries:{},isMemberCompletion:r.isMemberCompletion,isNewIdentifierLocation:r.isNewIdentifierLocation,isTypeLocation:!1};return v.fillCompletionEntries(t,r.symbols,n,s),n},compile:function(e){return v.compile(e.options)},decompile:function(e){return v.decompile(e.options,e.fileName)},assemble:function(e){return{words:v.processorInlineAssemble(i.opts.target,e.fileContent)}},fileDiags:function(e){return v.patchUpDiagnostics(l(e.fileName))},allDiags:function(){var e=a.getCompilerOptionsDiagnostics()||[],t=i.getScriptFileNames().map(l),r=e.concat(v.Util.concat(t));return 0==r.length&&(r=v.compileBinary(a.getProgram(),null,i.opts,{outfiles:{},diagnostics:[],success:!0,times:{}},"main.ts").diagnostics),v.patchUpDiagnostics(r)},format:function(e){var t=e.format;return v.format(t.input,t.pos)},apiInfo:function(){if(p=t=void 0,i.opts!==n)return s=v.getApiInfo(i.opts,a.getProgram())},blocksInfo:function(e){return h(e)},apiSearch:function(e){var t=e.search,i=h(t.localizedApis);t.localizedStrings&&pxt.Util.setLocalizedStrings(t.localizedStrings);var r,a=function(t,e,r){if(t)return"string"==typeof t?t:e?t[e]:Object.keys(t).map(function(e){return t[e]}).join(" ")};if(!d){d=[],f=pxt.blocks.blockDefinitions();var n=function(r){var n=f[r];if(n.operators){var e=function(t){n.operators[t].forEach(function(e){return d.push({id:r,name:n.name,jsdoc:"string"==typeof n.tooltip?n.tooltip:n.tooltip[e],block:e,field:[t,e],builtinBlock:!0})})};for(var t in n.operators)e(t)}else d.push({id:r,name:n.name,jsdoc:a(n.tooltip,n.tooltipSearch),block:a(n.block,n.blockTextSearch),builtinBlock:!0})};for(var s in f)n(s)}if(!p||t.subset){var o={},l=void 0;t.subset&&(m=t.subset,l=d.filter(function(e){return!!m[e.id]})),m?r=i.blocks.filter(function(e){return!!m[e.attributes.blockId]}):(r=i.blocks,l=d);var u=r.map(function(e){return{id:e.attributes.blockId,qName:e.qName,name:e.name,namespace:e.namespace,block:e.attributes.block,jsdoc:e.attributes.jsDoc,localizedCategory:m&&"string"==typeof m[e.attributes.blockId]?m[e.attributes.blockId]:void 0}}),c=0;r.forEach(function(e){var t,r,n,a=o[e.qName]=(r=(t=e).attributes.weight||50,(1e3*((n=i.apis.byQName[t.namespace])&&n.attributes.weight||50)+r)*(n&&n.attributes.advanced||t.attributes.advanced?1:1e6));c=Math.max(c,a)}),u=u.concat(l),p=new Fuse(u,{shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3},{name:"namespace",weight:.1},{name:"localizedCategory",weight:.1},{name:"block",weight:.4375},{name:"jsdoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-o[e.item.qName]/c:1,n=t.qName?1-o[t.item.qName]/c:1;return e.score*(1+r/10)-t.score*(1+n/10)}})}return p.search(t.term).slice(0,7)}};e.performOperation=function(e,t){a||(i=new o,a=b.createLanguageService(i));var r=null;if(u.hasOwnProperty(e))try{r=u[e](t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r};var g="`\n. . . . .\n. . . . .\n. . # . .\n. . . . .\n. . . . .\n`";e.getSnippet=function(e,c){if(b.isFunctionLike(e)){var p=a?a.getProgram().getTypeChecker():void 0,t=e.parameters?e.parameters.filter(function(e){return!e.initializer&&!e.questionToken}).map(function(e){var t=e.type;if(!t)return"null";var r=e.name.kind===v.SK.Identifier?e.name.text:void 0;if(c&&c.paramDefl&&c.paramDefl[r]){if(t.kind==v.SK.StringKeyword){var n=c.paramDefl[r];return t.kind==v.SK.StringKeyword&&0!=n.indexOf('"')?'"'+n+'"':n}return c.paramDefl[r]}switch(t.kind){case v.SK.StringKeyword:return"leds"==r?g:'""';case v.SK.NumberKeyword:return"0";case v.SK.BooleanKeyword:return"false";case v.SK.ArrayType:return"[]";case v.SK.TypeReference:if(p){var a=p.getTypeAtLocation(e);if(a){if(a.flags&b.TypeFlags.Enum){if(a.symbol){var i=a.symbol.valueDeclaration;if(i.members.length&&i.members[0].name.kind===v.SK.Identifier)return a.symbol.name+"."+i.members[0].name.text}return"0"}if(a.flags&(b.TypeFlags.Number|b.TypeFlags.NumberLiteral))return"0"}}break;case v.SK.FunctionType:var s=t,o=p?p.getSignatureFromDeclaration(s):void 0;return o?d(o):"function () {}"}var l=p?p.getTypeAtLocation(e):void 0;if(l&&v.isObjectType(l)&&l.objectFlags&b.ObjectFlags.Anonymous){var u=p.getSignaturesOfType(l,b.SignatureKind.Call);return u.length?d(u[0]):"function () {}"}return"null"}):[];return e.name.getText()+"("+t.join(", ")+")"}function d(t){var e="",r=b.mapToDisplayParts(function(e){p.getSymbolDisplayBuilder().buildSignatureDisplay(t,e)}),n=p.getReturnTypeOfSignature(t);n.flags&b.TypeFlags.NumberLike?e="return 0;":n.flags&b.TypeFlags.StringLike?e='return "";':n.flags&(b.TypeFlags.Boolean|b.TypeFlags.BooleanLiteral)&&(e="return false;");var a=b.displayPartsToString(r);return"function "+a.substr(0,a.lastIndexOf(":"))+" {\n    "+e+"\n}"}}})((v=b.pxtc||(b.pxtc={})).service||(v.service={}))}(ts||(ts={})),function(e){var m;(function(e){var d=m.assembler.emitErr,f=d("opcode name doesn't match","<name>"),s=function(n){function e(e,t,r){return n.call(this,e,t,r,r,!1)||this}return __extends(e,n),e.prototype.emit=function(e){var t=e.words;if(t[0]!=this.name)return f;for(var r=this.opcode,n=1,a=[],i=null,s=null,o=0;o<this.args.length;++o){var l=this.args[o],u=t[n++];if("$"==l[0]){var c=this.ei.encoders[l],p=null;if(c.isImmediate){if(!u)return d("expecting number",u);if(u=u.replace(/^#/,""),null==(p=e.bin.parseOneInt(u)))return d("expecting number",u)}else m.oops();if(null==p)return d("didn't understand it",u);if(a.push(p),null==(p=c.encode(p)))return d("argument out of range or mis-aligned",u);"$i1"==l?(m.assert(0<=p&&p<=255),i=p):"$i2"==l?(i=255&p,s=p>>8&255):m.oops()}else if(l!=u)return d("expecting "+l,u)}return t[n]?d("trailing tokens",t[n]):("call"==this.name&&(r+=a[0]),{stack:0,opcode:r,opcode2:i,opcode3:s,numArgs:a,labelName:e.bin.normalizeExternalLabel(null)})},e}(m.assembler.Instruction);e.VmInstruction=s;var t=function(t){function e(e){var i=t.call(this)||this;return i.addEnc("$i1","#0-255",function(e){return i.inrange(255,e,e)}),i.addEnc("$i2","#0-65535",function(e){return i.inrange(65535,e,e)}),m.U.iterMap(e.vmOpCodes,function(e,t){var r=/(.*)_(\d+)/.exec(e),n="";"call"==r[1]?n="call $i1, $i2":"0"==r[2]?n=r[1]:"1"==r[2]?n=r[1]+" $i1":"2"==r[2]?n=r[1]+" $i2":m.oops();var a=new s(i,n,t);i.instructions.hasOwnProperty(a.name)||(i.instructions[a.name]=[]),i.instructions[a.name].push(a)}),i}return __extends(e,t),e.prototype.testAssembler=function(){},e.prototype.postProcessRelAddress=function(e,t){return t+e.baseOffset},e.prototype.postProcessAbsAddress=function(e,t){return t},e.prototype.getAddressFromLabel=function(e,t,r,n){void 0===n&&(n=!1);var a=e.lookupLabel(r);return null==a?null:t.is32bit?a:a-(e.pc()+2)},e.prototype.toFnPtr=function(e,t){return e},e.prototype.wordSize=function(){return 2},e.prototype.peephole=function(e,t,r){var n=e.getOp(),a="";if(t){var i=n+";"+(a=t.getOp()),s=this.file.peepCounts;s[i]=(s[i]||0)+1}"jmp"==n&&e.numArgs[0]==this.file.baseOffset+t.location?e.update(""):"push"!=n||"callproc"!=a&&"ldconst"!=a&&"stringlit"!=a&&"ldtmp"!=a?"push"!=n||"ldzero"!=a&&"ldone"!=a?"ldtmp"!=n||"incr"!=a&&"decr"!=a||(e.update("ldtmp_"+a+" "+e.words[1]),t.update("")):(e.update(""),t.update("push_"+a)):(e.update(""),t.update("push_"+a+" "+t.words[1]))},e}(m.assembler.AbstractProcessor);e.VmProcessor=t})((m=e.pxtc||(e.pxtc={})).vm||(m.vm={}))}(ts||(ts={}));